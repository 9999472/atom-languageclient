Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _child_process = require('child_process');

var cp = _interopRequireWildcard(_child_process);

var _languageclientV = require('./protocol/languageclient-v2');

var ls = _interopRequireWildcard(_languageclientV);

var _vscodeJsonrpc = require('vscode-jsonrpc');

var rpc = _interopRequireWildcard(_vscodeJsonrpc);

var _autocompleteBridge = require('./bridges/autocomplete-bridge');

var _autocompleteBridge2 = _interopRequireDefault(_autocompleteBridge);

var _documentSyncBridge = require('./bridges/document-sync-bridge');

var _documentSyncBridge2 = _interopRequireDefault(_documentSyncBridge);

var _formatDocumentBridge = require('./bridges/format-document-bridge');

var _formatDocumentBridge2 = _interopRequireDefault(_formatDocumentBridge);

var _formatRangeBridge = require('./bridges/format-range-bridge');

var _formatRangeBridge2 = _interopRequireDefault(_formatRangeBridge);

var _linterBridge = require('./bridges/linter-bridge');

var _linterBridge2 = _interopRequireDefault(_linterBridge);

var _nuclideOutlineViewBridge = require('./bridges/nuclide-outline-view-bridge');

var _nuclideOutlineViewBridge2 = _interopRequireDefault(_nuclideOutlineViewBridge);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

let AutoBridge = class AutoBridge {
  constructor() {
    this._disposable = new _atom.CompositeDisposable();
  }

  getName() {
    throw "Must set name field when extending AutoBridge";
  }
  getGrammarScopes() {
    throw "Must set grammarScopes field when extending AutoBridge";
  }

  activate() {
    if (atom.config.get('core.debugLSP')) this.logger = console.debug;
    this.startServer();
  }

  deactivate() {
    this._disposable.dispose();

    if (this._lc) {
      this._lc.shutdown();
    }

    if (this._process != null) {
      this._process.kill();
      this._process = null;
    };
  }

  startServer() {
    var _this = this;

    return _asyncToGenerator(function* () {
      if (_this._process != null) return;

      _this._process = yield _this.startServerProcess();

      const connection = rpc.createMessageConnection(new rpc.StreamMessageReader(_this._process.stdout), new rpc.StreamMessageWriter(_this._process.stdin), { error: function (m) {
          return _this.log('RPC Error', m);
        } });

      _this._lc = new ls.LanguageClientV2(connection, function (...m) {
        return _this.log(m);
      });
      _this._lc.onLogMessage(function (m) {
        return _this.log('Log', m);
      });
      _this._lc.onTelemetryEvent(function (e) {
        return _this.log('Telemetry', e);
      });

      const initializeResponse = yield _this._lc.initialize(_this.getInitializeParams());
      _this.bridgeCapabilities(initializeResponse.capabilities);
      _this.postInitialization(initializeResponse);
    })();
  }

  startServerProcess() {
    throw "Must override startServerProcess to start the language server process when extending AutoBridge";
  }

  bridgeCapabilities(capabilities) {
    this.linter = new _linterBridge2.default(this._lc);

    if (capabilities.completionProvider) {
      this.autoComplete = new _autocompleteBridge2.default(this._lc);
    }
    if (capabilities.textDocumentSync) {
      this.documentSync = new _documentSyncBridge2.default(this._lc, capabilities.textDocumentSync);
    }
    if (capabilities.documentSymbolProvider) {
      this.symbolProvider = new _nuclideOutlineViewBridge2.default(this._lc, this.getName());
    }

    if (capabilities.documentRangeFormattingProvider) {
      this._disposable.add(new _formatRangeBridge2.default(this._lc));
    }
    if (capabilities.documentFormattingProvider) {
      this._disposable.add(new _formatDocumentBridge2.default(this._lc));
    }
  }

  postInitialization(InitializationResult) {}

  provideOutlines() {
    return {
      name: this.getName(),
      grammarScopes: this.getGrammarScopes(),
      priority: 1,
      getOutline: this.getOutline.bind(this)
    };
  }

  getOutline(editor) {
    return this.symbolProvider != null ? this.symbolProvider.getOutline(editor) : Promise.resolve(null);
  }

  provideLinter() {
    return {
      name: this.getName(),
      grammarScopes: this.getGrammarScopes(),
      scope: 'project',
      lintOnFly: true,
      lint: this.provideLinting.bind(this)
    };
  }

  provideLinting(editor) {
    return this.linter != null ? this.linter.provideDiagnostics() : Promise.resolve([]);
  }

  provideAutocomplete() {
    return {
      selector: '.source',
      excludeLowerPriority: false,
      getSuggestions: this.provideSuggestions.bind(this)
    };
  }

  provideSuggestions(request) {
    return this.autoComplete != null ? this.autoComplete.provideSuggestions(request) : Promise.resolve([]);
  }

  getInitializeParams() {
    const rootDirs = atom.project.getDirectories();
    return {
      processId: process.pid,
      capabilities: {},
      rootPath: rootDirs.length > 0 ? rootDirs[0].path : null
    };
  }

  log(args) {
    if (this.logger == null) return;

    if (typeof args === 'string') {
      this.logger(`${this.getName()} ${args}`);
      return;
    }

    if (Array.isArray(args) && typeof args[0] === 'string') {
      if (args.length === 2) {
        this.logger(`${this.getName()} ${args[0]}`, args[1]);
        return;
      } else {
        this.logger(`${this.getName()} ${args[0]}`, args.slice(1));
        return;
      }
    }

    this.logger(`${this.getName()}`, args);
  }

  _logMessage(message) {
    if (message.type < ls.MessageType.Info) {
      this.log('Log', message);
    };
  }

  _telemetryEvent(params) {
    if (params.type != 'error' || params.message != undefined) {
      this.log('Telemetry', params);
    }
  }
};
exports.default = AutoBridge;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9hdXRvLWJyaWRnZS5qcyJdLCJuYW1lcyI6WyJjcCIsImxzIiwicnBjIiwiQXV0b0JyaWRnZSIsIl9kaXNwb3NhYmxlIiwiZ2V0TmFtZSIsImdldEdyYW1tYXJTY29wZXMiLCJhY3RpdmF0ZSIsImF0b20iLCJjb25maWciLCJnZXQiLCJsb2dnZXIiLCJjb25zb2xlIiwiZGVidWciLCJzdGFydFNlcnZlciIsImRlYWN0aXZhdGUiLCJkaXNwb3NlIiwiX2xjIiwic2h1dGRvd24iLCJfcHJvY2VzcyIsImtpbGwiLCJzdGFydFNlcnZlclByb2Nlc3MiLCJjb25uZWN0aW9uIiwiY3JlYXRlTWVzc2FnZUNvbm5lY3Rpb24iLCJTdHJlYW1NZXNzYWdlUmVhZGVyIiwic3Rkb3V0IiwiU3RyZWFtTWVzc2FnZVdyaXRlciIsInN0ZGluIiwiZXJyb3IiLCJtIiwibG9nIiwiTGFuZ3VhZ2VDbGllbnRWMiIsIm9uTG9nTWVzc2FnZSIsIm9uVGVsZW1ldHJ5RXZlbnQiLCJlIiwiaW5pdGlhbGl6ZVJlc3BvbnNlIiwiaW5pdGlhbGl6ZSIsImdldEluaXRpYWxpemVQYXJhbXMiLCJicmlkZ2VDYXBhYmlsaXRpZXMiLCJjYXBhYmlsaXRpZXMiLCJwb3N0SW5pdGlhbGl6YXRpb24iLCJsaW50ZXIiLCJjb21wbGV0aW9uUHJvdmlkZXIiLCJhdXRvQ29tcGxldGUiLCJ0ZXh0RG9jdW1lbnRTeW5jIiwiZG9jdW1lbnRTeW5jIiwiZG9jdW1lbnRTeW1ib2xQcm92aWRlciIsInN5bWJvbFByb3ZpZGVyIiwiZG9jdW1lbnRSYW5nZUZvcm1hdHRpbmdQcm92aWRlciIsImFkZCIsImRvY3VtZW50Rm9ybWF0dGluZ1Byb3ZpZGVyIiwiSW5pdGlhbGl6YXRpb25SZXN1bHQiLCJwcm92aWRlT3V0bGluZXMiLCJuYW1lIiwiZ3JhbW1hclNjb3BlcyIsInByaW9yaXR5IiwiZ2V0T3V0bGluZSIsImJpbmQiLCJlZGl0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInByb3ZpZGVMaW50ZXIiLCJzY29wZSIsImxpbnRPbkZseSIsImxpbnQiLCJwcm92aWRlTGludGluZyIsInByb3ZpZGVEaWFnbm9zdGljcyIsInByb3ZpZGVBdXRvY29tcGxldGUiLCJzZWxlY3RvciIsImV4Y2x1ZGVMb3dlclByaW9yaXR5IiwiZ2V0U3VnZ2VzdGlvbnMiLCJwcm92aWRlU3VnZ2VzdGlvbnMiLCJyZXF1ZXN0Iiwicm9vdERpcnMiLCJwcm9qZWN0IiwiZ2V0RGlyZWN0b3JpZXMiLCJwcm9jZXNzSWQiLCJwcm9jZXNzIiwicGlkIiwicm9vdFBhdGgiLCJsZW5ndGgiLCJwYXRoIiwiYXJncyIsIkFycmF5IiwiaXNBcnJheSIsInNsaWNlIiwiX2xvZ01lc3NhZ2UiLCJtZXNzYWdlIiwidHlwZSIsIk1lc3NhZ2VUeXBlIiwiSW5mbyIsIl90ZWxlbWV0cnlFdmVudCIsInBhcmFtcyIsInVuZGVmaW5lZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQTs7SUFBWUEsRTs7QUFDWjs7SUFBWUMsRTs7QUFDWjs7SUFBWUMsRzs7QUFFWjs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7Ozs7Ozs7SUFFcUJDLFUsR0FBTixNQUFNQSxVQUFOLENBQWlCO0FBQUE7QUFBQSxTQUM5QkMsV0FEOEIsR0FDaEIsK0JBRGdCO0FBQUE7O0FBVzlCQyxZQUFVO0FBQUUsVUFBTSwrQ0FBTjtBQUF1RDtBQUNuRUMscUJBQW1CO0FBQUUsVUFBTSx3REFBTjtBQUFnRTs7QUFFckZDLGFBQWlCO0FBQ2YsUUFBSUMsS0FBS0MsTUFBTCxDQUFZQyxHQUFaLENBQWdCLGVBQWhCLENBQUosRUFBc0MsS0FBS0MsTUFBTCxHQUFjQyxRQUFRQyxLQUF0QjtBQUN0QyxTQUFLQyxXQUFMO0FBQ0Q7O0FBRURDLGVBQW1CO0FBQ2pCLFNBQUtYLFdBQUwsQ0FBaUJZLE9BQWpCOztBQUVBLFFBQUksS0FBS0MsR0FBVCxFQUFjO0FBQ1osV0FBS0EsR0FBTCxDQUFTQyxRQUFUO0FBQ0Q7O0FBRUQsUUFBSSxLQUFLQyxRQUFMLElB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LFUiLCJmaWxlIjoiYXV0by1icmlkZ2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xyXG5cclxuaW1wb3J0ICogYXMgY3AgZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XHJcbmltcG9ydCAqIGFzIGxzIGZyb20gJy4vcHJvdG9jb2wvbGFuZ3VhZ2VjbGllbnQtdjInO1xyXG5pbXBvcnQgKiBhcyBycGMgZnJvbSAndnNjb2RlLWpzb25ycGMnO1xyXG5cclxuaW1wb3J0IEF1dG9jb21wbGV0ZUJyaWRnZSBmcm9tICcuL2JyaWRnZXMvYXV0b2NvbXBsZXRlLWJyaWRnZSc7XHJcbmltcG9ydCBEb2N1bWVudFN5bmNCcmlkZ2UgZnJvbSAnLi9icmlkZ2VzL2RvY3VtZW50LXN5bmMtYnJpZGdlJztcclxuaW1wb3J0IEZvcm1hdERvY3VtZW50QnJpZGdlIGZyb20gJy4vYnJpZGdlcy9mb3JtYXQtZG9jdW1lbnQtYnJpZGdlJztcclxuaW1wb3J0IEZvcm1hdFJhbmdlQnJpZGdlIGZyb20gJy4vYnJpZGdlcy9mb3JtYXQtcmFuZ2UtYnJpZGdlJztcclxuaW1wb3J0IExpbnRlckJyaWRnZSBmcm9tICcuL2JyaWRnZXMvbGludGVyLWJyaWRnZSc7XHJcbmltcG9ydCBOdWNsaWRlT3V0bGluZVZpZXdCcmlkZ2UgZnJvbSAnLi9icmlkZ2VzL251Y2xpZGUtb3V0bGluZS12aWV3LWJyaWRnZSc7XHJcblxyXG5pbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGV9IGZyb20gJ2F0b20nO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXV0b0JyaWRnZSB7XHJcbiAgX2Rpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xyXG4gIF9wcm9jZXNzOiA/Y2hpbGRfcHJvY2VzcyRDaGlsZFByb2Nlc3M7XHJcbiAgX2xjOiBscy5MYW5ndWFnZUNsaWVudFYyO1xyXG5cclxuICBhdXRvQ29tcGxldGU6ID9BdXRvY29tcGxldGVCcmlkZ2U7XHJcbiAgZG9jdW1lbnRTeW5jOiA/RG9jdW1lbnRTeW5jQnJpZGdlO1xyXG4gIGxpbnRlcjogP0xpbnRlckJyaWRnZTtcclxuICBzeW1ib2xQcm92aWRlcjogP051Y2xpZGVPdXRsaW5lVmlld0JyaWRnZTtcclxuICBsb2dnZXI6IChtOiBzdHJpbmcgfCBBcnJheTxhbnk+KSA9PiB2b2lkO1xyXG5cclxuICBnZXROYW1lKCkgeyB0aHJvdyBcIk11c3Qgc2V0IG5hbWUgZmllbGQgd2hlbiBleHRlbmRpbmcgQXV0b0JyaWRnZVwiIH07XHJcbiAgZ2V0R3JhbW1hclNjb3BlcygpIHsgdGhyb3cgXCJNdXN0IHNldCBncmFtbWFyU2NvcGVzIGZpZWxkIHdoZW4gZXh0ZW5kaW5nIEF1dG9CcmlkZ2VcIiB9O1xyXG5cclxuICBhY3RpdmF0ZSgpOiB2b2lkIHtcclxuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2NvcmUuZGVidWdMU1AnKSkgdGhpcy5sb2dnZXIgPSBjb25zb2xlLmRlYnVnO1xyXG4gICAgdGhpcy5zdGFydFNlcnZlcigpO1xyXG4gIH1cclxuXHJcbiAgZGVhY3RpdmF0ZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuX2Rpc3Bvc2FibGUuZGlzcG9zZSgpO1xyXG5cclxuICAgIGlmICh0aGlzLl9sYykge1xyXG4gICAgICB0aGlzLl9sYy5zaHV0ZG93bigpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLl9wcm9jZXNzICE9IG51bGwpIHtcclxuICAgICAgdGhpcy5fcHJvY2Vzcy5raWxsKCk7XHJcbiAgICAgIHRoaXMuX3Byb2Nlc3MgPSBudWxsO1xyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHN0YXJ0U2VydmVyKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgaWYgKHRoaXMuX3Byb2Nlc3MgIT0gbnVsbCkgcmV0dXJuO1xyXG5cclxuICAgIHRoaXMuX3Byb2Nlc3MgPSBhd2FpdCB0aGlzLnN0YXJ0U2VydmVyUHJvY2VzcygpO1xyXG5cclxuICAgIGNvbnN0IGNvbm5lY3Rpb24gPSBycGMuY3JlYXRlTWVzc2FnZUNvbm5lY3Rpb24oXHJcbiAgICAgIG5ldyBycGMuU3RyZWFtTWVzc2FnZVJlYWRlcih0aGlzLl9wcm9jZXNzLnN0ZG91dCksXHJcbiAgICAgIG5ldyBycGMuU3RyZWFtTWVzc2FnZVdyaXRlcih0aGlzLl9wcm9jZXNzLnN0ZGluKSxcclxuICAgICAgeyBlcnJvcjogKG06IE9iamVjdCkgPT4gdGhpcy5sb2coJ1JQQyBFcnJvcicsIG0pIH0pO1xyXG5cclxuICAgIHRoaXMuX2xjID0gbmV3IGxzLkxhbmd1YWdlQ2xpZW50VjIoY29ubmVjdGlvbiwgKC4uLm0pID0+IHRoaXMubG9nKG0pKTtcclxuICAgIHRoaXMuX2xjLm9uTG9nTWVzc2FnZShtID0+IHRoaXMubG9nKCdMb2cnLCBtKSk7XHJcbiAgICB0aGlzLl9sYy5vblRlbGVtZXRyeUV2ZW50KGUgPT4gdGhpcy5sb2coJ1RlbGVtZXRyeScsIGUpKTtcclxuXHJcbiAgICBjb25zdCBpbml0aWFsaXplUmVzcG9uc2UgPSBhd2FpdCB0aGlzLl9sYy5pbml0aWFsaXplKHRoaXMuZ2V0SW5pdGlhbGl6ZVBhcmFtcygpKTtcclxuICAgIHRoaXMuYnJpZGdlQ2FwYWJpbGl0aWVzKGluaXRpYWxpemVSZXNwb25zZS5jYXBhYmlsaXRpZXMpO1xyXG4gICAgdGhpcy5wb3N0SW5pdGlhbGl6YXRpb24oaW5pdGlhbGl6ZVJlc3BvbnNlKTtcclxuICB9XHJcblxyXG4gIHN0YXJ0U2VydmVyUHJvY2VzcygpOiBjaGlsZF9wcm9jZXNzJENoaWxkUHJvY2VzcyB7XHJcbiAgICB0aHJvdyBcIk11c3Qgb3ZlcnJpZGUgc3RhcnRTZXJ2ZXJQcm9jZXNzIHRvIHN0YXJ0IHRoZSBsYW5ndWFnZSBzZXJ2ZXIgcHJvY2VzcyB3aGVuIGV4dGVuZGluZyBBdXRvQnJpZGdlXCI7XHJcbiAgfVxyXG5cclxuICBicmlkZ2VDYXBhYmlsaXRpZXMoY2FwYWJpbGl0aWVzOiBscy5TZXJ2ZXJDYXBhYmlsaXRpZXMpOiB2b2lkIHtcclxuICAgIHRoaXMubGludGVyID0gbmV3IExpbnRlckJyaWRnZSh0aGlzLl9sYyk7XHJcblxyXG4gICAgaWYgKGNhcGFiaWxpdGllcy5jb21wbGV0aW9uUHJvdmlkZXIpIHtcclxuICAgICAgdGhpcy5hdXRvQ29tcGxldGUgPSBuZXcgQXV0b2NvbXBsZXRlQnJpZGdlKHRoaXMuX2xjKTtcclxuICAgIH1cclxuICAgIGlmIChjYXBhYmlsaXRpZXMudGV4dERvY3VtZW50U3luYykge1xyXG4gICAgICB0aGlzLmRvY3VtZW50U3luYyA9IG5ldyBEb2N1bWVudFN5bmNCcmlkZ2UodGhpcy5fbGMsIGNhcGFiaWxpdGllcy50ZXh0RG9jdW1lbnRTeW5jKTtcclxuICAgIH1cclxuICAgIGlmIChjYXBhYmlsaXRpZXMuZG9jdW1lbnRTeW1ib2xQcm92aWRlcikge1xyXG4gICAgICB0aGlzLnN5bWJvbFByb3ZpZGVyID0gbmV3IE51Y2xpZGVPdXRsaW5lVmlld0JyaWRnZSh0aGlzLl9sYywgdGhpcy5nZXROYW1lKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChjYXBhYmlsaXRpZXMuZG9jdW1lbnRSYW5nZUZvcm1hdHRpbmdQcm92aWRlcikge1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChuZXcgRm9ybWF0UmFuZ2VCcmlkZ2UodGhpcy5fbGMpKTtcclxuICAgIH1cclxuICAgIGlmIChjYXBhYmlsaXRpZXMuZG9jdW1lbnRGb3JtYXR0aW5nUHJvdmlkZXIpIHtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQobmV3IEZvcm1hdERvY3VtZW50QnJpZGdlKHRoaXMuX2xjKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwb3N0SW5pdGlhbGl6YXRpb24oSW5pdGlhbGl6YXRpb25SZXN1bHQ6IGxzLkluaXRpYWxpemVSZXN1bHQpOiB2b2lkIHtcclxuICB9XHJcblxyXG4gIHByb3ZpZGVPdXRsaW5lcygpOiBudWNsaWRlJE91dGxpbmVQcm92aWRlciB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBuYW1lOiB0aGlzLmdldE5hbWUoKSxcclxuICAgICAgZ3JhbW1hclNjb3BlczogdGhpcy5nZXRHcmFtbWFyU2NvcGVzKCksXHJcbiAgICAgIHByaW9yaXR5OiAxLFxyXG4gICAgICBnZXRPdXRsaW5lOiB0aGlzLmdldE91dGxpbmUuYmluZCh0aGlzKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGdldE91dGxpbmUoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpOiBQcm9taXNlPD9udWNsaWRlJE91dGxpbmU+IHtcclxuICAgIHJldHVybiB0aGlzLnN5bWJvbFByb3ZpZGVyICE9IG51bGwgPyB0aGlzLnN5bWJvbFByb3ZpZGVyLmdldE91dGxpbmUoZWRpdG9yKSA6IFByb21pc2UucmVzb2x2ZShudWxsKTtcclxuICB9XHJcblxyXG4gIHByb3ZpZGVMaW50ZXIoKTogbGludGVyJFN0YW5kYXJkTGludGVyIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG5hbWU6IHRoaXMuZ2V0TmFtZSgpLFxyXG4gICAgICBncmFtbWFyU2NvcGVzOiB0aGlzLmdldEdyYW1tYXJTY29wZXMoKSxcclxuICAgICAgc2NvcGU6ICdwcm9qZWN0JyxcclxuICAgICAgbGludE9uRmx5OiB0cnVlLFxyXG4gICAgICBsaW50OiB0aGlzLnByb3ZpZGVMaW50aW5nLmJpbmQodGhpcylcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcm92aWRlTGludGluZyhlZGl0b3I6IGF0b20kVGV4dEVkaXRvcik6ID9BcnJheTxsaW50ZXIkTWVzc2FnZT4gfCBQcm9taXNlPD9BcnJheTxsaW50ZXIkTWVzc2FnZT4+IHtcclxuICAgIHJldHVybiB0aGlzLmxpbnRlciAhPSBudWxsID8gdGhpcy5saW50ZXIucHJvdmlkZURpYWdub3N0aWNzKCkgOiBQcm9taXNlLnJlc29sdmUoW10pO1xyXG4gIH1cclxuXHJcbiAgcHJvdmlkZUF1dG9jb21wbGV0ZSgpOiBhdG9tJEF1dG9jb21wbGV0ZVByb3ZpZGVyIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHNlbGVjdG9yOiAnLnNvdXJjZScsXHJcbiAgICAgIGV4Y2x1ZGVMb3dlclByaW9yaXR5OiBmYWxzZSxcclxuICAgICAgZ2V0U3VnZ2VzdGlvbnM6IHRoaXMucHJvdmlkZVN1Z2dlc3Rpb25zLmJpbmQodGhpcylcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcm92aWRlU3VnZ2VzdGlvbnMocmVxdWVzdDogYW55KTogUHJvbWlzZTxBcnJheTxhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24+PiB7XHJcbiAgICByZXR1cm4gdGhpcy5hdXRvQ29tcGxldGUgIT0gbnVsbCA/IHRoaXMuYXV0b0NvbXBsZXRlLnByb3ZpZGVTdWdnZXN0aW9ucyhyZXF1ZXN0KSA6IFByb21pc2UucmVzb2x2ZShbXSk7XHJcbiAgfVxyXG5cclxuICBnZXRJbml0aWFsaXplUGFyYW1zKCk6IGxzLkluaXRpYWxpemVQYXJhbXMge1xyXG4gICAgY29uc3Qgcm9vdERpcnM6IEFycmF5PGFueT4gPSBhdG9tLnByb2plY3QuZ2V0RGlyZWN0b3JpZXMoKTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHByb2Nlc3NJZDogcHJvY2Vzcy5waWQsXHJcbiAgICAgIGNhcGFiaWxpdGllczogeyB9LFxyXG4gICAgICByb290UGF0aDogcm9vdERpcnMubGVuZ3RoID4gMCA/IHJvb3REaXJzWzBdLnBhdGggOiBudWxsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgbG9nKGFyZ3M6IHN0cmluZyB8IEFycmF5PGFueT4pOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmxvZ2dlciA9PSBudWxsKSByZXR1cm47XHJcblxyXG4gICAgaWYgKHR5cGVvZiBhcmdzID09PSAnc3RyaW5nJykge1xyXG4gICAgICB0aGlzLmxvZ2dlcihgJHt0aGlzLmdldE5hbWUoKX0gJHthcmdzfWApO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoYXJncykgJiYgdHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMikge1xyXG4gICAgICAgIHRoaXMubG9nZ2VyKGAke3RoaXMuZ2V0TmFtZSgpfSAke2FyZ3NbMF19YCwgYXJnc1sxXSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMubG9nZ2VyKGAke3RoaXMuZ2V0TmFtZSgpfSAke2FyZ3NbMF19YCwgYXJncy5zbGljZSgxKSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5sb2dnZXIoYCR7dGhpcy5nZXROYW1lKCl9YCwgYXJncyk7XHJcbiAgfVxyXG5cclxuICBfbG9nTWVzc2FnZShtZXNzYWdlOiBscy5Mb2dNZXNzYWdlUGFyYW1zKTogdm9pZCB7XHJcbiAgICBpZiAobWVzc2FnZS50eXBlIDwgbHMuTWVzc2FnZVR5cGUuSW5mbykge1xyXG4gICAgICB0aGlzLmxvZygnTG9nJywgbWVzc2FnZSk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgX3RlbGVtZXRyeUV2ZW50KHBhcmFtczogYW55KTogdm9pZCB7XHJcbiAgICBpZiAocGFyYW1zLnR5cGUgIT0gJ2Vycm9yJyB8fCBwYXJhbXMubWVzc2FnZSAhPSB1bmRlZmluZWQpIHtcclxuICAgICAgdGhpcy5sb2coJ1RlbGVtZXRyeScsIHBhcmFtcyk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==