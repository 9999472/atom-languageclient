Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _child_process = require('child_process');

var cp = _interopRequireWildcard(_child_process);

var _languageclientV = require('./protocol/languageclient-v2');

var ls = _interopRequireWildcard(_languageclientV);

var _vscodeJsonrpc = require('vscode-jsonrpc');

var rpc = _interopRequireWildcard(_vscodeJsonrpc);

var _autocompleteBridge = require('./bridges/autocomplete-bridge');

var _autocompleteBridge2 = _interopRequireDefault(_autocompleteBridge);

var _documentSyncBridge = require('./bridges/document-sync-bridge');

var _documentSyncBridge2 = _interopRequireDefault(_documentSyncBridge);

var _formatDocumentBridge = require('./bridges/format-document-bridge');

var _formatDocumentBridge2 = _interopRequireDefault(_formatDocumentBridge);

var _formatRangeBridge = require('./bridges/format-range-bridge');

var _formatRangeBridge2 = _interopRequireDefault(_formatRangeBridge);

var _linterBridge = require('./bridges/linter-bridge');

var _linterBridge2 = _interopRequireDefault(_linterBridge);

var _nuclideOutlineViewBridge = require('./bridges/nuclide-outline-view-bridge');

var _nuclideOutlineViewBridge2 = _interopRequireDefault(_nuclideOutlineViewBridge);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

let AutoBridge = class AutoBridge {
  constructor() {
    this._disposable = new _atom.CompositeDisposable();
  }

  getName() {
    throw "Must set name field when extending AutoBridge";
  }
  getGrammarScopes() {
    throw "Must set grammarScopes field when extending AutoBridge";
  }

  activate() {
    if (atom.config.get('core.debugLSP')) this.logger = console.debug;
    this.startServer();
  }

  deactivate() {
    this._disposable.dispose();

    if (this._lc) {
      this._lc.shutdown();
    }

    if (this._process != null) {
      this._process.kill();
      this._process = null;
    };
  }

  startServer() {
    var _this = this;

    return _asyncToGenerator(function* () {
      if (_this._process != null) return;

      _this._process = yield _this.startServerProcess();

      const connection = rpc.createMessageConnection(new rpc.StreamMessageReader(_this._process.stdout), new rpc.StreamMessageWriter(_this._process.stdin), { error: function (m) {
          return _this.log('RPC Error', m);
        } });

      _this._lc = new ls.LanguageClientV2(connection, function (...m) {
        return _this.log(m);
      });
      _this._lc.onLogMessage(function (m) {
        return _this.log('Log', m);
      });

      const initializeResponse = yield _this._lc.initialize(_this.getInitializeParams());
      _this.bridgeCapabilities(initializeResponse.capabilities);
      _this.postInitialization(initializeResponse);
    })();
  }

  startServerProcess() {
    throw "Must override startServerProcess to start the language server process when extending AutoBridge";
  }

  bridgeCapabilities(capabilities) {
    this.linter = new _linterBridge2.default(this._lc);

    if (capabilities.completionProvider) {
      this.autoComplete = new _autocompleteBridge2.default(this._lc);
    }
    if (capabilities.textDocumentSync) {
      this.documentSync = new _documentSyncBridge2.default(this._lc, capabilities.textDocumentSync);
    }
    if (capabilities.documentSymbolProvider) {
      this.symbolProvider = new _nuclideOutlineViewBridge2.default(this._lc, this.getName());
    }

    if (capabilities.documentRangeFormattingProvider) {
      this._disposable.add(new _formatRangeBridge2.default(this._lc));
    }
    if (capabilities.documentFormattingProvider) {
      this._disposable.add(new _formatDocumentBridge2.default(this._lc));
    }
  }

  postInitialization(InitializationResult) {}

  provideOutlines() {
    return {
      name: this.getName(),
      grammarScopes: this.getGrammarScopes(),
      priority: 1,
      getOutline: this.getOutline.bind(this)
    };
  }

  getOutline(editor) {
    return this.symbolProvider != null ? this.symbolProvider.getOutline(editor) : Promise.resolve(null);
  }

  provideLinter() {
    return {
      name: this.getName(),
      grammarScopes: this.getGrammarScopes(),
      scope: 'project',
      lintOnFly: true,
      lint: this.provideLinting.bind(this)
    };
  }

  provideLinting(editor) {
    return this.linter != null ? this.linter.provideDiagnostics() : Promise.resolve([]);
  }

  provideAutocomplete() {
    return {
      selector: '.source',
      excludeLowerPriority: false,
      getSuggestions: this.provideSuggestions.bind(this)
    };
  }

  provideSuggestions(request) {
    return this.autoComplete != null ? this.autoComplete.provideSuggestions(request) : Promise.resolve([]);
  }

  getInitializeParams() {
    const rootDirs = atom.project.getDirectories();
    return {
      processId: process.pid,
      capabilities: {},
      rootPath: rootDirs.length > 0 ? rootDirs[0].path : null
    };
  }

  log(args) {
    if (this.logger == null) return;

    if (typeof args === 'string') {
      this.logger(`${this.getName()} ${args}`);
      return;
    }

    if (Array.isArray(args) && typeof args[0] === 'string') {
      if (args.length === 2) {
        this.logger(`${this.getName()} ${args[0]}`, args[1]);
        return;
      } else {
        this.logger(`${this.getName()} ${args[0]}`, args.slice(1));
        return;
      }
    }

    this.logger(`${this.getName()}`, args);
  }

  _logMessage(message) {
    if (message.type < ls.MessageType.Info) {
      this.log('Log', message);
    };
  }
};
exports.default = AutoBridge;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9hdXRvLWJyaWRnZS5qcyJdLCJuYW1lcyI6WyJjcCIsImxzIiwicnBjIiwiQXV0b0JyaWRnZSIsIl9kaXNwb3NhYmxlIiwiZ2V0TmFtZSIsImdldEdyYW1tYXJTY29wZXMiLCJhY3RpdmF0ZSIsImF0b20iLCJjb25maWciLCJnZXQiLCJsb2dnZXIiLCJjb25zb2xlIiwiZGVidWciLCJzdGFydFNlcnZlciIsImRlYWN0aXZhdGUiLCJkaXNwb3NlIiwiX2xjIiwic2h1dGRvd24iLCJfcHJvY2VzcyIsImtpbGwiLCJzdGFydFNlcnZlclByb2Nlc3MiLCJjb25uZWN0aW9uIiwiY3JlYXRlTWVzc2FnZUNvbm5lY3Rpb24iLCJTdHJlYW1NZXNzYWdlUmVhZGVyIiwic3Rkb3V0IiwiU3RyZWFtTWVzc2FnZVdyaXRlciIsInN0ZGluIiwiZXJyb3IiLCJtIiwibG9nIiwiTGFuZ3VhZ2VDbGllbnRWMiIsIm9uTG9nTWVzc2FnZSIsImluaXRpYWxpemVSZXNwb25zZSIsImluaXRpYWxpemUiLCJnZXRJbml0aWFsaXplUGFyYW1zIiwiYnJpZGdlQ2FwYWJpbGl0aWVzIiwiY2FwYWJpbGl0aWVzIiwicG9zdEluaXRpYWxpemF0aW9uIiwibGludGVyIiwiY29tcGxldGlvblByb3ZpZGVyIiwiYXV0b0NvbXBsZXRlIiwidGV4dERvY3VtZW50U3luYyIsImRvY3VtZW50U3luYyIsImRvY3VtZW50U3ltYm9sUHJvdmlkZXIiLCJzeW1ib2xQcm92aWRlciIsImRvY3VtZW50UmFuZ2VGb3JtYXR0aW5nUHJvdmlkZXIiLCJhZGQiLCJkb2N1bWVudEZvcm1hdHRpbmdQcm92aWRlciIsIkluaXRpYWxpemF0aW9uUmVzdWx0IiwicHJvdmlkZU91dGxpbmVzIiwibmFtZSIsImdyYW1tYXJTY29wZXMiLCJwcmlvcml0eSIsImdldE91dGxpbmUiLCJiaW5kIiwiZWRpdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJwcm92aWRlTGludGVyIiwic2NvcGUiLCJsaW50T25GbHkiLCJsaW50IiwicHJvdmlkZUxpbnRpbmciLCJwcm92aWRlRGlhZ25vc3RpY3MiLCJwcm92aWRlQXV0b2NvbXBsZXRlIiwic2VsZWN0b3IiLCJleGNsdWRlTG93ZXJQcmlvcml0eSIsImdldFN1Z2dlc3Rpb25zIiwicHJvdmlkZVN1Z2dlc3Rpb25zIiwicmVxdWVzdCIsInJvb3REaXJzIiwicHJvamVjdCIsImdldERpcmVjdG9yaWVzIiwicHJvY2Vzc0lkIiwicHJvY2VzcyIsInBpZCIsInJvb3RQYXRoIiwibGVuZ3RoIiwicGF0aCIsImFyZ3MiLCJBcnJheSIsImlzQXJyYXkiLCJzbGljZSIsIl9sb2dNZXNzYWdlIiwibWVzc2FnZSIsInR5cGUiLCJNZXNzYWdlVHlwZSIsIkluZm8iXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7O0lBQVlBLEU7O0FBQ1o7O0lBQVlDLEU7O0FBQ1o7O0lBQVlDLEc7O0FBRVo7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7Ozs7Ozs7O0lBRXFCQyxVLEdBQU4sTUFBTUEsVUFBTixDQUFpQjtBQUFBO0FBQUEsU0FDOUJDLFdBRDhCLEdBQ2hCLCtCQURnQjtBQUFBOztBQVc5QkMsWUFBVTtBQUFFLFVBQU0sK0NBQU47QUFBdUQ7QUFDbkVDLHFCQUFtQjtBQUFFLFVBQU0sd0RBQU47QUFBZ0U7O0FBRXJGQyxhQUFpQjtBQUNmLFFBQUlDLEtBQUtDLE1BQUwsQ0FBWUMsR0FBWixDQUFnQixlQUFoQixDQUFKLEVBQXNDLEtBQUtDLE1BQUwsR0FBY0MsUUFBUUMsS0FBdEI7QUFDdEMsU0FBS0MsV0FBTDtBQUNEOztBQUVEQyxlQUFtQjtBQUNqQixTQUFLWCxXQUFMLENBQWlCWSxPQUFqQjs7QUFFQSxRQUFJLEtBQUtDLEdBQVQsRUFBYztBQUNaLFdBQUtBLEdBQUwsQ0FBU0MsUUFBVDtBQUNEOztBQUVELFFBQUksS0FBS0MsUUFBTCxJQUFpQixJQUFyQixFQUEyQjtBQUN6QixXQUFLQSxRQUFMLENBQWNDLElBQWQ7QUFDQSxXQUFLRCxRQUFMLEdB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RUFBdEM7QUFDQTtBQUNEOztBQUVELFFBQUlDLE1BQU1DLE9BQU4sQ0FBY0YsSUFBZCxLQUF1QixPQUFPQSxLQUFLLENBQUwsQ0FBUCxLQUFtQixRQUE5QyxFQUF3RDtBQUN0RCxVQUFJQSxLQUFLRixNQUFMLEtBQWdCLENBQXBCLEVBQXVCO0FBQ3JCLGFBQUtuRSxNQUFMLENBQWEsR0FBRSxLQUFLTixPQUFMLEVBQWUsSUFBRzJFLEtBQUssQ0FBTCxDQUFRLEVBQXpDLEVBQTRDQSxLQUFLLENBQUwsQ0FBNUM7QUFDQTtBQUNELE9BSEQsTUFHTztBQUNMLGFBQUtyRSxNQUFMLENBQWEsR0FBRSxLQUFLTixPQUFMLEVBQWUsSUFBRzJFLEtBQUssQ0FBTCxDQUFRLEVBQXpDLEVBQTRDQSxLQUFLRyxLQUFMLENBQVcsQ0FBWCxDQUE1QztBQUNBO0FBQ0Q7QUFDRjs7QUFFRCxTQUFLeEUsTUFBTCxDQUFhLEdBQUUsS0FBS04sT0FBTCxFQUFlLEVBQTlCLEVBQWlDMkUsSUFBakM7QUFDRDs7QUFFREksY0FBWUMsT0FBWixFQUFnRDtBQUM5QyxRQUFJQSxRQUFRQyxJQUFSLEdBQWVyRixHQUFHc0YsV0FBSCxDQUFlQyxJQUFsQyxFQUF3QztBQUN0QyxXQUFLMUQsR0FBTCxDQUFTLEtBQVQsRUFBZ0J1RCxPQUFoQjtBQUNEO0FBQ0Y7QUF2SjZCLEM7a0JBQVhsRixVIiwiZmlsZSI6ImF1dG8tYnJpZGdlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcclxuXHJcbmltcG9ydCAqIGFzIGNwIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xyXG5pbXBvcnQgKiBhcyBscyBmcm9tICcuL3Byb3RvY29sL2xhbmd1YWdlY2xpZW50LXYyJztcclxuaW1wb3J0ICogYXMgcnBjIGZyb20gJ3ZzY29kZS1qc29ucnBjJztcclxuXHJcbmltcG9ydCBBdXRvY29tcGxldGVCcmlkZ2UgZnJvbSAnLi9icmlkZ2VzL2F1dG9jb21wbGV0ZS1icmlkZ2UnO1xyXG5pbXBvcnQgRG9jdW1lbnRTeW5jQnJpZGdlIGZyb20gJy4vYnJpZGdlcy9kb2N1bWVudC1zeW5jLWJyaWRnZSc7XHJcbmltcG9ydCBGb3JtYXREb2N1bWVudEJyaWRnZSBmcm9tICcuL2JyaWRnZXMvZm9ybWF0LWRvY3VtZW50LWJyaWRnZSc7XHJcbmltcG9ydCBGb3JtYXRSYW5nZUJyaWRnZSBmcm9tICcuL2JyaWRnZXMvZm9ybWF0LXJhbmdlLWJyaWRnZSc7XHJcbmltcG9ydCBMaW50ZXJCcmlkZ2UgZnJvbSAnLi9icmlkZ2VzL2xpbnRlci1icmlkZ2UnO1xyXG5pbXBvcnQgTnVjbGlkZU91dGxpbmVWaWV3QnJpZGdlIGZyb20gJy4vYnJpZGdlcy9udWNsaWRlLW91dGxpbmUtdmlldy1icmlkZ2UnO1xyXG5cclxuaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tICdhdG9tJztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEF1dG9CcmlkZ2Uge1xyXG4gIF9kaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcclxuICBfcHJvY2VzczogP2NoaWxkX3Byb2Nlc3MkQ2hpbGRQcm9jZXNzO1xyXG4gIF9sYzogbHMuTGFuZ3VhZ2VDbGllbnRWMjtcclxuXHJcbiAgYXV0b0NvbXBsZXRlOiA/QXV0b2NvbXBsZXRlQnJpZGdlO1xyXG4gIGRvY3VtZW50U3luYzogP0RvY3VtZW50U3luY0JyaWRnZTtcclxuICBsaW50ZXI6ID9MaW50ZXJCcmlkZ2U7XHJcbiAgc3ltYm9sUHJvdmlkZXI6ID9OdWNsaWRlT3V0bGluZVZpZXdCcmlkZ2U7XHJcbiAgbG9nZ2VyOiAobTogc3RyaW5nIHwgQXJyYXk8YW55PikgPT4gdm9pZDtcclxuXHJcbiAgZ2V0TmFtZSgpIHsgdGhyb3cgXCJNdXN0IHNldCBuYW1lIGZpZWxkIHdoZW4gZXh0ZW5kaW5nIEF1dG9CcmlkZ2VcIiB9O1xyXG4gIGdldEdyYW1tYXJTY29wZXMoKSB7IHRocm93IFwiTXVzdCBzZXQgZ3JhbW1hclNjb3BlcyBmaWVsZCB3aGVuIGV4dGVuZGluZyBBdXRvQnJpZGdlXCIgfTtcclxuXHJcbiAgYWN0aXZhdGUoKTogdm9pZCB7XHJcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdjb3JlLmRlYnVnTFNQJykpIHRoaXMubG9nZ2VyID0gY29uc29sZS5kZWJ1ZztcclxuICAgIHRoaXMuc3RhcnRTZXJ2ZXIoKTtcclxuICB9XHJcblxyXG4gIGRlYWN0aXZhdGUoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcclxuXHJcbiAgICBpZiAodGhpcy5fbGMpIHtcclxuICAgICAgdGhpcy5fbGMuc2h1dGRvd24oKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5fcHJvY2VzcyAhPSBudWxsKSB7XHJcbiAgICAgIHRoaXMuX3Byb2Nlc3Mua2lsbCgpO1xyXG4gICAgICB0aGlzLl9wcm9jZXNzID0gbnVsbDtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBhc3luYyBzdGFydFNlcnZlcigpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGlmICh0aGlzLl9wcm9jZXNzICE9IG51bGwpIHJldHVybjtcclxuXHJcbiAgICB0aGlzLl9wcm9jZXNzID0gYXdhaXQgdGhpcy5zdGFydFNlcnZlclByb2Nlc3MoKTtcclxuXHJcbiAgICBjb25zdCBjb25uZWN0aW9uID0gcnBjLmNyZWF0ZU1lc3NhZ2VDb25uZWN0aW9uKFxyXG4gICAgICBuZXcgcnBjLlN0cmVhbU1lc3NhZ2VSZWFkZXIodGhpcy5fcHJvY2Vzcy5zdGRvdXQpLFxyXG4gICAgICBuZXcgcnBjLlN0cmVhbU1lc3NhZ2VXcml0ZXIodGhpcy5fcHJvY2Vzcy5zdGRpbiksXHJcbiAgICAgIHsgZXJyb3I6IChtOiBPYmplY3QpID0+IHRoaXMubG9nKCdSUEMgRXJyb3InLCBtKSB9KTtcclxuXHJcbiAgICB0aGlzLl9sYyA9IG5ldyBscy5MYW5ndWFnZUNsaWVudFYyKGNvbm5lY3Rpb24sICguLi5tKSA9PiB0aGlzLmxvZyhtKSk7XHJcbiAgICB0aGlzLl9sYy5vbkxvZ01lc3NhZ2UobSA9PiB0aGlzLmxvZygnTG9nJywgbSkpO1xyXG5cclxuICAgIGNvbnN0IGluaXRpYWxpemVSZXNwb25zZSA9IGF3YWl0IHRoaXMuX2xjLmluaXRpYWxpemUodGhpcy5nZXRJbml0aWFsaXplUGFyYW1zKCkpO1xyXG4gICAgdGhpcy5icmlkZ2VDYXBhYmlsaXRpZXMoaW5pdGlhbGl6ZVJlc3BvbnNlLmNhcGFiaWxpdGllcyk7XHJcbiAgICB0aGlzLnBvc3RJbml0aWFsaXphdGlvbihpbml0aWFsaXplUmVzcG9uc2UpO1xyXG4gIH1cclxuXHJcbiAgc3RhcnRTZXJ2ZXJQcm9jZXNzKCk6IGNoaWxkX3Byb2Nlc3MkQ2hpbGRQcm9jZXNzIHtcclxuICAgIHRocm93IFwiTXVzdCBvdmVycmlkZSBzdGFydFNlcnZlclByb2Nlc3MgdG8gc3RhcnQgdGhlIGxhbmd1YWdlIHNlcnZlciBwcm9jZXNzIHdoZW4gZXh0ZW5kaW5nIEF1dG9CcmlkZ2VcIjtcclxuICB9XHJcblxyXG4gIGJyaWRnZUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXM6IGxzLlNlcnZlckNhcGFiaWxpdGllcyk6IHZvaWQge1xyXG4gICAgdGhpcy5saW50ZXIgPSBuZXcgTGludGVyQnJpZGdlKHRoaXMuX2xjKTtcclxuXHJcbiAgICBpZiAoY2FwYWJpbGl0aWVzLmNvbXBsZXRpb25Qcm92aWRlcikge1xyXG4gICAgICB0aGlzLmF1dG9Db21wbGV0ZSA9IG5ldyBBdXRvY29tcGxldGVCcmlkZ2UodGhpcy5fbGMpO1xyXG4gICAgfVxyXG4gICAgaWYgKGNhcGFiaWxpdGllcy50ZXh0RG9jdW1lbnRTeW5jKSB7XHJcbiAgICAgIHRoaXMuZG9jdW1lbnRTeW5jID0gbmV3IERvY3VtZW50U3luY0JyaWRnZSh0aGlzLl9sYywgY2FwYWJpbGl0aWVzLnRleHREb2N1bWVudFN5bmMpO1xyXG4gICAgfVxyXG4gICAgaWYgKGNhcGFiaWxpdGllcy5kb2N1bWVudFN5bWJvbFByb3ZpZGVyKSB7XHJcbiAgICAgIHRoaXMuc3ltYm9sUHJvdmlkZXIgPSBuZXcgTnVjbGlkZU91dGxpbmVWaWV3QnJpZGdlKHRoaXMuX2xjLCB0aGlzLmdldE5hbWUoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGNhcGFiaWxpdGllcy5kb2N1bWVudFJhbmdlRm9ybWF0dGluZ1Byb3ZpZGVyKSB7XHJcbiAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKG5ldyBGb3JtYXRSYW5nZUJyaWRnZSh0aGlzLl9sYykpO1xyXG4gICAgfVxyXG4gICAgaWYgKGNhcGFiaWxpdGllcy5kb2N1bWVudEZvcm1hdHRpbmdQcm92aWRlcikge1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChuZXcgRm9ybWF0RG9jdW1lbnRCcmlkZ2UodGhpcy5fbGMpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHBvc3RJbml0aWFsaXphdGlvbihJbml0aWFsaXphdGlvblJlc3VsdDogbHMuSW5pdGlhbGl6ZVJlc3VsdCk6IHZvaWQge1xyXG4gIH1cclxuXHJcbiAgcHJvdmlkZU91dGxpbmVzKCk6IG51Y2xpZGUkT3V0bGluZVByb3ZpZGVyIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG5hbWU6IHRoaXMuZ2V0TmFtZSgpLFxyXG4gICAgICBncmFtbWFyU2NvcGVzOiB0aGlzLmdldEdyYW1tYXJTY29wZXMoKSxcclxuICAgICAgcHJpb3JpdHk6IDEsXHJcbiAgICAgIGdldE91dGxpbmU6IHRoaXMuZ2V0T3V0bGluZS5iaW5kKHRoaXMpXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgZ2V0T3V0bGluZShlZGl0b3I6IGF0b20kVGV4dEVkaXRvcik6IFByb21pc2U8P251Y2xpZGUkT3V0bGluZT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuc3ltYm9sUHJvdmlkZXIgIT0gbnVsbCA/IHRoaXMuc3ltYm9sUHJvdmlkZXIuZ2V0T3V0bGluZShlZGl0b3IpIDogUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xyXG4gIH1cclxuXHJcbiAgcHJvdmlkZUxpbnRlcigpOiBsaW50ZXIkU3RhbmRhcmRMaW50ZXIge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgbmFtZTogdGhpcy5nZXROYW1lKCksXHJcbiAgICAgIGdyYW1tYXJTY29wZXM6IHRoaXMuZ2V0R3JhbW1hclNjb3BlcygpLFxyXG4gICAgICBzY29wZTogJ3Byb2plY3QnLFxyXG4gICAgICBsaW50T25GbHk6IHRydWUsXHJcbiAgICAgIGxpbnQ6IHRoaXMucHJvdmlkZUxpbnRpbmcuYmluZCh0aGlzKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHByb3ZpZGVMaW50aW5nKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKTogP0FycmF5PGxpbnRlciRNZXNzYWdlPiB8IFByb21pc2U8P0FycmF5PGxpbnRlciRNZXNzYWdlPj4ge1xyXG4gICAgcmV0dXJuIHRoaXMubGludGVyICE9IG51bGwgPyB0aGlzLmxpbnRlci5wcm92aWRlRGlhZ25vc3RpY3MoKSA6IFByb21pc2UucmVzb2x2ZShbXSk7XHJcbiAgfVxyXG5cclxuICBwcm92aWRlQXV0b2NvbXBsZXRlKCk6IGF0b20kQXV0b2NvbXBsZXRlUHJvdmlkZXIge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc2VsZWN0b3I6ICcuc291cmNlJyxcclxuICAgICAgZXhjbHVkZUxvd2VyUHJpb3JpdHk6IGZhbHNlLFxyXG4gICAgICBnZXRTdWdnZXN0aW9uczogdGhpcy5wcm92aWRlU3VnZ2VzdGlvbnMuYmluZCh0aGlzKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHByb3ZpZGVTdWdnZXN0aW9ucyhyZXF1ZXN0OiBhbnkpOiBQcm9taXNlPEFycmF5PGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbj4+IHtcclxuICAgIHJldHVybiB0aGlzLmF1dG9Db21wbGV0ZSAhPSBudWxsID8gdGhpcy5hdXRvQ29tcGxldGUucHJvdmlkZVN1Z2dlc3Rpb25zKHJlcXVlc3QpIDogUHJvbWlzZS5yZXNvbHZlKFtdKTtcclxuICB9XHJcblxyXG4gIGdldEluaXRpYWxpemVQYXJhbXMoKTogbHMuSW5pdGlhbGl6ZVBhcmFtcyB7XHJcbiAgICBjb25zdCByb290RGlyczogQXJyYXk8YW55PiA9IGF0b20ucHJvamVjdC5nZXREaXJlY3RvcmllcygpO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgcHJvY2Vzc0lkOiBwcm9jZXNzLnBpZCxcclxuICAgICAgY2FwYWJpbGl0aWVzOiB7IH0sXHJcbiAgICAgIHJvb3RQYXRoOiByb290RGlycy5sZW5ndGggPiAwID8gcm9vdERpcnNbMF0ucGF0aCA6IG51bGxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBsb2coYXJnczogc3RyaW5nIHwgQXJyYXk8YW55Pik6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMubG9nZ2VyID09IG51bGwpIHJldHVybjtcclxuXHJcbiAgICBpZiAodHlwZW9mIGFyZ3MgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIHRoaXMubG9nZ2VyKGAke3RoaXMuZ2V0TmFtZSgpfSAke2FyZ3N9YCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheShhcmdzKSAmJiB0eXBlb2YgYXJnc1swXSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgdGhpcy5sb2dnZXIoYCR7dGhpcy5nZXROYW1lKCl9ICR7YXJnc1swXX1gLCBhcmdzWzFdKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5sb2dnZXIoYCR7dGhpcy5nZXROYW1lKCl9ICR7YXJnc1swXX1gLCBhcmdzLnNsaWNlKDEpKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmxvZ2dlcihgJHt0aGlzLmdldE5hbWUoKX1gLCBhcmdzKTtcclxuICB9XHJcblxyXG4gIF9sb2dNZXNzYWdlKG1lc3NhZ2U6IGxzLkxvZ01lc3NhZ2VQYXJhbXMpOiB2b2lkIHtcclxuICAgIGlmIChtZXNzYWdlLnR5cGUgPCBscy5NZXNzYWdlVHlwZS5JbmZvKSB7XHJcbiAgICAgIHRoaXMubG9nKCdMb2cnLCBtZXNzYWdlKTtcclxuICAgIH07XHJcbiAgfVxyXG59XHJcbiJdfQ==