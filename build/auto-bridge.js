Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _child_process = require('child_process');

var cp = _interopRequireWildcard(_child_process);

var _languageclientV = require('./protocol/languageclient-v2');

var ls = _interopRequireWildcard(_languageclientV);

var _vscodeJsonrpc = require('vscode-jsonrpc');

var rpc = _interopRequireWildcard(_vscodeJsonrpc);

var _autocompleteBridge = require('./bridges/autocomplete-bridge');

var _autocompleteBridge2 = _interopRequireDefault(_autocompleteBridge);

var _documentSyncBridge = require('./bridges/document-sync-bridge');

var _documentSyncBridge2 = _interopRequireDefault(_documentSyncBridge);

var _formatDocumentBridge = require('./bridges/format-document-bridge');

var _formatDocumentBridge2 = _interopRequireDefault(_formatDocumentBridge);

var _formatRangeBridge = require('./bridges/format-range-bridge');

var _formatRangeBridge2 = _interopRequireDefault(_formatRangeBridge);

var _linterBridge = require('./bridges/linter-bridge');

var _linterBridge2 = _interopRequireDefault(_linterBridge);

var _messageNotificationsBridge = require('./bridges/message-notifications-bridge');

var _messageNotificationsBridge2 = _interopRequireDefault(_messageNotificationsBridge);

var _nuclideDefinitionBridge = require('./bridges/nuclide-definition-bridge');

var _nuclideDefinitionBridge2 = _interopRequireDefault(_nuclideDefinitionBridge);

var _nuclideHyperclickBridge = require('./bridges/nuclide-hyperclick-bridge');

var _nuclideHyperclickBridge2 = _interopRequireDefault(_nuclideHyperclickBridge);

var _nuclideOutlineViewBridge = require('./bridges/nuclide-outline-view-bridge');

var _nuclideOutlineViewBridge2 = _interopRequireDefault(_nuclideOutlineViewBridge);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

let AutoBridge = class AutoBridge {
  constructor() {
    this._disposable = new _atom.CompositeDisposable();
  }

  getName() {
    throw "Must set name field when extending AutoBridge";
  }
  getGrammarScopes() {
    throw "Must set grammarScopes field when extending AutoBridge";
  }

  activate() {
    if (atom.config.get('core.debugLSP')) this.logger = console.debug;
    this.startServer();
  }

  deactivate() {
    this._disposable.dispose();

    if (this._lc) {
      this._lc.shutdown();
    }

    if (this._process != null) {
      this._process.kill();
      this._process = null;
    };
  }

  startServer() {
    var _this = this;

    return _asyncToGenerator(function* () {
      if (_this._process != null) return;

      _this._process = yield _this.startServerProcess();

      const connection = rpc.createMessageConnection(new rpc.StreamMessageReader(_this._process.stdout), new rpc.StreamMessageWriter(_this._process.stdin), { error: function (m) {
          _this.log(m);
        } });

      _this._lc = new ls.LanguageClientV2(connection, function (...m) {
        return _this.log(m);
      });
      _this._lc.onLogMessage(function (m) {
        return _this.log(['Log', m]);
      });

      const initializeResponse = yield _this._lc.initialize(_this.getInitializeParams());
      _this.bridgeCapabilities(initializeResponse.capabilities);
      _this.postInitialization(initializeResponse);
    })();
  }

  startServerProcess() {
    throw "Must override startServerProcess to start the language server process when extending AutoBridge";
  }

  bridgeCapabilities(capabilities) {
    this.linter = new _linterBridge2.default(this._lc);
    if (capabilities.completionProvider) {
      this.autoComplete = new _autocompleteBridge2.default(this._lc);
    }
    if (capabilities.documentSymbolProvider) {
      this.outline = new _nuclideOutlineViewBridge2.default(this._lc, this.getName());
    }
    if (capabilities.definitionProvider) {
      this.definitions = new _nuclideDefinitionBridge2.default(this._lc);
      this.hyperclick = new _nuclideHyperclickBridge2.default(this._lc);
    }

    this._disposable.add(new _messageNotificationsBridge2.default(this._lc, this.getName()));
    if (capabilities.textDocumentSync) {
      this._disposable.add(new _documentSyncBridge2.default(this._lc, capabilities.textDocumentSync));
    }
    if (capabilities.documentRangeFormattingProvider) {
      this._disposable.add(new _formatRangeBridge2.default(this._lc));
    }
    if (capabilities.documentFormattingProvider) {
      this._disposable.add(new _formatDocumentBridge2.default(this._lc));
    }
  }

  postInitialization(InitializationResult) {}

  provideOutlines() {
    return {
      name: this.getName(),
      grammarScopes: this.getGrammarScopes(),
      priority: 1,
      getOutline: this.getOutline.bind(this)
    };
  }

  getOutline(editor) {
    return this.outline != null ? this.outline.getOutline(editor) : Promise.resolve(null);
  }

  provideLinter() {
    return {
      name: this.getName(),
      grammarScopes: this.getGrammarScopes(),
      scope: 'project',
      lintOnFly: true,
      lint: this.provideLinting.bind(this)
    };
  }

  provideLinting(editor) {
    return this.linter != null ? this.linter.provideDiagnostics() : Promise.resolve([]);
  }

  provideAutocomplete() {
    return {
      selector: '.source',
      excludeLowerPriority: false,
      getSuggestions: this.provideSuggestions.bind(this)
    };
  }

  provideSuggestions(request) {
    return this.autoComplete != null ? this.autoComplete.provideSuggestions(request) : Promise.resolve([]);
  }

  provideDefinitions() {
    return {
      name: this.getName(),
      priority: 20,
      grammarScopes: this.getGrammarScopes(),
      getDefinition: this.getDefinition.bind(this),
      getDefinitionById: this.getDefinitionById.bind(this)
    };
  }

  getDefinition(editor, point) {
    return this.definitions != null ? this.definitions.getDefinition(editor, point) : Promise.resolve(null);
  }

  getDefinitionById(filename, id) {
    return Promise.resolve(null);
  }

  provideHyperclick() {
    return {
      priority: 20,
      providerName: this.getName(),
      getSuggestion: this.getHyperclickSuggestion.bind(this)
    };
  }

  getHyperclickSuggestion(editor, point) {
    return this.hyperclick != null ? this.hyperclick.getSuggestion(editor, point) : Promise.resolve(null);
  }

  getInitializeParams() {
    const rootDirs = atom.project.getDirectories();
    return {
      processId: process.pid,
      capabilities: {},
      rootPath: rootDirs.length > 0 ? rootDirs[0].path : null
    };
  }

  log(args) {
    if (this.logger == null) return;

    if (typeof args === 'string') {
      this.logger(`${this.getName()} ${args}`);
      return;
    }

    if (Array.isArray(args) && typeof args[0] === 'string') {
      if (args.length === 2) {
        this.logger(`${this.getName()} ${args[0]}`, args[1]);
        return;
      } else {
        this.logger(`${this.getName()} ${args[0]}`, args.slice(1));
        return;
      }
    }

    this.logger(`${this.getName()}`, args);
  }
};
exports.default = AutoBridge;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9hdXRvLWJyaWRnZS5qcyJdLCJuYW1lcyI6WyJjcCIsImxzIiwicnBjIiwiQXV0b0JyaWRnZSIsIl9kaXNwb3NhYmxlIiwiZ2V0TmFtZSIsImdldEdyYW1tYXJTY29wZXMiLCJhY3RpdmF0ZSIsImF0b20iLCJjb25maWciLCJnZXQiLCJsb2dnZXIiLCJjb25zb2xlIiwiZGVidWciLCJzdGFydFNlcnZlciIsImRlYWN0aXZhdGUiLCJkaXNwb3NlIiwiX2xjIiwic2h1dGRvd24iLCJfcHJvY2VzcyIsImtpbGwiLCJzdGFydFNlcnZlclByb2Nlc3MiLCJjb25uZWN0aW9uIiwiY3JlYXRlTWVzc2FnZUNvbm5lY3Rpb24iLCJTdHJlYW1NZXNzYWdlUmVhZGVyIiwic3Rkb3V0IiwiU3RyZWFtTWVzc2FnZVdyaXRlciIsInN0ZGluIiwiZXJyb3IiLCJtIiwibG9nIiwiTGFuZ3VhZ2VDbGllbnRWMiIsIm9uTG9nTWVzc2FnZSIsImluaXRpYWxpemVSZXNwb25zZSIsImluaXRpYWxpemUiLCJnZXRJbml0aWFsaXplUGFyYW1zIiwiYnJpZGdlQ2FwYWJpbGl0aWVzIiwiY2FwYWJpbGl0aWVzIiwicG9zdEluaXRpYWxpemF0aW9uIiwibGludGVyIiwiY29tcGxldGlvblByb3ZpZGVyIiwiYXV0b0NvbXBsZXRlIiwiZG9jdW1lbnRTeW1ib2xQcm92aWRlciIsIm91dGxpbmUiLCJkZWZpbml0aW9uUHJvdmlkZXIiLCJkZWZpbml0aW9ucyIsImh5cGVyY2xpY2siLCJhZGQiLCJ0ZXh0RG9jdW1lbnRTeW5jIiwiZG9jdW1lbnRSYW5nZUZvcm1hdHRpbmdQcm92aWRlciIsImRvY3VtZW50Rm9ybWF0dGluZ1Byb3ZpZGVyIiwiSW5pdGlhbGl6YXRpb25SZXN1bHQiLCJwcm92aWRlT3V0bGluZXMiLCJuYW1lIiwiZ3JhbW1hclNjb3BlcyIsInByaW9yaXR5IiwiZ2V0T3V0bGluZSIsImJpbmQiLCJlZGl0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInByb3ZpZGVMaW50ZXIiLCJzY29wZSIsImxpbnRPbkZseSIsImxpbnQiLCJwcm92aWRlTGludGluZyIsInByb3ZpZGVEaWFnbm9zdGljcyIsInByb3ZpZGVBdXRvY29tcGxldGUiLCJzZWxlY3RvciIsImV4Y2x1ZGVMb3dlclByaW9yaXR5IiwiZ2V0U3VnZ2VzdGlvbnMiLCJwcm92aWRlU3VnZ2VzdGlvbnMiLCJyZXF1ZXN0IiwicHJvdmlkZURlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbiIsImdldERlZmluaXRpb25CeUlkIiwicG9pbnQiLCJmaWxlbmFtZSIsImlkIiwicHJvdmlkZUh5cGVyY2xpY2siLCJwcm92aWRlck5hbWUiLCJnZXRTdWdnZXN0aW9uIiwiZ2V0SHlwZXJjbGlja1N1Z2dlc3Rpb24iLCJyb290RGlycyIsInByb2plY3QiLCJnZXREaXJlY3RvcmllcyIsInByb2Nlc3NJZCIsInByb2Nlc3MiLCJwaWQiLCJyb290UGF0aCIsImxlbmd0aCIsInBhdGgiLCJhcmdzIiwiQXJyYXkiLCJpc0FycmF5Iiwic2xpY2UiXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7O0lBQVlBLEU7O0FBQ1o7O0lBQVlDLEU7O0FBQ1o7O0lBQVlDLEc7O0FBRVo7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7Ozs7Ozs7O0lBRXFCQyxVLEdBQU4sTUFBTUEsVUFBTixDQUFpQjtBQUFBO0FBQUEsU0FDOUJDLFdBRDhCLEdBQ2hCLCtCQURnQjtBQUFBOztBQWE5QkMsWUFBVTtBQUFFLFVBQU0sK0NBQU47QUFBdUQ7QUFDbkVDLHFCQUFtQjtBQUFFLFVBQU0sd0RBQU47QUFBZ0U7O0FBRXJGQyxhQUFpQjtBQUNmLFFBQUlDLEtBQUtDLE1BQUwsQ0FBWUMsR0FBWixDQUFnQixlQUFoQixDQUFKLEVBQXNDLEtBQUtDLE1BQUwsR0FBY0MsUUFBUUMsS0FBdEI7QUFDdEMsU0FBS0MsV0FBTDtBQUNEOztBQUVEQyxlQUFtQjtBQUNqQixTQUFLWCxXQUFMLENB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O0FBQ0xDLGlCQUFXQyxRQUFRQyxHQURkO0FBRUxuRCxvQkFBYyxFQUZUO0FBR0xvRCxnQkFBVU4sU0FBU08sTUFBVCxHQUFrQixDQUFsQixHQUFzQlAsU0FBUyxDQUFULEVBQVlRLElBQWxDLEdBQXlDO0FBSDlDLEtBQVA7QUFLRDs7QUFFRDdELE1BQUk4RCxJQUFKLEVBQXFDO0FBQ25DLFFBQUksS0FBS2pGLE1BQUwsSUFBZSxJQUFuQixFQUF5Qjs7QUFFekIsUUFBSSxPQUFPaUYsSUFBUCxLQUFnQixRQUFwQixFQUE4QjtBQUM1QixXQUFLakYsTUFBTCxDQUFhLEdBQUUsS0FBS04sT0FBTCxFQUFlLElBQUd1RixJQUFLLEVBQXRDO0FBQ0E7QUFDRDs7QUFFRCxRQUFJQyxNQUFNQyxPQUFOLENBQWNGLElBQWQsS0FBdUIsT0FBT0EsS0FBSyxDQUFMLENBQVAsS0FBbUIsUUFBOUMsRUFBd0Q7QUFDdEQsVUFBSUEsS0FBS0YsTUFBTCxLQUFnQixDQUFwQixFQUF1QjtBQUNyQixhQUFLL0UsTUFBTCxDQUFhLEdBQUUsS0FBS04sT0FBTCxFQUFlLElBQUd1RixLQUFLLENBQUwsQ0FBUSxFQUF6QyxFQUE0Q0EsS0FBSyxDQUFMLENBQTVDO0FBQ0E7QUFDRCxPQUhELE1BR087QUFDTCxhQUFLakYsTUFBTCxDQUFhLEdBQUUsS0FBS04sT0FBTCxFQUFlLElBQUd1RixLQUFLLENBQUwsQ0FBUSxFQUF6QyxFQUE0Q0EsS0FBS0csS0FBTCxDQUFXLENBQVgsQ0FBNUM7QUFDQTtBQUNEO0FBQ0Y7O0FBRUQsU0FBS3BGLE1BQUwsQ0FBYSxHQUFFLEtBQUtOLE9BQUwsRUFBZSxFQUE5QixFQUFpQ3VGLElBQWpDO0FBQ0Q7QUFyTDZCLEM7a0JBQVh6RixVIiwiZmlsZSI6ImF1dG8tYnJpZGdlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcclxuXHJcbmltcG9ydCAqIGFzIGNwIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xyXG5pbXBvcnQgKiBhcyBscyBmcm9tICcuL3Byb3RvY29sL2xhbmd1YWdlY2xpZW50LXYyJztcclxuaW1wb3J0ICogYXMgcnBjIGZyb20gJ3ZzY29kZS1qc29ucnBjJztcclxuXHJcbmltcG9ydCBBdXRvY29tcGxldGVCcmlkZ2UgZnJvbSAnLi9icmlkZ2VzL2F1dG9jb21wbGV0ZS1icmlkZ2UnO1xyXG5pbXBvcnQgRG9jdW1lbnRTeW5jQnJpZGdlIGZyb20gJy4vYnJpZGdlcy9kb2N1bWVudC1zeW5jLWJyaWRnZSc7XHJcbmltcG9ydCBGb3JtYXREb2N1bWVudEJyaWRnZSBmcm9tICcuL2JyaWRnZXMvZm9ybWF0LWRvY3VtZW50LWJyaWRnZSc7XHJcbmltcG9ydCBGb3JtYXRSYW5nZUJyaWRnZSBmcm9tICcuL2JyaWRnZXMvZm9ybWF0LXJhbmdlLWJyaWRnZSc7XHJcbmltcG9ydCBMaW50ZXJCcmlkZ2UgZnJvbSAnLi9icmlkZ2VzL2xpbnRlci1icmlkZ2UnO1xyXG5pbXBvcnQgTWVzc2FnZU5vdGlmaWNhdGlvbnNCcmlkZ2UgZnJvbSAnLi9icmlkZ2VzL21lc3NhZ2Utbm90aWZpY2F0aW9ucy1icmlkZ2UnO1xyXG5pbXBvcnQgTnVjbGlkZURlZmluaXRpb25CcmlkZ2UgZnJvbSAnLi9icmlkZ2VzL251Y2xpZGUtZGVmaW5pdGlvbi1icmlkZ2UnO1xyXG5pbXBvcnQgTnVjbGlkZUh5cGVyY2xpY2tCcmlkZ2UgZnJvbSAnLi9icmlkZ2VzL251Y2xpZGUtaHlwZXJjbGljay1icmlkZ2UnO1xyXG5pbXBvcnQgTnVjbGlkZU91dGxpbmVWaWV3QnJpZGdlIGZyb20gJy4vYnJpZGdlcy9udWNsaWRlLW91dGxpbmUtdmlldy1icmlkZ2UnO1xyXG5cclxuaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tICdhdG9tJztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEF1dG9CcmlkZ2Uge1xyXG4gIF9kaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcclxuICBfcHJvY2VzczogP2NoaWxkX3Byb2Nlc3MkQ2hpbGRQcm9jZXNzO1xyXG4gIF9sYzogbHMuTGFuZ3VhZ2VDbGllbnRWMjtcclxuXHJcbiAgYXV0b0NvbXBsZXRlOiA/QXV0b2NvbXBsZXRlQnJpZGdlO1xyXG4gIGRlZmluaXRpb25zOiA/TnVjbGlkZURlZmluaXRpb25CcmlkZ2U7XHJcbiAgaHlwZXJjbGljazogP051Y2xpZGVIeXBlcmNsaWNrQnJpZGdlO1xyXG4gIGxpbnRlcjogP0xpbnRlckJyaWRnZTtcclxuICBvdXRsaW5lOiA/TnVjbGlkZU91dGxpbmVWaWV3QnJpZGdlO1xyXG5cclxuICBsb2dnZXI6IChtOiBzdHJpbmcgfCBBcnJheTxhbnk+KSA9PiB2b2lkO1xyXG5cclxuICBnZXROYW1lKCkgeyB0aHJvdyBcIk11c3Qgc2V0IG5hbWUgZmllbGQgd2hlbiBleHRlbmRpbmcgQXV0b0JyaWRnZVwiIH07XHJcbiAgZ2V0R3JhbW1hclNjb3BlcygpIHsgdGhyb3cgXCJNdXN0IHNldCBncmFtbWFyU2NvcGVzIGZpZWxkIHdoZW4gZXh0ZW5kaW5nIEF1dG9CcmlkZ2VcIiB9O1xyXG5cclxuICBhY3RpdmF0ZSgpOiB2b2lkIHtcclxuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2NvcmUuZGVidWdMU1AnKSkgdGhpcy5sb2dnZXIgPSBjb25zb2xlLmRlYnVnO1xyXG4gICAgdGhpcy5zdGFydFNlcnZlcigpO1xyXG4gIH1cclxuXHJcbiAgZGVhY3RpdmF0ZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuX2Rpc3Bvc2FibGUuZGlzcG9zZSgpO1xyXG5cclxuICAgIGlmICh0aGlzLl9sYykge1xyXG4gICAgICB0aGlzLl9sYy5zaHV0ZG93bigpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLl9wcm9jZXNzICE9IG51bGwpIHtcclxuICAgICAgdGhpcy5fcHJvY2Vzcy5raWxsKCk7XHJcbiAgICAgIHRoaXMuX3Byb2Nlc3MgPSBudWxsO1xyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHN0YXJ0U2VydmVyKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgaWYgKHRoaXMuX3Byb2Nlc3MgIT0gbnVsbCkgcmV0dXJuO1xyXG5cclxuICAgIHRoaXMuX3Byb2Nlc3MgPSBhd2FpdCB0aGlzLnN0YXJ0U2VydmVyUHJvY2VzcygpO1xyXG5cclxuICAgIGNvbnN0IGNvbm5lY3Rpb24gPSBycGMuY3JlYXRlTWVzc2FnZUNvbm5lY3Rpb24oXHJcbiAgICAgIG5ldyBycGMuU3RyZWFtTWVzc2FnZVJlYWRlcih0aGlzLl9wcm9jZXNzLnN0ZG91dCksXHJcbiAgICAgIG5ldyBycGMuU3RyZWFtTWVzc2FnZVdyaXRlcih0aGlzLl9wcm9jZXNzLnN0ZGluKSxcclxuICAgICAgeyBlcnJvcjogKG06IE9iamVjdCkgPT4geyB0aGlzLmxvZyhtKTsgfSB9KTtcclxuXHJcbiAgICB0aGlzLl9sYyA9IG5ldyBscy5MYW5ndWFnZUNsaWVudFYyKGNvbm5lY3Rpb24sICguLi5tKSA9PiB0aGlzLmxvZyhtKSk7XHJcbiAgICB0aGlzLl9sYy5vbkxvZ01lc3NhZ2UobSA9PiB0aGlzLmxvZyhbJ0xvZycsIG1dKSk7XHJcblxyXG4gICAgY29uc3QgaW5pdGlhbGl6ZVJlc3BvbnNlID0gYXdhaXQgdGhpcy5fbGMuaW5pdGlhbGl6ZSh0aGlzLmdldEluaXRpYWxpemVQYXJhbXMoKSk7XHJcbiAgICB0aGlzLmJyaWRnZUNhcGFiaWxpdGllcyhpbml0aWFsaXplUmVzcG9uc2UuY2FwYWJpbGl0aWVzKTtcclxuICAgIHRoaXMucG9zdEluaXRpYWxpemF0aW9uKGluaXRpYWxpemVSZXNwb25zZSk7XHJcbiAgfVxyXG5cclxuICBzdGFydFNlcnZlclByb2Nlc3MoKTogY2hpbGRfcHJvY2VzcyRDaGlsZFByb2Nlc3Mge1xyXG4gICAgdGhyb3cgXCJNdXN0IG92ZXJyaWRlIHN0YXJ0U2VydmVyUHJvY2VzcyB0byBzdGFydCB0aGUgbGFuZ3VhZ2Ugc2VydmVyIHByb2Nlc3Mgd2hlbiBleHRlbmRpbmcgQXV0b0JyaWRnZVwiO1xyXG4gIH1cclxuXHJcbiAgYnJpZGdlQ2FwYWJpbGl0aWVzKGNhcGFiaWxpdGllczogbHMuU2VydmVyQ2FwYWJpbGl0aWVzKTogdm9pZCB7XHJcbiAgICB0aGlzLmxpbnRlciA9IG5ldyBMaW50ZXJCcmlkZ2UodGhpcy5fbGMpO1xyXG4gICAgaWYgKGNhcGFiaWxpdGllcy5jb21wbGV0aW9uUHJvdmlkZXIpIHtcclxuICAgICAgdGhpcy5hdXRvQ29tcGxldGUgPSBuZXcgQXV0b2NvbXBsZXRlQnJpZGdlKHRoaXMuX2xjKTtcclxuICAgIH1cclxuICAgIGlmIChjYXBhYmlsaXRpZXMuZG9jdW1lbnRTeW1ib2xQcm92aWRlcikge1xyXG4gICAgICB0aGlzLm91dGxpbmUgPSBuZXcgTnVjbGlkZU91dGxpbmVWaWV3QnJpZGdlKHRoaXMuX2xjLCB0aGlzLmdldE5hbWUoKSk7XHJcbiAgICB9XHJcbiAgICBpZiAoY2FwYWJpbGl0aWVzLmRlZmluaXRpb25Qcm92aWRlcikge1xyXG4gICAgICB0aGlzLmRlZmluaXRpb25zID0gbmV3IE51Y2xpZGVEZWZpbml0aW9uQnJpZGdlKHRoaXMuX2xjKTtcclxuICAgICAgdGhpcy5oeXBlcmNsaWNrID0gbmV3IE51Y2xpZGVIeXBlcmNsaWNrQnJpZGdlKHRoaXMuX2xjKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChuZXcgTWVzc2FnZU5vdGlmaWNhdGlvbnNCcmlkZ2UodGhpcy5fbGMsIHRoaXMuZ2V0TmFtZSgpKSk7XHJcbiAgICBpZiAoY2FwYWJpbGl0aWVzLnRleHREb2N1bWVudFN5bmMpIHtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQobmV3IERvY3VtZW50U3luY0JyaWRnZSh0aGlzLl9sYywgY2FwYWJpbGl0aWVzLnRleHREb2N1bWVudFN5bmMpKTtcclxuICAgIH1cclxuICAgIGlmIChjYXBhYmlsaXRpZXMuZG9jdW1lbnRSYW5nZUZvcm1hdHRpbmdQcm92aWRlcikge1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChuZXcgRm9ybWF0UmFuZ2VCcmlkZ2UodGhpcy5fbGMpKTtcclxuICAgIH1cclxuICAgIGlmIChjYXBhYmlsaXRpZXMuZG9jdW1lbnRGb3JtYXR0aW5nUHJvdmlkZXIpIHtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQobmV3IEZvcm1hdERvY3VtZW50QnJpZGdlKHRoaXMuX2xjKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwb3N0SW5pdGlhbGl6YXRpb24oSW5pdGlhbGl6YXRpb25SZXN1bHQ6IGxzLkluaXRpYWxpemVSZXN1bHQpOiB2b2lkIHtcclxuICB9XHJcblxyXG4gIHByb3ZpZGVPdXRsaW5lcygpOiBudWNsaWRlJE91dGxpbmVQcm92aWRlciB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBuYW1lOiB0aGlzLmdldE5hbWUoKSxcclxuICAgICAgZ3JhbW1hclNjb3BlczogdGhpcy5nZXRHcmFtbWFyU2NvcGVzKCksXHJcbiAgICAgIHByaW9yaXR5OiAxLFxyXG4gICAgICBnZXRPdXRsaW5lOiB0aGlzLmdldE91dGxpbmUuYmluZCh0aGlzKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGdldE91dGxpbmUoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpOiBQcm9taXNlPD9udWNsaWRlJE91dGxpbmU+IHtcclxuICAgIHJldHVybiB0aGlzLm91dGxpbmUgIT0gbnVsbCA/IHRoaXMub3V0bGluZS5nZXRPdXRsaW5lKGVkaXRvcikgOiBQcm9taXNlLnJlc29sdmUobnVsbCk7XHJcbiAgfVxyXG5cclxuICBwcm92aWRlTGludGVyKCk6IGxpbnRlciRTdGFuZGFyZExpbnRlciB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBuYW1lOiB0aGlzLmdldE5hbWUoKSxcclxuICAgICAgZ3JhbW1hclNjb3BlczogdGhpcy5nZXRHcmFtbWFyU2NvcGVzKCksXHJcbiAgICAgIHNjb3BlOiAncHJvamVjdCcsXHJcbiAgICAgIGxpbnRPbkZseTogdHJ1ZSxcclxuICAgICAgbGludDogdGhpcy5wcm92aWRlTGludGluZy5iaW5kKHRoaXMpXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHJvdmlkZUxpbnRpbmcoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpOiA/QXJyYXk8bGludGVyJE1lc3NhZ2U+IHwgUHJvbWlzZTw/QXJyYXk8bGludGVyJE1lc3NhZ2U+PiB7XHJcbiAgICByZXR1cm4gdGhpcy5saW50ZXIgIT0gbnVsbCA/IHRoaXMubGludGVyLnByb3ZpZGVEaWFnbm9zdGljcygpIDogUHJvbWlzZS5yZXNvbHZlKFtdKTtcclxuICB9XHJcblxyXG4gIHByb3ZpZGVBdXRvY29tcGxldGUoKTogYXRvbSRBdXRvY29tcGxldGVQcm92aWRlciB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzZWxlY3RvcjogJy5zb3VyY2UnLFxyXG4gICAgICBleGNsdWRlTG93ZXJQcmlvcml0eTogZmFsc2UsXHJcbiAgICAgIGdldFN1Z2dlc3Rpb25zOiB0aGlzLnByb3ZpZGVTdWdnZXN0aW9ucy5iaW5kKHRoaXMpXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHJvdmlkZVN1Z2dlc3Rpb25zKHJlcXVlc3Q6IGFueSk6IFByb21pc2U8QXJyYXk8YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uPj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuYXV0b0NvbXBsZXRlICE9IG51bGwgPyB0aGlzLmF1dG9Db21wbGV0ZS5wcm92aWRlU3VnZ2VzdGlvbnMocmVxdWVzdCkgOiBQcm9taXNlLnJlc29sdmUoW10pO1xyXG4gIH1cclxuXHJcbiAgcHJvdmlkZURlZmluaXRpb25zKCk6IG51Y2xpZGUkRGVmaW5pdGlvblByb3ZpZGVyIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG5hbWU6IHRoaXMuZ2V0TmFtZSgpLFxyXG4gICAgICBwcmlvcml0eTogMjAsXHJcbiAgICAgIGdyYW1tYXJTY29wZXM6IHRoaXMuZ2V0R3JhbW1hclNjb3BlcygpLFxyXG4gICAgICBnZXREZWZpbml0aW9uOiB0aGlzLmdldERlZmluaXRpb24uYmluZCh0aGlzKSxcclxuICAgICAgZ2V0RGVmaW5pdGlvbkJ5SWQ6IHRoaXMuZ2V0RGVmaW5pdGlvbkJ5SWQuYmluZCh0aGlzKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0RGVmaW5pdGlvbihlZGl0b3I6IFRleHRFZGl0b3IsIHBvaW50OiBhdG9tJFBvaW50KTogUHJvbWlzZTw/bnVjbGlkZSREZWZpbml0aW9uUXVlcnlSZXN1bHQ+IHtcclxuICAgIHJldHVybiB0aGlzLmRlZmluaXRpb25zICE9IG51bGwgPyB0aGlzLmRlZmluaXRpb25zLmdldERlZmluaXRpb24oZWRpdG9yLCBwb2ludCkgOiBQcm9taXNlLnJlc29sdmUobnVsbCk7XHJcbiAgfVxyXG5cclxuICBnZXREZWZpbml0aW9uQnlJZChmaWxlbmFtZTogTnVjbGlkZVVyaSwgaWQ6IHN0cmluZyk6IFByb21pc2U8P251Y2xpZGUkRGVmaW5pdGlvbj4ge1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcclxuICB9XHJcblxyXG4gIHByb3ZpZGVIeXBlcmNsaWNrKCk6IG51Y2xpZGUkSHlwZXJjbGlja1Byb3ZpZGVyIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHByaW9yaXR5OiAyMCxcclxuICAgICAgcHJvdmlkZXJOYW1lOiB0aGlzLmdldE5hbWUoKSxcclxuICAgICAgZ2V0U3VnZ2VzdGlvbjogdGhpcy5nZXRIeXBlcmNsaWNrU3VnZ2VzdGlvbi5iaW5kKHRoaXMpXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgZ2V0SHlwZXJjbGlja1N1Z2dlc3Rpb24oZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHBvaW50OiBhdG9tJFBvaW50KTogUHJvbWlzZTw/bnVjbGlkZSRIeXBlcmNsaWNrU3VnZ2VzdGlvbj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuaHlwZXJjbGljayAhPSBudWxsID8gdGhpcy5oeXBlcmNsaWNrLmdldFN1Z2dlc3Rpb24oZWRpdG9yLCBwb2ludCkgOiBQcm9taXNlLnJlc29sdmUobnVsbCk7XHJcbiAgfVxyXG5cclxuICBnZXRJbml0aWFsaXplUGFyYW1zKCk6IGxzLkluaXRpYWxpemVQYXJhbXMge1xyXG4gICAgY29uc3Qgcm9vdERpcnM6IEFycmF5PGFueT4gPSBhdG9tLnByb2plY3QuZ2V0RGlyZWN0b3JpZXMoKTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHByb2Nlc3NJZDogcHJvY2Vzcy5waWQsXHJcbiAgICAgIGNhcGFiaWxpdGllczogeyB9LFxyXG4gICAgICByb290UGF0aDogcm9vdERpcnMubGVuZ3RoID4gMCA/IHJvb3REaXJzWzBdLnBhdGggOiBudWxsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgbG9nKGFyZ3M6IE9iamVjdCB8IEFycmF5PGFueT4pOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmxvZ2dlciA9PSBudWxsKSByZXR1cm47XHJcblxyXG4gICAgaWYgKHR5cGVvZiBhcmdzID09PSAnc3RyaW5nJykge1xyXG4gICAgICB0aGlzLmxvZ2dlcihgJHt0aGlzLmdldE5hbWUoKX0gJHthcmdzfWApO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoYXJncykgJiYgdHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMikge1xyXG4gICAgICAgIHRoaXMubG9nZ2VyKGAke3RoaXMuZ2V0TmFtZSgpfSAke2FyZ3NbMF19YCwgYXJnc1sxXSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMubG9nZ2VyKGAke3RoaXMuZ2V0TmFtZSgpfSAke2FyZ3NbMF19YCwgYXJncy5zbGljZSgxKSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5sb2dnZXIoYCR7dGhpcy5nZXROYW1lKCl9YCwgYXJncyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==