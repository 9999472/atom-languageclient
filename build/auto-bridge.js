Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _child_process = require('child_process');

var cp = _interopRequireWildcard(_child_process);

var _languageclientV = require('./protocol/languageclient-v2');

var ls = _interopRequireWildcard(_languageclientV);

var _vscodeJsonrpc = require('vscode-jsonrpc');

var rpc = _interopRequireWildcard(_vscodeJsonrpc);

var _autocompleteBridge = require('./bridges/autocomplete-bridge');

var _autocompleteBridge2 = _interopRequireDefault(_autocompleteBridge);

var _documentSyncBridge = require('./bridges/document-sync-bridge');

var _documentSyncBridge2 = _interopRequireDefault(_documentSyncBridge);

var _formatDocumentBridge = require('./bridges/format-document-bridge');

var _formatDocumentBridge2 = _interopRequireDefault(_formatDocumentBridge);

var _formatRangeBridge = require('./bridges/format-range-bridge');

var _formatRangeBridge2 = _interopRequireDefault(_formatRangeBridge);

var _linterBridge = require('./bridges/linter-bridge');

var _linterBridge2 = _interopRequireDefault(_linterBridge);

var _messageNotificationsBridge = require('./bridges/message-notifications-bridge');

var _messageNotificationsBridge2 = _interopRequireDefault(_messageNotificationsBridge);

var _nuclideOutlineViewBridge = require('./bridges/nuclide-outline-view-bridge');

var _nuclideOutlineViewBridge2 = _interopRequireDefault(_nuclideOutlineViewBridge);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

let AutoBridge = class AutoBridge {
  constructor() {
    this._disposable = new _atom.CompositeDisposable();
  }

  getName() {
    throw "Must set name field when extending AutoBridge";
  }
  getGrammarScopes() {
    throw "Must set grammarScopes field when extending AutoBridge";
  }

  activate() {
    if (atom.config.get('core.debugLSP')) this.logger = console.debug;
    this.startServer();
  }

  deactivate() {
    this._disposable.dispose();

    if (this._lc) {
      this._lc.shutdown();
    }

    if (this._process != null) {
      this._process.kill();
      this._process = null;
    };
  }

  startServer() {
    var _this = this;

    return _asyncToGenerator(function* () {
      if (_this._process != null) return;

      _this._process = yield _this.startServerProcess();

      const connection = rpc.createMessageConnection(new rpc.StreamMessageReader(_this._process.stdout), new rpc.StreamMessageWriter(_this._process.stdin), { error: function (m) {
          _this.log(m);
        } });

      _this._lc = new ls.LanguageClientV2(connection, function (...m) {
        return _this.log(m);
      });
      _this._lc.onLogMessage(function (m) {
        return _this.log(['Log', m]);
      });

      const initializeResponse = yield _this._lc.initialize(_this.getInitializeParams());
      _this.bridgeCapabilities(initializeResponse.capabilities);
      _this.postInitialization(initializeResponse);
    })();
  }

  startServerProcess() {
    throw "Must override startServerProcess to start the language server process when extending AutoBridge";
  }

  bridgeCapabilities(capabilities) {
    this.linter = new _linterBridge2.default(this._lc);
    if (capabilities.completionProvider) {
      this.autoComplete = new _autocompleteBridge2.default(this._lc);
    }
    if (capabilities.documentSymbolProvider) {
      this.symbolProvider = new _nuclideOutlineViewBridge2.default(this._lc, this.getName());
    }

    this._disposable.add(new _messageNotificationsBridge2.default(this._lc, this.getName()));
    if (capabilities.textDocumentSync) {
      this._disposable.add(new _documentSyncBridge2.default(this._lc, capabilities.textDocumentSync));
    }
    if (capabilities.documentRangeFormattingProvider) {
      this._disposable.add(new _formatRangeBridge2.default(this._lc));
    }
    if (capabilities.documentFormattingProvider) {
      this._disposable.add(new _formatDocumentBridge2.default(this._lc));
    }
  }

  postInitialization(InitializationResult) {}

  provideOutlines() {
    return {
      name: this.getName(),
      grammarScopes: this.getGrammarScopes(),
      priority: 1,
      getOutline: this.getOutline.bind(this)
    };
  }

  getOutline(editor) {
    return this.symbolProvider != null ? this.symbolProvider.getOutline(editor) : Promise.resolve(null);
  }

  provideLinter() {
    return {
      name: this.getName(),
      grammarScopes: this.getGrammarScopes(),
      scope: 'project',
      lintOnFly: true,
      lint: this.provideLinting.bind(this)
    };
  }

  provideLinting(editor) {
    return this.linter != null ? this.linter.provideDiagnostics() : Promise.resolve([]);
  }

  provideAutocomplete() {
    return {
      selector: '.source',
      excludeLowerPriority: false,
      getSuggestions: this.provideSuggestions.bind(this)
    };
  }

  provideSuggestions(request) {
    return this.autoComplete != null ? this.autoComplete.provideSuggestions(request) : Promise.resolve([]);
  }

  getInitializeParams() {
    const rootDirs = atom.project.getDirectories();
    return {
      processId: process.pid,
      capabilities: {},
      rootPath: rootDirs.length > 0 ? rootDirs[0].path : null
    };
  }

  log(args) {
    if (this.logger == null) return;

    if (typeof args === 'string') {
      this.logger(`${this.getName()} ${args}`);
      return;
    }

    if (Array.isArray(args) && typeof args[0] === 'string') {
      if (args.length === 2) {
        this.logger(`${this.getName()} ${args[0]}`, args[1]);
        return;
      } else {
        this.logger(`${this.getName()} ${args[0]}`, args.slice(1));
        return;
      }
    }

    this.logger(`${this.getName()}`, args);
  }
};
exports.default = AutoBridge;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9hdXRvLWJyaWRnZS5qcyJdLCJuYW1lcyI6WyJjcCIsImxzIiwicnBjIiwiQXV0b0JyaWRnZSIsIl9kaXNwb3NhYmxlIiwiZ2V0TmFtZSIsImdldEdyYW1tYXJTY29wZXMiLCJhY3RpdmF0ZSIsImF0b20iLCJjb25maWciLCJnZXQiLCJsb2dnZXIiLCJjb25zb2xlIiwiZGVidWciLCJzdGFydFNlcnZlciIsImRlYWN0aXZhdGUiLCJkaXNwb3NlIiwiX2xjIiwic2h1dGRvd24iLCJfcHJvY2VzcyIsImtpbGwiLCJzdGFydFNlcnZlclByb2Nlc3MiLCJjb25uZWN0aW9uIiwiY3JlYXRlTWVzc2FnZUNvbm5lY3Rpb24iLCJTdHJlYW1NZXNzYWdlUmVhZGVyIiwic3Rkb3V0IiwiU3RyZWFtTWVzc2FnZVdyaXRlciIsInN0ZGluIiwiZXJyb3IiLCJtIiwibG9nIiwiTGFuZ3VhZ2VDbGllbnRWMiIsIm9uTG9nTWVzc2FnZSIsImluaXRpYWxpemVSZXNwb25zZSIsImluaXRpYWxpemUiLCJnZXRJbml0aWFsaXplUGFyYW1zIiwiYnJpZGdlQ2FwYWJpbGl0aWVzIiwiY2FwYWJpbGl0aWVzIiwicG9zdEluaXRpYWxpemF0aW9uIiwibGludGVyIiwiY29tcGxldGlvblByb3ZpZGVyIiwiYXV0b0NvbXBsZXRlIiwiZG9jdW1lbnRTeW1ib2xQcm92aWRlciIsInN5bWJvbFByb3ZpZGVyIiwiYWRkIiwidGV4dERvY3VtZW50U3luYyIsImRvY3VtZW50UmFuZ2VGb3JtYXR0aW5nUHJvdmlkZXIiLCJkb2N1bWVudEZvcm1hdHRpbmdQcm92aWRlciIsIkluaXRpYWxpemF0aW9uUmVzdWx0IiwicHJvdmlkZU91dGxpbmVzIiwibmFtZSIsImdyYW1tYXJTY29wZXMiLCJwcmlvcml0eSIsImdldE91dGxpbmUiLCJiaW5kIiwiZWRpdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJwcm92aWRlTGludGVyIiwic2NvcGUiLCJsaW50T25GbHkiLCJsaW50IiwicHJvdmlkZUxpbnRpbmciLCJwcm92aWRlRGlhZ25vc3RpY3MiLCJwcm92aWRlQXV0b2NvbXBsZXRlIiwic2VsZWN0b3IiLCJleGNsdWRlTG93ZXJQcmlvcml0eSIsImdldFN1Z2dlc3Rpb25zIiwicHJvdmlkZVN1Z2dlc3Rpb25zIiwicmVxdWVzdCIsInJvb3REaXJzIiwicHJvamVjdCIsImdldERpcmVjdG9yaWVzIiwicHJvY2Vzc0lkIiwicHJvY2VzcyIsInBpZCIsInJvb3RQYXRoIiwibGVuZ3RoIiwicGF0aCIsImFyZ3MiLCJBcnJheSIsImlzQXJyYXkiLCJzbGljZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQTs7SUFBWUEsRTs7QUFDWjs7SUFBWUMsRTs7QUFDWjs7SUFBWUMsRzs7QUFFWjs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7Ozs7OztJQUVxQkMsVSxHQUFOLE1BQU1BLFVBQU4sQ0FBaUI7QUFBQTtBQUFBLFNBQzlCQyxXQUQ4QixHQUNoQiwrQkFEZ0I7QUFBQTs7QUFVOUJDLFlBQVU7QUFBRSxVQUFNLCtDQUFOO0FBQXVEO0FBQ25FQyxxQkFBbUI7QUFBRSxVQUFNLHdEQUFOO0FBQWdFOztBQUVyRkMsYUFBaUI7QUFDZixRQUFJQyxLQUFLQyxNQUFMLENBQVlDLEdBQVosQ0FBZ0IsZUFBaEIsQ0FBSixFQUFzQyxLQUFLQyxNQUFMLEdBQWNDLFFBQVFDLEtBQXRCO0FBQ3RDLFNBQUtDLFdBQUw7QUFDRDs7QUFFREMsZUFBbUI7QUFDakIsU0FBS1gsV0FBTCxDQUFpQlksT0FBakI7O0FBRUEsUUFBSSxLQUFLQyxHQUFULEVBQWM7QUFDWixXQUFLQSxHQUFMLENBQVNDLFFBQVQ7QUFDRDs7QUFFRCxRQUFJLEtBQUtDLFFBQUwsSUFBaUIsSUFBckIsRUFBMkI7QUFDekIsV0FBS0EsUUFBTCxDQUFjQyxJQUFkO0FBQ0EsV0FBS0QsUUFBTCxHQUFnQixJQUFoQjtBQUNEO0FBQ0Y7O0FBRUtMLGFBQU4sR0FBbUM7QUFBQTs7QUFBQTtBQUNqQyxVQUFJ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QUFFLEtBQUtOLE9BQUwsRUFBZSxJQUFHMEUsSUFBSyxFQUF0QztBQUNBO0FBQ0Q7O0FBRUQsUUFBSUMsTUFBTUMsT0FBTixDQUFjRixJQUFkLEtBQXVCLE9BQU9BLEtBQUssQ0FBTCxDQUFQLEtBQW1CLFFBQTlDLEVBQXdEO0FBQ3RELFVBQUlBLEtBQUtGLE1BQUwsS0FBZ0IsQ0FBcEIsRUFBdUI7QUFDckIsYUFBS2xFLE1BQUwsQ0FBYSxHQUFFLEtBQUtOLE9BQUwsRUFBZSxJQUFHMEUsS0FBSyxDQUFMLENBQVEsRUFBekMsRUFBNENBLEtBQUssQ0FBTCxDQUE1QztBQUNBO0FBQ0QsT0FIRCxNQUdPO0FBQ0wsYUFBS3BFLE1BQUwsQ0FBYSxHQUFFLEtBQUtOLE9BQUwsRUFBZSxJQUFHMEUsS0FBSyxDQUFMLENBQVEsRUFBekMsRUFBNENBLEtBQUtHLEtBQUwsQ0FBVyxDQUFYLENBQTVDO0FBQ0E7QUFDRDtBQUNGOztBQUVELFNBQUt2RSxNQUFMLENBQWEsR0FBRSxLQUFLTixPQUFMLEVBQWUsRUFBOUIsRUFBaUMwRSxJQUFqQztBQUNEO0FBaEo2QixDO2tCQUFYNUUsVSIsImZpbGUiOiJhdXRvLWJyaWRnZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XHJcblxyXG5pbXBvcnQgKiBhcyBjcCBmcm9tICdjaGlsZF9wcm9jZXNzJztcclxuaW1wb3J0ICogYXMgbHMgZnJvbSAnLi9wcm90b2NvbC9sYW5ndWFnZWNsaWVudC12Mic7XHJcbmltcG9ydCAqIGFzIHJwYyBmcm9tICd2c2NvZGUtanNvbnJwYyc7XHJcblxyXG5pbXBvcnQgQXV0b2NvbXBsZXRlQnJpZGdlIGZyb20gJy4vYnJpZGdlcy9hdXRvY29tcGxldGUtYnJpZGdlJztcclxuaW1wb3J0IERvY3VtZW50U3luY0JyaWRnZSBmcm9tICcuL2JyaWRnZXMvZG9jdW1lbnQtc3luYy1icmlkZ2UnO1xyXG5pbXBvcnQgRm9ybWF0RG9jdW1lbnRCcmlkZ2UgZnJvbSAnLi9icmlkZ2VzL2Zvcm1hdC1kb2N1bWVudC1icmlkZ2UnO1xyXG5pbXBvcnQgRm9ybWF0UmFuZ2VCcmlkZ2UgZnJvbSAnLi9icmlkZ2VzL2Zvcm1hdC1yYW5nZS1icmlkZ2UnO1xyXG5pbXBvcnQgTGludGVyQnJpZGdlIGZyb20gJy4vYnJpZGdlcy9saW50ZXItYnJpZGdlJztcclxuaW1wb3J0IE1lc3NhZ2VOb3RpZmljYXRpb25zQnJpZGdlIGZyb20gJy4vYnJpZGdlcy9tZXNzYWdlLW5vdGlmaWNhdGlvbnMtYnJpZGdlJztcclxuaW1wb3J0IE51Y2xpZGVPdXRsaW5lVmlld0JyaWRnZSBmcm9tICcuL2JyaWRnZXMvbnVjbGlkZS1vdXRsaW5lLXZpZXctYnJpZGdlJztcclxuXHJcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBdXRvQnJpZGdlIHtcclxuICBfZGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XHJcbiAgX3Byb2Nlc3M6ID9jaGlsZF9wcm9jZXNzJENoaWxkUHJvY2VzcztcclxuICBfbGM6IGxzLkxhbmd1YWdlQ2xpZW50VjI7XHJcblxyXG4gIGF1dG9Db21wbGV0ZTogP0F1dG9jb21wbGV0ZUJyaWRnZTtcclxuICBsaW50ZXI6ID9MaW50ZXJCcmlkZ2U7XHJcbiAgc3ltYm9sUHJvdmlkZXI6ID9OdWNsaWRlT3V0bGluZVZpZXdCcmlkZ2U7XHJcbiAgbG9nZ2VyOiAobTogc3RyaW5nIHwgQXJyYXk8YW55PikgPT4gdm9pZDtcclxuXHJcbiAgZ2V0TmFtZSgpIHsgdGhyb3cgXCJNdXN0IHNldCBuYW1lIGZpZWxkIHdoZW4gZXh0ZW5kaW5nIEF1dG9CcmlkZ2VcIiB9O1xyXG4gIGdldEdyYW1tYXJTY29wZXMoKSB7IHRocm93IFwiTXVzdCBzZXQgZ3JhbW1hclNjb3BlcyBmaWVsZCB3aGVuIGV4dGVuZGluZyBBdXRvQnJpZGdlXCIgfTtcclxuXHJcbiAgYWN0aXZhdGUoKTogdm9pZCB7XHJcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdjb3JlLmRlYnVnTFNQJykpIHRoaXMubG9nZ2VyID0gY29uc29sZS5kZWJ1ZztcclxuICAgIHRoaXMuc3RhcnRTZXJ2ZXIoKTtcclxuICB9XHJcblxyXG4gIGRlYWN0aXZhdGUoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcclxuXHJcbiAgICBpZiAodGhpcy5fbGMpIHtcclxuICAgICAgdGhpcy5fbGMuc2h1dGRvd24oKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5fcHJvY2VzcyAhPSBudWxsKSB7XHJcbiAgICAgIHRoaXMuX3Byb2Nlc3Mua2lsbCgpO1xyXG4gICAgICB0aGlzLl9wcm9jZXNzID0gbnVsbDtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBhc3luYyBzdGFydFNlcnZlcigpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGlmICh0aGlzLl9wcm9jZXNzICE9IG51bGwpIHJldHVybjtcclxuXHJcbiAgICB0aGlzLl9wcm9jZXNzID0gYXdhaXQgdGhpcy5zdGFydFNlcnZlclByb2Nlc3MoKTtcclxuXHJcbiAgICBjb25zdCBjb25uZWN0aW9uID0gcnBjLmNyZWF0ZU1lc3NhZ2VDb25uZWN0aW9uKFxyXG4gICAgICBuZXcgcnBjLlN0cmVhbU1lc3NhZ2VSZWFkZXIodGhpcy5fcHJvY2Vzcy5zdGRvdXQpLFxyXG4gICAgICBuZXcgcnBjLlN0cmVhbU1lc3NhZ2VXcml0ZXIodGhpcy5fcHJvY2Vzcy5zdGRpbiksXHJcbiAgICAgIHsgZXJyb3I6IChtOiBPYmplY3QpID0+IHsgdGhpcy5sb2cobSk7IH0gfSk7XHJcblxyXG4gICAgdGhpcy5fbGMgPSBuZXcgbHMuTGFuZ3VhZ2VDbGllbnRWMihjb25uZWN0aW9uLCAoLi4ubSkgPT4gdGhpcy5sb2cobSkpO1xyXG4gICAgdGhpcy5fbGMub25Mb2dNZXNzYWdlKG0gPT4gdGhpcy5sb2coWydMb2cnLCBtXSkpO1xyXG5cclxuICAgIGNvbnN0IGluaXRpYWxpemVSZXNwb25zZSA9IGF3YWl0IHRoaXMuX2xjLmluaXRpYWxpemUodGhpcy5nZXRJbml0aWFsaXplUGFyYW1zKCkpO1xyXG4gICAgdGhpcy5icmlkZ2VDYXBhYmlsaXRpZXMoaW5pdGlhbGl6ZVJlc3BvbnNlLmNhcGFiaWxpdGllcyk7XHJcbiAgICB0aGlzLnBvc3RJbml0aWFsaXphdGlvbihpbml0aWFsaXplUmVzcG9uc2UpO1xyXG4gIH1cclxuXHJcbiAgc3RhcnRTZXJ2ZXJQcm9jZXNzKCk6IGNoaWxkX3Byb2Nlc3MkQ2hpbGRQcm9jZXNzIHtcclxuICAgIHRocm93IFwiTXVzdCBvdmVycmlkZSBzdGFydFNlcnZlclByb2Nlc3MgdG8gc3RhcnQgdGhlIGxhbmd1YWdlIHNlcnZlciBwcm9jZXNzIHdoZW4gZXh0ZW5kaW5nIEF1dG9CcmlkZ2VcIjtcclxuICB9XHJcblxyXG4gIGJyaWRnZUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXM6IGxzLlNlcnZlckNhcGFiaWxpdGllcyk6IHZvaWQge1xyXG4gICAgdGhpcy5saW50ZXIgPSBuZXcgTGludGVyQnJpZGdlKHRoaXMuX2xjKTtcclxuICAgIGlmIChjYXBhYmlsaXRpZXMuY29tcGxldGlvblByb3ZpZGVyKSB7XHJcbiAgICAgIHRoaXMuYXV0b0NvbXBsZXRlID0gbmV3IEF1dG9jb21wbGV0ZUJyaWRnZSh0aGlzLl9sYyk7XHJcbiAgICB9XHJcbiAgICBpZiAoY2FwYWJpbGl0aWVzLmRvY3VtZW50U3ltYm9sUHJvdmlkZXIpIHtcclxuICAgICAgdGhpcy5zeW1ib2xQcm92aWRlciA9IG5ldyBOdWNsaWRlT3V0bGluZVZpZXdCcmlkZ2UodGhpcy5fbGMsIHRoaXMuZ2V0TmFtZSgpKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChuZXcgTWVzc2FnZU5vdGlmaWNhdGlvbnNCcmlkZ2UodGhpcy5fbGMsIHRoaXMuZ2V0TmFtZSgpKSk7XHJcbiAgICBpZiAoY2FwYWJpbGl0aWVzLnRleHREb2N1bWVudFN5bmMpIHtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQobmV3IERvY3VtZW50U3luY0JyaWRnZSh0aGlzLl9sYywgY2FwYWJpbGl0aWVzLnRleHREb2N1bWVudFN5bmMpKTtcclxuICAgIH1cclxuICAgIGlmIChjYXBhYmlsaXRpZXMuZG9jdW1lbnRSYW5nZUZvcm1hdHRpbmdQcm92aWRlcikge1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChuZXcgRm9ybWF0UmFuZ2VCcmlkZ2UodGhpcy5fbGMpKTtcclxuICAgIH1cclxuICAgIGlmIChjYXBhYmlsaXRpZXMuZG9jdW1lbnRGb3JtYXR0aW5nUHJvdmlkZXIpIHtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQobmV3IEZvcm1hdERvY3VtZW50QnJpZGdlKHRoaXMuX2xjKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwb3N0SW5pdGlhbGl6YXRpb24oSW5pdGlhbGl6YXRpb25SZXN1bHQ6IGxzLkluaXRpYWxpemVSZXN1bHQpOiB2b2lkIHtcclxuICB9XHJcblxyXG4gIHByb3ZpZGVPdXRsaW5lcygpOiBudWNsaWRlJE91dGxpbmVQcm92aWRlciB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBuYW1lOiB0aGlzLmdldE5hbWUoKSxcclxuICAgICAgZ3JhbW1hclNjb3BlczogdGhpcy5nZXRHcmFtbWFyU2NvcGVzKCksXHJcbiAgICAgIHByaW9yaXR5OiAxLFxyXG4gICAgICBnZXRPdXRsaW5lOiB0aGlzLmdldE91dGxpbmUuYmluZCh0aGlzKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGdldE91dGxpbmUoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpOiBQcm9taXNlPD9udWNsaWRlJE91dGxpbmU+IHtcclxuICAgIHJldHVybiB0aGlzLnN5bWJvbFByb3ZpZGVyICE9IG51bGwgPyB0aGlzLnN5bWJvbFByb3ZpZGVyLmdldE91dGxpbmUoZWRpdG9yKSA6IFByb21pc2UucmVzb2x2ZShudWxsKTtcclxuICB9XHJcblxyXG4gIHByb3ZpZGVMaW50ZXIoKTogbGludGVyJFN0YW5kYXJkTGludGVyIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG5hbWU6IHRoaXMuZ2V0TmFtZSgpLFxyXG4gICAgICBncmFtbWFyU2NvcGVzOiB0aGlzLmdldEdyYW1tYXJTY29wZXMoKSxcclxuICAgICAgc2NvcGU6ICdwcm9qZWN0JyxcclxuICAgICAgbGludE9uRmx5OiB0cnVlLFxyXG4gICAgICBsaW50OiB0aGlzLnByb3ZpZGVMaW50aW5nLmJpbmQodGhpcylcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcm92aWRlTGludGluZyhlZGl0b3I6IGF0b20kVGV4dEVkaXRvcik6ID9BcnJheTxsaW50ZXIkTWVzc2FnZT4gfCBQcm9taXNlPD9BcnJheTxsaW50ZXIkTWVzc2FnZT4+IHtcclxuICAgIHJldHVybiB0aGlzLmxpbnRlciAhPSBudWxsID8gdGhpcy5saW50ZXIucHJvdmlkZURpYWdub3N0aWNzKCkgOiBQcm9taXNlLnJlc29sdmUoW10pO1xyXG4gIH1cclxuXHJcbiAgcHJvdmlkZUF1dG9jb21wbGV0ZSgpOiBhdG9tJEF1dG9jb21wbGV0ZVByb3ZpZGVyIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHNlbGVjdG9yOiAnLnNvdXJjZScsXHJcbiAgICAgIGV4Y2x1ZGVMb3dlclByaW9yaXR5OiBmYWxzZSxcclxuICAgICAgZ2V0U3VnZ2VzdGlvbnM6IHRoaXMucHJvdmlkZVN1Z2dlc3Rpb25zLmJpbmQodGhpcylcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcm92aWRlU3VnZ2VzdGlvbnMocmVxdWVzdDogYW55KTogUHJvbWlzZTxBcnJheTxhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24+PiB7XHJcbiAgICByZXR1cm4gdGhpcy5hdXRvQ29tcGxldGUgIT0gbnVsbCA/IHRoaXMuYXV0b0NvbXBsZXRlLnByb3ZpZGVTdWdnZXN0aW9ucyhyZXF1ZXN0KSA6IFByb21pc2UucmVzb2x2ZShbXSk7XHJcbiAgfVxyXG5cclxuICBnZXRJbml0aWFsaXplUGFyYW1zKCk6IGxzLkluaXRpYWxpemVQYXJhbXMge1xyXG4gICAgY29uc3Qgcm9vdERpcnM6IEFycmF5PGFueT4gPSBhdG9tLnByb2plY3QuZ2V0RGlyZWN0b3JpZXMoKTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHByb2Nlc3NJZDogcHJvY2Vzcy5waWQsXHJcbiAgICAgIGNhcGFiaWxpdGllczogeyB9LFxyXG4gICAgICByb290UGF0aDogcm9vdERpcnMubGVuZ3RoID4gMCA/IHJvb3REaXJzWzBdLnBhdGggOiBudWxsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgbG9nKGFyZ3M6IE9iamVjdCB8IEFycmF5PGFueT4pOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmxvZ2dlciA9PSBudWxsKSByZXR1cm47XHJcblxyXG4gICAgaWYgKHR5cGVvZiBhcmdzID09PSAnc3RyaW5nJykge1xyXG4gICAgICB0aGlzLmxvZ2dlcihgJHt0aGlzLmdldE5hbWUoKX0gJHthcmdzfWApO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoYXJncykgJiYgdHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMikge1xyXG4gICAgICAgIHRoaXMubG9nZ2VyKGAke3RoaXMuZ2V0TmFtZSgpfSAke2FyZ3NbMF19YCwgYXJnc1sxXSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMubG9nZ2VyKGAke3RoaXMuZ2V0TmFtZSgpfSAke2FyZ3NbMF19YCwgYXJncy5zbGljZSgxKSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5sb2dnZXIoYCR7dGhpcy5nZXROYW1lKCl9YCwgYXJncyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==