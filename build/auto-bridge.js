Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _child_process = require('child_process');

var cp = _interopRequireWildcard(_child_process);

var _languageclientV = require('./protocol/languageclient-v2');

var ls = _interopRequireWildcard(_languageclientV);

var _vscodeJsonrpc = require('vscode-jsonrpc');

var rpc = _interopRequireWildcard(_vscodeJsonrpc);

var _consoleLogger = require('./loggers/console-logger');

var _consoleLogger2 = _interopRequireDefault(_consoleLogger);

var _nullLogger = require('./loggers/null-logger');

var _nullLogger2 = _interopRequireDefault(_nullLogger);

var _autocompleteBridge = require('./bridges/autocomplete-bridge');

var _autocompleteBridge2 = _interopRequireDefault(_autocompleteBridge);

var _documentSyncBridge = require('./bridges/document-sync-bridge');

var _documentSyncBridge2 = _interopRequireDefault(_documentSyncBridge);

var _formatDocumentBridge = require('./bridges/format-document-bridge');

var _formatDocumentBridge2 = _interopRequireDefault(_formatDocumentBridge);

var _formatRangeBridge = require('./bridges/format-range-bridge');

var _formatRangeBridge2 = _interopRequireDefault(_formatRangeBridge);

var _linterBridge = require('./bridges/linter-bridge');

var _linterBridge2 = _interopRequireDefault(_linterBridge);

var _messageNotificationsBridge = require('./bridges/message-notifications-bridge');

var _messageNotificationsBridge2 = _interopRequireDefault(_messageNotificationsBridge);

var _nuclideDefinitionBridge = require('./bridges/nuclide-definition-bridge');

var _nuclideDefinitionBridge2 = _interopRequireDefault(_nuclideDefinitionBridge);

var _nuclideHyperclickBridge = require('./bridges/nuclide-hyperclick-bridge');

var _nuclideHyperclickBridge2 = _interopRequireDefault(_nuclideHyperclickBridge);

var _nuclideOutlineViewBridge = require('./bridges/nuclide-outline-view-bridge');

var _nuclideOutlineViewBridge2 = _interopRequireDefault(_nuclideOutlineViewBridge);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

let AutoBridge = class AutoBridge {
  constructor() {
    this._disposable = new _atom.CompositeDisposable();
  }

  getName() {
    throw "Must set name field when extending AutoBridge";
  }
  getGrammarScopes() {
    throw "Must set grammarScopes field when extending AutoBridge";
  }

  activate() {
    this.logger = atom.config.get('core.debugLSP') ? new _consoleLogger2.default(this.getName()) : new _nullLogger2.default();
    this.startServer();
  }

  deactivate() {
    this._disposable.dispose();

    if (this._lc) {
      this._lc.shutdown();
    }

    if (this._process != null) {
      this._process.kill();
      this._process = null;
    };
  }

  startServer() {
    var _this = this;

    return _asyncToGenerator(function* () {
      if (_this._process != null) return;

      _this._process = yield _this.startServerProcess();

      const connection = rpc.createMessageConnection(new rpc.StreamMessageReader(_this._process.stdout), new rpc.StreamMessageWriter(_this._process.stdin), { error: function (m) {
          _this.logger.error(m);
        } });

      _this._lc = new ls.LanguageClientV2(connection, _this.logger);
      _this._lc.onLogMessage(function (m) {
        return _this.logger.log(['Log', m]);
      });

      const initializeResponse = yield _this._lc.initialize(_this.getInitializeParams());
      _this.bridgeCapabilities(initializeResponse.capabilities);
      _this.postInitialization(initializeResponse);
    })();
  }

  startServerProcess() {
    throw "Must override startServerProcess to start the language server process when extending AutoBridge";
  }

  bridgeCapabilities(capabilities) {
    this.linter = new _linterBridge2.default(this._lc);
    if (capabilities.completionProvider) {
      this.autoComplete = new _autocompleteBridge2.default(this._lc);
    }
    if (capabilities.documentSymbolProvider) {
      this.outline = new _nuclideOutlineViewBridge2.default(this._lc, this.getName());
    }
    if (capabilities.definitionProvider) {
      this.definitions = new _nuclideDefinitionBridge2.default(this._lc);
      this.hyperclick = new _nuclideHyperclickBridge2.default(this._lc);
    }

    this._disposable.add(new _messageNotificationsBridge2.default(this._lc, this.getName()));
    if (capabilities.textDocumentSync) {
      this._disposable.add(new _documentSyncBridge2.default(this._lc, capabilities.textDocumentSync));
    }
    if (capabilities.documentRangeFormattingProvider) {
      this._disposable.add(new _formatRangeBridge2.default(this._lc));
    }
    if (capabilities.documentFormattingProvider) {
      this._disposable.add(new _formatDocumentBridge2.default(this._lc));
    }
  }

  postInitialization(InitializationResult) {}

  provideOutlines() {
    return {
      name: this.getName(),
      grammarScopes: this.getGrammarScopes(),
      priority: 1,
      getOutline: this.getOutline.bind(this)
    };
  }

  getOutline(editor) {
    return this.outline != null ? this.outline.getOutline(editor) : Promise.resolve(null);
  }

  provideLinter() {
    return {
      name: this.getName(),
      grammarScopes: this.getGrammarScopes(),
      scope: 'project',
      lintOnFly: true,
      lint: this.provideLinting.bind(this)
    };
  }

  provideLinting(editor) {
    return this.linter != null ? this.linter.provideDiagnostics() : Promise.resolve([]);
  }

  provideAutocomplete() {
    return {
      selector: '.source',
      excludeLowerPriority: false,
      getSuggestions: this.provideSuggestions.bind(this)
    };
  }

  provideSuggestions(request) {
    return this.autoComplete != null ? this.autoComplete.provideSuggestions(request) : Promise.resolve([]);
  }

  provideDefinitions() {
    return {
      name: this.getName(),
      priority: 20,
      grammarScopes: this.getGrammarScopes(),
      getDefinition: this.getDefinition.bind(this),
      getDefinitionById: this.getDefinitionById.bind(this)
    };
  }

  getDefinition(editor, point) {
    return this.definitions != null ? this.definitions.getDefinition(editor, point) : Promise.resolve(null);
  }

  getDefinitionById(filename, id) {
    return Promise.resolve(null);
  }

  provideHyperclick() {
    return {
      priority: 20,
      providerName: this.getName(),
      getSuggestion: this.getHyperclickSuggestion.bind(this)
    };
  }

  getHyperclickSuggestion(editor, point) {
    return this.hyperclick != null ? this.hyperclick.getSuggestion(editor, point) : Promise.resolve(null);
  }

  getInitializeParams() {
    const rootDirs = atom.project.getDirectories();
    return {
      processId: process.pid,
      capabilities: {},
      rootPath: rootDirs.length > 0 ? rootDirs[0].path : null
    };
  }
};
exports.default = AutoBridge;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9hdXRvLWJyaWRnZS5qcyJdLCJuYW1lcyI6WyJjcCIsImxzIiwicnBjIiwiQXV0b0JyaWRnZSIsIl9kaXNwb3NhYmxlIiwiZ2V0TmFtZSIsImdldEdyYW1tYXJTY29wZXMiLCJhY3RpdmF0ZSIsImxvZ2dlciIsImF0b20iLCJjb25maWciLCJnZXQiLCJzdGFydFNlcnZlciIsImRlYWN0aXZhdGUiLCJkaXNwb3NlIiwiX2xjIiwic2h1dGRvd24iLCJfcHJvY2VzcyIsImtpbGwiLCJzdGFydFNlcnZlclByb2Nlc3MiLCJjb25uZWN0aW9uIiwiY3JlYXRlTWVzc2FnZUNvbm5lY3Rpb24iLCJTdHJlYW1NZXNzYWdlUmVhZGVyIiwic3Rkb3V0IiwiU3RyZWFtTWVzc2FnZVdyaXRlciIsInN0ZGluIiwiZXJyb3IiLCJtIiwiTGFuZ3VhZ2VDbGllbnRWMiIsIm9uTG9nTWVzc2FnZSIsImxvZyIsImluaXRpYWxpemVSZXNwb25zZSIsImluaXRpYWxpemUiLCJnZXRJbml0aWFsaXplUGFyYW1zIiwiYnJpZGdlQ2FwYWJpbGl0aWVzIiwiY2FwYWJpbGl0aWVzIiwicG9zdEluaXRpYWxpemF0aW9uIiwibGludGVyIiwiY29tcGxldGlvblByb3ZpZGVyIiwiYXV0b0NvbXBsZXRlIiwiZG9jdW1lbnRTeW1ib2xQcm92aWRlciIsIm91dGxpbmUiLCJkZWZpbml0aW9uUHJvdmlkZXIiLCJkZWZpbml0aW9ucyIsImh5cGVyY2xpY2siLCJhZGQiLCJ0ZXh0RG9jdW1lbnRTeW5jIiwiZG9jdW1lbnRSYW5nZUZvcm1hdHRpbmdQcm92aWRlciIsImRvY3VtZW50Rm9ybWF0dGluZ1Byb3ZpZGVyIiwiSW5pdGlhbGl6YXRpb25SZXN1bHQiLCJwcm92aWRlT3V0bGluZXMiLCJuYW1lIiwiZ3JhbW1hclNjb3BlcyIsInByaW9yaXR5IiwiZ2V0T3V0bGluZSIsImJpbmQiLCJlZGl0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInByb3ZpZGVMaW50ZXIiLCJzY29wZSIsImxpbnRPbkZseSIsImxpbnQiLCJwcm92aWRlTGludGluZyIsInByb3ZpZGVEaWFnbm9zdGljcyIsInByb3ZpZGVBdXRvY29tcGxldGUiLCJzZWxlY3RvciIsImV4Y2x1ZGVMb3dlclByaW9yaXR5IiwiZ2V0U3VnZ2VzdGlvbnMiLCJwcm92aWRlU3VnZ2VzdGlvbnMiLCJyZXF1ZXN0IiwicHJvdmlkZURlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbiIsImdldERlZmluaXRpb25CeUlkIiwicG9pbnQiLCJmaWxlbmFtZSIsImlkIiwicHJvdmlkZUh5cGVyY2xpY2siLCJwcm92aWRlck5hbWUiLCJnZXRTdWdnZXN0aW9uIiwiZ2V0SHlwZXJjbGlja1N1Z2dlc3Rpb24iLCJyb290RGlycyIsInByb2plY3QiLCJnZXREaXJlY3RvcmllcyIsInByb2Nlc3NJZCIsInByb2Nlc3MiLCJwaWQiLCJyb290UGF0aCIsImxlbmd0aCIsInBhdGgiXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7O0lBQVlBLEU7O0FBQ1o7O0lBQVlDLEU7O0FBQ1o7O0lBQVlDLEc7O0FBRVo7Ozs7QUFDQTs7OztBQUVBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7Ozs7OztJQUVxQkMsVSxHQUFOLE1BQU1BLFVBQU4sQ0FBaUI7QUFBQTtBQUFBLFNBQzlCQyxXQUQ4QixHQUNoQiwrQkFEZ0I7QUFBQTs7QUFhOUJDLFlBQVU7QUFBRSxVQUFNLCtDQUFOO0FBQXVEO0FBQ25FQyxxQkFBbUI7QUFBRSxVQUFNLHdEQUFOO0FBQWdFOztBQUVyRkMsYUFBaUI7QUFDZixTQUFLQyxNQUFMLEdBQWNDLEtBQUtDLE1BQUwsQ0FBWUMsR0FBWixDQUFnQixlQUFoQixJQUFtQyw0QkFBa0IsS0FBS04sT0FBTCxFQUFsQixDQUFuQyxHQUF1RSwwQkFBckY7QUFDQSxTQUFLTyxXQUFMO0FBQ0Q7O0FBRURDLGVBQW1CO0FBQ2pCLFNBQUtULFdBQUwsQ0FBaUJVLE9BQWpCOztBQUVB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RUFGVDtBQUdMb0QsZ0JBQVVOLFNBQVNPLE1BQVQsR0FBa0IsQ0FBbEIsR0FBc0JQLFNBQVMsQ0FBVCxFQUFZUSxJQUFsQyxHQUF5QztBQUg5QyxLQUFQO0FBS0Q7QUFoSzZCLEM7a0JBQVh0RixVIiwiZmlsZSI6ImF1dG8tYnJpZGdlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcclxuXHJcbmltcG9ydCAqIGFzIGNwIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xyXG5pbXBvcnQgKiBhcyBscyBmcm9tICcuL3Byb3RvY29sL2xhbmd1YWdlY2xpZW50LXYyJztcclxuaW1wb3J0ICogYXMgcnBjIGZyb20gJ3ZzY29kZS1qc29ucnBjJztcclxuXHJcbmltcG9ydCBDb25zb2xlTG9nZ2VyIGZyb20gJy4vbG9nZ2Vycy9jb25zb2xlLWxvZ2dlcic7XHJcbmltcG9ydCBOdWxsTG9nZ2VyIGZyb20gJy4vbG9nZ2Vycy9udWxsLWxvZ2dlcic7XHJcblxyXG5pbXBvcnQgQXV0b2NvbXBsZXRlQnJpZGdlIGZyb20gJy4vYnJpZGdlcy9hdXRvY29tcGxldGUtYnJpZGdlJztcclxuaW1wb3J0IERvY3VtZW50U3luY0JyaWRnZSBmcm9tICcuL2JyaWRnZXMvZG9jdW1lbnQtc3luYy1icmlkZ2UnO1xyXG5pbXBvcnQgRm9ybWF0RG9jdW1lbnRCcmlkZ2UgZnJvbSAnLi9icmlkZ2VzL2Zvcm1hdC1kb2N1bWVudC1icmlkZ2UnO1xyXG5pbXBvcnQgRm9ybWF0UmFuZ2VCcmlkZ2UgZnJvbSAnLi9icmlkZ2VzL2Zvcm1hdC1yYW5nZS1icmlkZ2UnO1xyXG5pbXBvcnQgTGludGVyQnJpZGdlIGZyb20gJy4vYnJpZGdlcy9saW50ZXItYnJpZGdlJztcclxuaW1wb3J0IE1lc3NhZ2VOb3RpZmljYXRpb25zQnJpZGdlIGZyb20gJy4vYnJpZGdlcy9tZXNzYWdlLW5vdGlmaWNhdGlvbnMtYnJpZGdlJztcclxuaW1wb3J0IE51Y2xpZGVEZWZpbml0aW9uQnJpZGdlIGZyb20gJy4vYnJpZGdlcy9udWNsaWRlLWRlZmluaXRpb24tYnJpZGdlJztcclxuaW1wb3J0IE51Y2xpZGVIeXBlcmNsaWNrQnJpZGdlIGZyb20gJy4vYnJpZGdlcy9udWNsaWRlLWh5cGVyY2xpY2stYnJpZGdlJztcclxuaW1wb3J0IE51Y2xpZGVPdXRsaW5lVmlld0JyaWRnZSBmcm9tICcuL2JyaWRnZXMvbnVjbGlkZS1vdXRsaW5lLXZpZXctYnJpZGdlJztcclxuXHJcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBdXRvQnJpZGdlIHtcclxuICBfZGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XHJcbiAgX3Byb2Nlc3M6ID9jaGlsZF9wcm9jZXNzJENoaWxkUHJvY2VzcztcclxuICBfbGM6IGxzLkxhbmd1YWdlQ2xpZW50VjI7XHJcblxyXG4gIGF1dG9Db21wbGV0ZTogP0F1dG9jb21wbGV0ZUJyaWRnZTtcclxuICBkZWZpbml0aW9uczogP051Y2xpZGVEZWZpbml0aW9uQnJpZGdlO1xyXG4gIGh5cGVyY2xpY2s6ID9OdWNsaWRlSHlwZXJjbGlja0JyaWRnZTtcclxuICBsaW50ZXI6ID9MaW50ZXJCcmlkZ2U7XHJcbiAgb3V0bGluZTogP051Y2xpZGVPdXRsaW5lVmlld0JyaWRnZTtcclxuXHJcbiAgbG9nZ2VyOiBDb25zb2xlTG9nZ2VyIHwgTnVsbExvZ2dlcjtcclxuXHJcbiAgZ2V0TmFtZSgpIHsgdGhyb3cgXCJNdXN0IHNldCBuYW1lIGZpZWxkIHdoZW4gZXh0ZW5kaW5nIEF1dG9CcmlkZ2VcIiB9O1xyXG4gIGdldEdyYW1tYXJTY29wZXMoKSB7IHRocm93IFwiTXVzdCBzZXQgZ3JhbW1hclNjb3BlcyBmaWVsZCB3aGVuIGV4dGVuZGluZyBBdXRvQnJpZGdlXCIgfTtcclxuXHJcbiAgYWN0aXZhdGUoKTogdm9pZCB7XHJcbiAgICB0aGlzLmxvZ2dlciA9IGF0b20uY29uZmlnLmdldCgnY29yZS5kZWJ1Z0xTUCcpID8gbmV3IENvbnNvbGVMb2dnZXIodGhpcy5nZXROYW1lKCkpIDogbmV3IE51bGxMb2dnZXIoKTtcclxuICAgIHRoaXMuc3RhcnRTZXJ2ZXIoKTtcclxuICB9XHJcblxyXG4gIGRlYWN0aXZhdGUoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcclxuXHJcbiAgICBpZiAodGhpcy5fbGMpIHtcclxuICAgICAgdGhpcy5fbGMuc2h1dGRvd24oKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5fcHJvY2VzcyAhPSBudWxsKSB7XHJcbiAgICAgIHRoaXMuX3Byb2Nlc3Mua2lsbCgpO1xyXG4gICAgICB0aGlzLl9wcm9jZXNzID0gbnVsbDtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBhc3luYyBzdGFydFNlcnZlcigpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGlmICh0aGlzLl9wcm9jZXNzICE9IG51bGwpIHJldHVybjtcclxuXHJcbiAgICB0aGlzLl9wcm9jZXNzID0gYXdhaXQgdGhpcy5zdGFydFNlcnZlclByb2Nlc3MoKTtcclxuXHJcbiAgICBjb25zdCBjb25uZWN0aW9uID0gcnBjLmNyZWF0ZU1lc3NhZ2VDb25uZWN0aW9uKFxyXG4gICAgICBuZXcgcnBjLlN0cmVhbU1lc3NhZ2VSZWFkZXIodGhpcy5fcHJvY2Vzcy5zdGRvdXQpLFxyXG4gICAgICBuZXcgcnBjLlN0cmVhbU1lc3NhZ2VXcml0ZXIodGhpcy5fcHJvY2Vzcy5zdGRpbiksXHJcbiAgICAgIHsgZXJyb3I6IChtOiBPYmplY3QpID0+IHsgdGhpcy5sb2dnZXIuZXJyb3IobSk7IH0gfSk7XHJcblxyXG4gICAgdGhpcy5fbGMgPSBuZXcgbHMuTGFuZ3VhZ2VDbGllbnRWMihjb25uZWN0aW9uLCB0aGlzLmxvZ2dlcik7XHJcbiAgICB0aGlzLl9sYy5vbkxvZ01lc3NhZ2UobSA9PiB0aGlzLmxvZ2dlci5sb2coWydMb2cnLCBtXSkpO1xyXG5cclxuICAgIGNvbnN0IGluaXRpYWxpemVSZXNwb25zZSA9IGF3YWl0IHRoaXMuX2xjLmluaXRpYWxpemUodGhpcy5nZXRJbml0aWFsaXplUGFyYW1zKCkpO1xyXG4gICAgdGhpcy5icmlkZ2VDYXBhYmlsaXRpZXMoaW5pdGlhbGl6ZVJlc3BvbnNlLmNhcGFiaWxpdGllcyk7XHJcbiAgICB0aGlzLnBvc3RJbml0aWFsaXphdGlvbihpbml0aWFsaXplUmVzcG9uc2UpO1xyXG4gIH1cclxuXHJcbiAgc3RhcnRTZXJ2ZXJQcm9jZXNzKCk6IGNoaWxkX3Byb2Nlc3MkQ2hpbGRQcm9jZXNzIHtcclxuICAgIHRocm93IFwiTXVzdCBvdmVycmlkZSBzdGFydFNlcnZlclByb2Nlc3MgdG8gc3RhcnQgdGhlIGxhbmd1YWdlIHNlcnZlciBwcm9jZXNzIHdoZW4gZXh0ZW5kaW5nIEF1dG9CcmlkZ2VcIjtcclxuICB9XHJcblxyXG4gIGJyaWRnZUNhcGFiaWxpdGllcyhjYXBhYmlsaXRpZXM6IGxzLlNlcnZlckNhcGFiaWxpdGllcyk6IHZvaWQge1xyXG4gICAgdGhpcy5saW50ZXIgPSBuZXcgTGludGVyQnJpZGdlKHRoaXMuX2xjKTtcclxuICAgIGlmIChjYXBhYmlsaXRpZXMuY29tcGxldGlvblByb3ZpZGVyKSB7XHJcbiAgICAgIHRoaXMuYXV0b0NvbXBsZXRlID0gbmV3IEF1dG9jb21wbGV0ZUJyaWRnZSh0aGlzLl9sYyk7XHJcbiAgICB9XHJcbiAgICBpZiAoY2FwYWJpbGl0aWVzLmRvY3VtZW50U3ltYm9sUHJvdmlkZXIpIHtcclxuICAgICAgdGhpcy5vdXRsaW5lID0gbmV3IE51Y2xpZGVPdXRsaW5lVmlld0JyaWRnZSh0aGlzLl9sYywgdGhpcy5nZXROYW1lKCkpO1xyXG4gICAgfVxyXG4gICAgaWYgKGNhcGFiaWxpdGllcy5kZWZpbml0aW9uUHJvdmlkZXIpIHtcclxuICAgICAgdGhpcy5kZWZpbml0aW9ucyA9IG5ldyBOdWNsaWRlRGVmaW5pdGlvbkJyaWRnZSh0aGlzLl9sYyk7XHJcbiAgICAgIHRoaXMuaHlwZXJjbGljayA9IG5ldyBOdWNsaWRlSHlwZXJjbGlja0JyaWRnZSh0aGlzLl9sYyk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQobmV3IE1lc3NhZ2VOb3RpZmljYXRpb25zQnJpZGdlKHRoaXMuX2xjLCB0aGlzLmdldE5hbWUoKSkpO1xyXG4gICAgaWYgKGNhcGFiaWxpdGllcy50ZXh0RG9jdW1lbnRTeW5jKSB7XHJcbiAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKG5ldyBEb2N1bWVudFN5bmNCcmlkZ2UodGhpcy5fbGMsIGNhcGFiaWxpdGllcy50ZXh0RG9jdW1lbnRTeW5jKSk7XHJcbiAgICB9XHJcbiAgICBpZiAoY2FwYWJpbGl0aWVzLmRvY3VtZW50UmFuZ2VGb3JtYXR0aW5nUHJvdmlkZXIpIHtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQobmV3IEZvcm1hdFJhbmdlQnJpZGdlKHRoaXMuX2xjKSk7XHJcbiAgICB9XHJcbiAgICBpZiAoY2FwYWJpbGl0aWVzLmRvY3VtZW50Rm9ybWF0dGluZ1Byb3ZpZGVyKSB7XHJcbiAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKG5ldyBGb3JtYXREb2N1bWVudEJyaWRnZSh0aGlzLl9sYykpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcG9zdEluaXRpYWxpemF0aW9uKEluaXRpYWxpemF0aW9uUmVzdWx0OiBscy5Jbml0aWFsaXplUmVzdWx0KTogdm9pZCB7XHJcbiAgfVxyXG5cclxuICBwcm92aWRlT3V0bGluZXMoKTogbnVjbGlkZSRPdXRsaW5lUHJvdmlkZXIge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgbmFtZTogdGhpcy5nZXROYW1lKCksXHJcbiAgICAgIGdyYW1tYXJTY29wZXM6IHRoaXMuZ2V0R3JhbW1hclNjb3BlcygpLFxyXG4gICAgICBwcmlvcml0eTogMSxcclxuICAgICAgZ2V0T3V0bGluZTogdGhpcy5nZXRPdXRsaW5lLmJpbmQodGhpcylcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBnZXRPdXRsaW5lKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKTogUHJvbWlzZTw/bnVjbGlkZSRPdXRsaW5lPiB7XHJcbiAgICByZXR1cm4gdGhpcy5vdXRsaW5lICE9IG51bGwgPyB0aGlzLm91dGxpbmUuZ2V0T3V0bGluZShlZGl0b3IpIDogUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xyXG4gIH1cclxuXHJcbiAgcHJvdmlkZUxpbnRlcigpOiBsaW50ZXIkU3RhbmRhcmRMaW50ZXIge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgbmFtZTogdGhpcy5nZXROYW1lKCksXHJcbiAgICAgIGdyYW1tYXJTY29wZXM6IHRoaXMuZ2V0R3JhbW1hclNjb3BlcygpLFxyXG4gICAgICBzY29wZTogJ3Byb2plY3QnLFxyXG4gICAgICBsaW50T25GbHk6IHRydWUsXHJcbiAgICAgIGxpbnQ6IHRoaXMucHJvdmlkZUxpbnRpbmcuYmluZCh0aGlzKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHByb3ZpZGVMaW50aW5nKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKTogP0FycmF5PGxpbnRlciRNZXNzYWdlPiB8IFByb21pc2U8P0FycmF5PGxpbnRlciRNZXNzYWdlPj4ge1xyXG4gICAgcmV0dXJuIHRoaXMubGludGVyICE9IG51bGwgPyB0aGlzLmxpbnRlci5wcm92aWRlRGlhZ25vc3RpY3MoKSA6IFByb21pc2UucmVzb2x2ZShbXSk7XHJcbiAgfVxyXG5cclxuICBwcm92aWRlQXV0b2NvbXBsZXRlKCk6IGF0b20kQXV0b2NvbXBsZXRlUHJvdmlkZXIge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc2VsZWN0b3I6ICcuc291cmNlJyxcclxuICAgICAgZXhjbHVkZUxvd2VyUHJpb3JpdHk6IGZhbHNlLFxyXG4gICAgICBnZXRTdWdnZXN0aW9uczogdGhpcy5wcm92aWRlU3VnZ2VzdGlvbnMuYmluZCh0aGlzKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHByb3ZpZGVTdWdnZXN0aW9ucyhyZXF1ZXN0OiBhbnkpOiBQcm9taXNlPEFycmF5PGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbj4+IHtcclxuICAgIHJldHVybiB0aGlzLmF1dG9Db21wbGV0ZSAhPSBudWxsID8gdGhpcy5hdXRvQ29tcGxldGUucHJvdmlkZVN1Z2dlc3Rpb25zKHJlcXVlc3QpIDogUHJvbWlzZS5yZXNvbHZlKFtdKTtcclxuICB9XHJcblxyXG4gIHByb3ZpZGVEZWZpbml0aW9ucygpOiBudWNsaWRlJERlZmluaXRpb25Qcm92aWRlciB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBuYW1lOiB0aGlzLmdldE5hbWUoKSxcclxuICAgICAgcHJpb3JpdHk6IDIwLFxyXG4gICAgICBncmFtbWFyU2NvcGVzOiB0aGlzLmdldEdyYW1tYXJTY29wZXMoKSxcclxuICAgICAgZ2V0RGVmaW5pdGlvbjogdGhpcy5nZXREZWZpbml0aW9uLmJpbmQodGhpcyksXHJcbiAgICAgIGdldERlZmluaXRpb25CeUlkOiB0aGlzLmdldERlZmluaXRpb25CeUlkLmJpbmQodGhpcylcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdldERlZmluaXRpb24oZWRpdG9yOiBUZXh0RWRpdG9yLCBwb2ludDogYXRvbSRQb2ludCk6IFByb21pc2U8P251Y2xpZGUkRGVmaW5pdGlvblF1ZXJ5UmVzdWx0PiB7XHJcbiAgICByZXR1cm4gdGhpcy5kZWZpbml0aW9ucyAhPSBudWxsID8gdGhpcy5kZWZpbml0aW9ucy5nZXREZWZpbml0aW9uKGVkaXRvciwgcG9pbnQpIDogUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xyXG4gIH1cclxuXHJcbiAgZ2V0RGVmaW5pdGlvbkJ5SWQoZmlsZW5hbWU6IE51Y2xpZGVVcmksIGlkOiBzdHJpbmcpOiBQcm9taXNlPD9udWNsaWRlJERlZmluaXRpb24+IHtcclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbCk7XHJcbiAgfVxyXG5cclxuICBwcm92aWRlSHlwZXJjbGljaygpOiBudWNsaWRlJEh5cGVyY2xpY2tQcm92aWRlciB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBwcmlvcml0eTogMjAsXHJcbiAgICAgIHByb3ZpZGVyTmFtZTogdGhpcy5nZXROYW1lKCksXHJcbiAgICAgIGdldFN1Z2dlc3Rpb246IHRoaXMuZ2V0SHlwZXJjbGlja1N1Z2dlc3Rpb24uYmluZCh0aGlzKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGdldEh5cGVyY2xpY2tTdWdnZXN0aW9uKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLCBwb2ludDogYXRvbSRQb2ludCk6IFByb21pc2U8P251Y2xpZGUkSHlwZXJjbGlja1N1Z2dlc3Rpb24+IHtcclxuICAgIHJldHVybiB0aGlzLmh5cGVyY2xpY2sgIT0gbnVsbCA/IHRoaXMuaHlwZXJjbGljay5nZXRTdWdnZXN0aW9uKGVkaXRvciwgcG9pbnQpIDogUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xyXG4gIH1cclxuXHJcbiAgZ2V0SW5pdGlhbGl6ZVBhcmFtcygpOiBscy5Jbml0aWFsaXplUGFyYW1zIHtcclxuICAgIGNvbnN0IHJvb3REaXJzOiBBcnJheTxhbnk+ID0gYXRvbS5wcm9qZWN0LmdldERpcmVjdG9yaWVzKCk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBwcm9jZXNzSWQ6IHByb2Nlc3MucGlkLFxyXG4gICAgICBjYXBhYmlsaXRpZXM6IHsgfSxcclxuICAgICAgcm9vdFBhdGg6IHJvb3REaXJzLmxlbmd0aCA+IDAgPyByb290RGlyc1swXS5wYXRoIDogbnVsbFxyXG4gICAgfTtcclxuICB9XHJcbn1cclxuIl19