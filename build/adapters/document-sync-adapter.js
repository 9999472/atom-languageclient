Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _languageclient = require('../languageclient');

var _convert = require('../convert');

var _convert2 = _interopRequireDefault(_convert);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let DocumentSyncAdapter = class DocumentSyncAdapter {

  constructor(languageClient, documentSyncKind) {
    this._disposable = new _atom.CompositeDisposable();
    this._editors = new WeakMap();

    this._lc = languageClient;
    this._documentSyncKind = documentSyncKind;
    this._disposable.add(atom.textEditors.observe(this.observeTextEditors.bind(this)));
  }

  dispose() {
    this._disposable.dispose();
  }

  observeTextEditors(editor) {
    if (!this._editors.has(editor)) {
      const sync = new TextEditorSyncAdapter(editor, this._lc, this._documentSyncKind);
      this._editors.set(editor, sync);
      this._disposable.add(sync);
      this._disposable.add(editor.onDidDestroy(() => {
        this._editors.delete(editor);
        this._disposable.remove(sync);
        sync.dispose();
      }));
    }
  }
};
exports.default = DocumentSyncAdapter;
let TextEditorSyncAdapter = class TextEditorSyncAdapter {

  constructor(editor, languageClient, documentSyncKind) {
    this._disposable = new _atom.CompositeDisposable();
    this._version = 1;

    this._editor = editor;
    this._lc = languageClient;

    const changeTracking = this.setupChangeTracking(documentSyncKind);
    if (changeTracking != null) {
      this._disposable.add(changeTracking);
    }

    this._disposable.add(editor.onDidSave(this.didSave.bind(this)), editor.onDidDestroy(this.didDestroy.bind(this)));

    this.didOpen();
  }

  setupChangeTracking(documentSyncKind) {
    switch (documentSyncKind) {
      case _languageclient.TextDocumentSyncKind.Full:
        return this._editor.onDidChange(this.editorChangeSendFull.bind(this));
      case _languageclient.TextDocumentSyncKind.Incremental:
        return this._editor.getBuffer().onDidChangeText(this.bufferChangeSendIncrement.bind(this));
    }
    return null;
  }

  dispose() {
    this._disposable.dispose();
  }

  getLanguageId() {
    return this._editor.getGrammar().name;
  }

  getVersionedTextDocumentIdentifier() {
    return {
      uri: this.getEditorUri(),
      version: this._version
    };
  }

  didOpen() {
    this._lc.didOpenTextDocument({
      textDocument: {
        uri: this.getEditorUri(),
        languageId: this.getLanguageId().toLowerCase(),
        version: this._version,
        text: this._editor.getText()
      }
    });
  }

  editorChangeSendFull() {
    this._version++;
    this._lc.didChangeTextDocument({
      textDocument: this.getVersionedTextDocumentIdentifier(),
      contentChanges: [{ text: this._editor.getText() }]
    });
  }

  bufferChangeSendIncrement(event) {
    this._version++;
    this._lc.didChangeTextDocument({
      textDocument: this.getVersionedTextDocumentIdentifier(),
      contentChanges: event.changes.map(TextEditorSyncAdapter.changeTextToContentChange)
    });
  }

  static changeTextToContentChange(change) {
    const start = _convert2.default.pointToPosition(change.start);
    const end = { line: change.start.row + change.oldExtent.row, character: change.start.column + change.oldExtent.column };

    return {
      range: { start: start, end: end },
      rangeLength: change.oldExtent.column - change.newExtent.column + change.newText.length, // TODO: Only works if row is the same...
      text: change.newText
    };
  }

  didDestroy() {
    this._lc.didCloseTextDocument({ textDocument: { uri: this.getEditorUri() } });
  }

  didSave() {
    this._lc.didSaveTextDocument({ textDocument: { uri: this.getEditorUri() } });
    this._lc.didChangeWatchedFiles({ changes: [{ uri: this.getEditorUri(), type: _languageclient.FileChangeType.Changed }] });
  }

  getEditorUri() {
    return _convert2.default.pathToUri(this._editor.getURI() || '');
  }
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9hZGFwdGVycy9kb2N1bWVudC1zeW5jLWFkYXB0ZXIuanMiXSwibmFtZXMiOlsiRG9jdW1lbnRTeW5jQWRhcHRlciIsImNvbnN0cnVjdG9yIiwibGFuZ3VhZ2VDbGllbnQiLCJkb2N1bWVudFN5bmNLaW5kIiwiX2Rpc3Bvc2FibGUiLCJfZWRpdG9ycyIsIldlYWtNYXAiLCJfbGMiLCJfZG9jdW1lbnRTeW5jS2luZCIsImFkZCIsImF0b20iLCJ0ZXh0RWRpdG9ycyIsIm9ic2VydmUiLCJvYnNlcnZlVGV4dEVkaXRvcnMiLCJiaW5kIiwiZGlzcG9zZSIsImVkaXRvciIsImhhcyIsInN5bmMiLCJUZXh0RWRpdG9yU3luY0FkYXB0ZXIiLCJzZXQiLCJvbkRpZERlc3Ryb3kiLCJkZWxldGUiLCJyZW1vdmUiLCJfdmVyc2lvbiIsIl9lZGl0b3IiLCJjaGFuZ2VUcmFja2luZyIsInNldHVwQ2hhbmdlVHJhY2tpbmciLCJvbkRpZFNhdmUiLCJkaWRTYXZlIiwiZGlkRGVzdHJveSIsImRpZE9wZW4iLCJGdWxsIiwib25EaWRDaGFuZ2UiLCJlZGl0b3JDaGFuZ2VTZW5kRnVsbCIsIkluY3JlbWVudGFsIiwiZ2V0QnVmZmVyIiwib25EaWRDaGFuZ2VUZXh0IiwiYnVmZmVyQ2hhbmdlU2VuZEluY3JlbWVudCIsImdldExhbmd1YWdlSWQiLCJnZXRHcmFtbWFyIiwibmFtZSIsImdldFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIiLCJ1cmkiLCJnZXRFZGl0b3JVcmkiLCJ2ZXJzaW9uIiwiZGlkT3BlblRleHREb2N1bWVudCIsInRleHREb2N1bWVudCIsImxhbmd1YWdlSWQiLCJ0b0xvd2VyQ2FzZSIsInRleHQiLCJnZXRUZXh0IiwiZGlkQ2hhbmdlVGV4dERvY3VtZW50IiwiY29udGVudENoYW5nZXMiLCJldmVudCIsImNoYW5nZXMiLCJtYXAiLCJjaGFuZ2VUZXh0VG9Db250ZW50Q2hhbmdlIiwiY2hhbmdlIiwic3RhcnQiLCJwb2ludFRvUG9zaXRpb24iLCJlbmQiLCJsaW5lIiwicm93Iiwib2xkRXh0ZW50IiwiY2hhcmFjdGVyIiwiY29sdW1uIiwicmFuZ2UiLCJyYW5nZUxlbmd0aCIsIm5ld0V4dGVudCIsIm5ld1RleHQiLCJsZW5ndGgiLCJkaWRDbG9zZVRleHREb2N1bWVudCIsImRpZFNhdmVUZXh0RG9jdW1lbnQiLCJkaWRDaGFuZ2VXYXRjaGVkRmlsZXMiLCJ0eXBlIiwiQ2hhbmdlZCIsInBhdGhUb1VyaSIsImdldFVSSSJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQTs7QUFFQTs7OztBQUNBOzs7O0lBRXFCQSxtQixHQUFOLE1BQU1BLG1CQUFOLENBQTBCOztBQU12Q0MsY0FBWUMsY0FBWixFQUFzREMsZ0JBQXRELEVBQWdGO0FBQUEsU0FMaEZDLFdBS2dGLEdBTGxFLCtCQUtrRTtBQUFBLFNBSGhGQyxRQUdnRixHQUhwQixJQUFJQyxPQUFKLEVBR29COztBQUM5RSxTQUFLQyxHQUFMLEdBQVdMLGNBQVg7QUFDQSxTQUFLTSxpQkFBTCxHQUF5QkwsZ0JBQXpCO0FBQ0EsU0FBS0MsV0FBTCxDQUFpQkssR0FBakIsQ0FBcUJDLEtBQUtDLFdBQUwsQ0FBaUJDLE9BQWpCLENBQXlCLEtBQUtDLGtCQUFMLENBQXdCQyxJQUF4QixDQUE2QixJQUE3QixDQUF6QixDQUFyQjtBQUNEOztBQUVEQyxZQUFnQjtBQUNkLFNBQUtYLFdBQUwsQ0FBaUJXLE9BQWpCO0FBQ0Q7O0FBRURGLHFCQUFtQkcsTUFBbkIsRUFBa0Q7QUFDaEQsUUFBSSxDQUFDLEtBQUtYLFFBQUwsQ0FBY1ksR0FBZCxDQUFrQkQsTUFBbEIsQ0FBTCxFQUFnQztBQUM5QixZQUFNRSxPQUFPLElBQUlDLHFCQUFKLENBQTBCSCxNQUExQixFQUFrQyxLQUFLVCxHQUF2QyxFQUE0QyxLQUFLQyxpQkFBakQsQ0FBYjtBQUNBLFdBQUtILFFBQUwsQ0FBY2UsR0FBZCxDQUFrQkosTUFBbEIsRUFBMEJFLElBQTFCO0FBQ0EsV0FBS2QsV0FBTCxDQUFpQkssR0FBakIsQ0FBcUJTLElBQXJCO0FB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IiwiZmlsZSI6ImRvY3VtZW50LXN5bmMtYWRhcHRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB7TGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uLCBGaWxlQ2hhbmdlVHlwZSwgVGV4dERvY3VtZW50U3luY0tpbmR9IGZyb20gJy4uL2xhbmd1YWdlY2xpZW50JztcbmltcG9ydCB0eXBlIHtUZXh0RG9jdW1lbnRDb250ZW50Q2hhbmdlRXZlbnQsIFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXJ9IGZyb20gJy4uL2xhbmd1YWdlY2xpZW50JztcbmltcG9ydCBDb252ZXJ0IGZyb20gJy4uL2NvbnZlcnQnO1xuaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tICdhdG9tJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRG9jdW1lbnRTeW5jQWRhcHRlciB7XG4gIF9kaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcbiAgX2RvY3VtZW50U3luY0tpbmQ6IG51bWJlcjtcbiAgX2VkaXRvcnM6IFdlYWtNYXA8YXRvbSRUZXh0RWRpdG9yLCBUZXh0RWRpdG9yU3luY0FkYXB0ZXI+ID0gbmV3IFdlYWtNYXAoKTtcbiAgX2xjOiBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb247XG5cbiAgY29uc3RydWN0b3IobGFuZ3VhZ2VDbGllbnQ6IExhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbiwgZG9jdW1lbnRTeW5jS2luZDogbnVtYmVyKSB7XG4gICAgdGhpcy5fbGMgPSBsYW5ndWFnZUNsaWVudDtcbiAgICB0aGlzLl9kb2N1bWVudFN5bmNLaW5kID0gZG9jdW1lbnRTeW5jS2luZDtcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChhdG9tLnRleHRFZGl0b3JzLm9ic2VydmUodGhpcy5vYnNlcnZlVGV4dEVkaXRvcnMuYmluZCh0aGlzKSkpO1xuICB9XG5cbiAgZGlzcG9zZSgpOiB2b2lkIHtcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcbiAgfVxuXG4gIG9ic2VydmVUZXh0RWRpdG9ycyhlZGl0b3I6IGF0b20kVGV4dEVkaXRvcik6IHZvaWQge1xuICAgIGlmICghdGhpcy5fZWRpdG9ycy5oYXMoZWRpdG9yKSkge1xuICAgICAgY29uc3Qgc3luYyA9IG5ldyBUZXh0RWRpdG9yU3luY0FkYXB0ZXIoZWRpdG9yLCB0aGlzLl9sYywgdGhpcy5fZG9jdW1lbnRTeW5jS2luZCk7XG4gICAgICB0aGlzLl9lZGl0b3JzLnNldChlZGl0b3IsIHN5bmMpO1xuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoc3luYyk7XG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChlZGl0b3Iub25EaWREZXN0cm95KCgpID0+IHtcbiAgICAgICAgdGhpcy5fZWRpdG9ycy5kZWxldGUoZWRpdG9yKTtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5yZW1vdmUoc3luYyk7XG4gICAgICAgIHN5bmMuZGlzcG9zZSgpO1xuICAgICAgfSkpO1xuICAgIH1cbiAgfVxufVxuXG5jbGFzcyBUZXh0RWRpdG9yU3luY0FkYXB0ZXIge1xuICBfZGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gIF9lZGl0b3I6IGF0b20kVGV4dEVkaXRvcjtcbiAgX2xjOiBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb247XG4gIF92ZXJzaW9uID0gMTtcblxuICBjb25zdHJ1Y3RvcihlZGl0b3I6IGF0b20kVGV4dEVkaXRvciwgbGFuZ3VhZ2VDbGllbnQ6IExhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbiwgZG9jdW1lbnRTeW5jS2luZDogbnVtYmVyKSB7XG4gICAgdGhpcy5fZWRpdG9yID0gZWRpdG9yO1xuICAgIHRoaXMuX2xjID0gbGFuZ3VhZ2VDbGllbnQ7XG5cbiAgICBjb25zdCBjaGFuZ2VUcmFja2luZyA9IHRoaXMuc2V0dXBDaGFuZ2VUcmFja2luZyhkb2N1bWVudFN5bmNLaW5kKTtcbiAgICBpZiAoY2hhbmdlVHJhY2tpbmcgIT0gbnVsbCkge1xuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoY2hhbmdlVHJhY2tpbmcpO1xuICAgIH1cblxuICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKFxuICAgICAgZWRpdG9yLm9uRGlkU2F2ZSh0aGlzLmRpZFNhdmUuYmluZCh0aGlzKSksXG4gICAgICBlZGl0b3Iub25EaWREZXN0cm95KHRoaXMuZGlkRGVzdHJveS5iaW5kKHRoaXMpKSxcbiAgICApO1xuXG4gICAgdGhpcy5kaWRPcGVuKCk7XG4gIH1cblxuICBzZXR1cENoYW5nZVRyYWNraW5nKGRvY3VtZW50U3luY0tpbmQ6IG51bWJlcik6ID9JRGlzcG9zYWJsZSB7XG4gICAgc3dpdGNoIChkb2N1bWVudFN5bmNLaW5kKSB7XG4gICAgICBjYXNlIFRleHREb2N1bWVudFN5bmNLaW5kLkZ1bGw6XG4gICAgICAgIHJldHVybiB0aGlzLl9lZGl0b3Iub25EaWRDaGFuZ2UodGhpcy5lZGl0b3JDaGFuZ2VTZW5kRnVsbC5iaW5kKHRoaXMpKTtcbiAgICAgIGNhc2UgVGV4dERvY3VtZW50U3luY0tpbmQuSW5jcmVtZW50YWw6XG4gICAgICAgIHJldHVybiB0aGlzLl9lZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRDaGFuZ2VUZXh0KHRoaXMuYnVmZmVyQ2hhbmdlU2VuZEluY3JlbWVudC5iaW5kKHRoaXMpKTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBkaXNwb3NlKCk6IHZvaWQge1xuICAgIHRoaXMuX2Rpc3Bvc2FibGUuZGlzcG9zZSgpO1xuICB9XG5cbiAgZ2V0TGFuZ3VhZ2VJZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9lZGl0b3IuZ2V0R3JhbW1hcigpLm5hbWU7XG4gIH1cblxuICBnZXRWZXJzaW9uZWRUZXh0RG9jdW1lbnRJZGVudGlmaWVyKCk6IFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIge1xuICAgIHJldHVybiB7XG4gICAgICB1cmk6IHRoaXMuZ2V0RWRpdG9yVXJpKCksXG4gICAgICB2ZXJzaW9uOiB0aGlzLl92ZXJzaW9uXG4gICAgfTtcbiAgfVxuXG4gIGRpZE9wZW4oKTogdm9pZCB7XG4gICAgdGhpcy5fbGMuZGlkT3BlblRleHREb2N1bWVudCh7XG4gICAgICB0ZXh0RG9jdW1lbnQ6IHtcbiAgICAgICAgdXJpOiB0aGlzLmdldEVkaXRvclVyaSgpLFxuICAgICAgICBsYW5ndWFnZUlkOiB0aGlzLmdldExhbmd1YWdlSWQoKS50b0xvd2VyQ2FzZSgpLFxuICAgICAgICB2ZXJzaW9uOiB0aGlzLl92ZXJzaW9uLFxuICAgICAgICB0ZXh0OiB0aGlzLl9lZGl0b3IuZ2V0VGV4dCgpXG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBlZGl0b3JDaGFuZ2VTZW5kRnVsbCgpOiB2b2lkIHtcbiAgICB0aGlzLl92ZXJzaW9uKys7XG4gICAgdGhpcy5fbGMuZGlkQ2hhbmdlVGV4dERvY3VtZW50KHtcbiAgICAgIHRleHREb2N1bWVudDogdGhpcy5nZXRWZXJzaW9uZWRUZXh0RG9jdW1lbnRJZGVudGlmaWVyKCksXG4gICAgICBjb250ZW50Q2hhbmdlczogWyB7IHRleHQ6IHRoaXMuX2VkaXRvci5nZXRUZXh0KCkgfSBdXG4gICAgfSk7XG4gIH1cblxuICBidWZmZXJDaGFuZ2VTZW5kSW5jcmVtZW50KGV2ZW50OiBhdG9tJENoYW5nZVRleHRFdmVudCk6IHZvaWQge1xuICAgIHRoaXMuX3ZlcnNpb24rKztcbiAgICB0aGlzLl9sYy5kaWRDaGFuZ2VUZXh0RG9jdW1lbnQoe1xuICAgICAgdGV4dERvY3VtZW50OiB0aGlzLmdldFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIoKSxcbiAgICAgIGNvbnRlbnRDaGFuZ2VzOiBldmVudC5jaGFuZ2VzLm1hcChUZXh0RWRpdG9yU3luY0FkYXB0ZXIuY2hhbmdlVGV4dFRvQ29udGVudENoYW5nZSlcbiAgICB9KTtcbiAgfVxuXG4gIHN0YXRpYyBjaGFuZ2VUZXh0VG9Db250ZW50Q2hhbmdlKGNoYW5nZTogYXRvbSRDaGFuZ2VUZXh0KTogVGV4dERvY3VtZW50Q29udGVudENoYW5nZUV2ZW50IHtcbiAgICBjb25zdCBzdGFydCA9IENvbnZlcnQucG9pbnRUb1Bvc2l0aW9uKGNoYW5nZS5zdGFydCk7XG4gICAgY29uc3QgZW5kID0geyBsaW5lOiBjaGFuZ2Uuc3RhcnQucm93ICsgY2hhbmdlLm9sZEV4dGVudC5yb3csIGNoYXJhY3RlcjogY2hhbmdlLnN0YXJ0LmNvbHVtbiArIGNoYW5nZS5vbGRFeHRlbnQuY29sdW1uIH07XG5cbiAgICByZXR1cm4ge1xuICAgICAgcmFuZ2U6IHsgc3RhcnQ6IHN0YXJ0LCBlbmQ6IGVuZCB9LFxuICAgICAgcmFuZ2VMZW5ndGg6IGNoYW5nZS5vbGRFeHRlbnQuY29sdW1uIC0gY2hhbmdlLm5ld0V4dGVudC5jb2x1bW4gKyBjaGFuZ2UubmV3VGV4dC5sZW5ndGgsIC8vIFRPRE86IE9ubHkgd29ya3MgaWYgcm93IGlzIHRoZSBzYW1lLi4uXG4gICAgICB0ZXh0OiBjaGFuZ2UubmV3VGV4dFxuICAgIH07XG4gIH1cblxuICBkaWREZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuX2xjLmRpZENsb3NlVGV4dERvY3VtZW50KHsgdGV4dERvY3VtZW50OiB7IHVyaTogdGhpcy5nZXRFZGl0b3JVcmkoKSB9IH0pO1xuICB9XG5cbiAgZGlkU2F2ZSgpOiB2b2lkIHtcbiAgICB0aGlzLl9sYy5kaWRTYXZlVGV4dERvY3VtZW50KHsgdGV4dERvY3VtZW50OiB7IHVyaTogdGhpcy5nZXRFZGl0b3JVcmkoKSB9IH0pO1xuICAgIHRoaXMuX2xjLmRpZENoYW5nZVdhdGNoZWRGaWxlcyh7IGNoYW5nZXM6IFsgeyB1cmk6IHRoaXMuZ2V0RWRpdG9yVXJpKCksIHR5cGU6IEZpbGVDaGFuZ2VUeXBlLkNoYW5nZWQgfSBdfSk7XG4gIH1cblxuICBnZXRFZGl0b3JVcmkoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gQ29udmVydC5wYXRoVG9VcmkodGhpcy5fZWRpdG9yLmdldFVSSSgpIHx8ICcnKTtcbiAgfVxufVxuIl19