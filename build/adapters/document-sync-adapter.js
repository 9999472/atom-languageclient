Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _languageclient = require('../languageclient');

var _convert = require('../convert');

var _convert2 = _interopRequireDefault(_convert);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let DocumentSyncAdapter = class DocumentSyncAdapter {

  constructor(languageClient, documentSyncKind) {
    this._disposable = new _atom.CompositeDisposable();
    this._editors = new WeakMap();

    this._lc = languageClient;
    this._documentSyncKind = documentSyncKind;
    this._disposable.add(atom.textEditors.observe(this.observeTextEditors.bind(this)));
  }

  dispose() {
    this._disposable.dispose();
  }

  observeTextEditors(editor) {
    if (!this._editors.has(editor)) {
      const sync = new TextEditorSyncAdapter(editor, this._lc, this._documentSyncKind);
      this._editors.set(editor, sync);
      this._disposable.add(sync);
      this._disposable.add(editor.onDidDestroy(() => {
        this._editors.delete(editor);
        this._disposable.remove(sync);
        sync.dispose();
      }));
    }
  }
};
exports.default = DocumentSyncAdapter;
let TextEditorSyncAdapter = class TextEditorSyncAdapter {

  constructor(editor, languageClient, documentSyncKind) {
    this._disposable = new _atom.CompositeDisposable();
    this._version = 1;

    this._editor = editor;
    this._lc = languageClient;

    const changeTracking = this.setupChangeTracking(documentSyncKind);
    if (changeTracking != null) {
      this._disposable.add(changeTracking);
    }

    this._disposable.add(editor.onDidSave(this.didSave.bind(this)), editor.onDidDestroy(this.didDestroy.bind(this)));

    this.didOpen();
  }

  setupChangeTracking(documentSyncKind) {
    switch (documentSyncKind) {
      case _languageclient.TextDocumentSyncKind.Full:
        return this._editor.onDidChange(this.editorChangeSendFull.bind(this));
      case _languageclient.TextDocumentSyncKind.Incremental:
        return this._editor.getBuffer().onDidChangeText(this.bufferChangeSendIncrement.bind(this));
    }
    return null;
  }

  dispose() {
    this._disposable.dispose();
  }

  getLanguageId() {
    return this._editor.getGrammar().name;
  }

  getVersionedTextDocumentIdentifier() {
    return {
      uri: this.getEditorUri(),
      version: this._version
    };
  }

  didOpen() {
    this._lc.didOpenTextDocument({
      textDocument: {
        uri: this.getEditorUri(),
        languageId: this.getLanguageId().toLowerCase(),
        version: this._version,
        text: this._editor.getText()
      }
    });
  }

  editorChangeSendFull() {
    this._version++;
    this._lc.didChangeTextDocument({
      textDocument: this.getVersionedTextDocumentIdentifier(),
      contentChanges: [{ text: this._editor.getText() }]
    });
  }

  bufferChangeSendIncrement(event) {
    this._version++;
    this._lc.didChangeTextDocument({
      textDocument: this.getVersionedTextDocumentIdentifier(),
      contentChanges: event.changes.map(TextEditorSyncAdapter.changeTextToContentChange)
    });
  }

  static changeTextToContentChange(change) {
    const start = _convert2.default.pointToPosition(change.start);
    const end = { line: change.start.row + change.oldExtent.row, character: change.start.column + change.oldExtent.column };

    return {
      range: { start: start, end: end },
      rangeLength: change.oldExtent.column - change.newExtent.column + change.newText.length, // TODO: Only works if row is the same...
      text: change.newText
    };
  }

  didDestroy() {
    this._lc.didCloseTextDocument({ textDocument: { uri: this.getEditorUri() } });
  }

  didSave() {
    this._lc.didSaveTextDocument({ textDocument: { uri: this.getEditorUri() } });
    this._lc.didChangeWatchedFiles({ changes: [{ uri: this.getEditorUri(), type: _languageclient.FileChangeType.Changed }] });
  }

  getEditorUri() {
    return _convert2.default.pathToUri(this._editor.getURI() || '');
  }
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9hZGFwdGVycy9kb2N1bWVudC1zeW5jLWFkYXB0ZXIuanMiXSwibmFtZXMiOlsiRG9jdW1lbnRTeW5jQWRhcHRlciIsImNvbnN0cnVjdG9yIiwibGFuZ3VhZ2VDbGllbnQiLCJkb2N1bWVudFN5bmNLaW5kIiwiX2Rpc3Bvc2FibGUiLCJfZWRpdG9ycyIsIldlYWtNYXAiLCJfbGMiLCJfZG9jdW1lbnRTeW5jS2luZCIsImFkZCIsImF0b20iLCJ0ZXh0RWRpdG9ycyIsIm9ic2VydmUiLCJvYnNlcnZlVGV4dEVkaXRvcnMiLCJiaW5kIiwiZGlzcG9zZSIsImVkaXRvciIsImhhcyIsInN5bmMiLCJUZXh0RWRpdG9yU3luY0FkYXB0ZXIiLCJzZXQiLCJvbkRpZERlc3Ryb3kiLCJkZWxldGUiLCJyZW1vdmUiLCJfdmVyc2lvbiIsIl9lZGl0b3IiLCJjaGFuZ2VUcmFja2luZyIsInNldHVwQ2hhbmdlVHJhY2tpbmciLCJvbkRpZFNhdmUiLCJkaWRTYXZlIiwiZGlkRGVzdHJveSIsImRpZE9wZW4iLCJGdWxsIiwib25EaWRDaGFuZ2UiLCJlZGl0b3JDaGFuZ2VTZW5kRnVsbCIsIkluY3JlbWVudGFsIiwiZ2V0QnVmZmVyIiwib25EaWRDaGFuZ2VUZXh0IiwiYnVmZmVyQ2hhbmdlU2VuZEluY3JlbWVudCIsImdldExhbmd1YWdlSWQiLCJnZXRHcmFtbWFyIiwibmFtZSIsImdldFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIiLCJ1cmkiLCJnZXRFZGl0b3JVcmkiLCJ2ZXJzaW9uIiwiZGlkT3BlblRleHREb2N1bWVudCIsInRleHREb2N1bWVudCIsImxhbmd1YWdlSWQiLCJ0b0xvd2VyQ2FzZSIsInRleHQiLCJnZXRUZXh0IiwiZGlkQ2hhbmdlVGV4dERvY3VtZW50IiwiY29udGVudENoYW5nZXMiLCJldmVudCIsImNoYW5nZXMiLCJtYXAiLCJjaGFuZ2VUZXh0VG9Db250ZW50Q2hhbmdlIiwiY2hhbmdlIiwic3RhcnQiLCJwb2ludFRvUG9zaXRpb24iLCJlbmQiLCJsaW5lIiwicm93Iiwib2xkRXh0ZW50IiwiY2hhcmFjdGVyIiwiY29sdW1uIiwicmFuZ2UiLCJyYW5nZUxlbmd0aCIsIm5ld0V4dGVudCIsIm5ld1RleHQiLCJsZW5ndGgiLCJkaWRDbG9zZVRleHREb2N1bWVudCIsImRpZFNhdmVUZXh0RG9jdW1lbnQiLCJkaWRDaGFuZ2VXYXRjaGVkRmlsZXMiLCJ0eXBlIiwiQ2hhbmdlZCIsInBhdGhUb1VyaSIsImdldFVSSSJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQTs7QUFFQTs7OztBQUNBOzs7O0lBRXFCQSxtQixHQUFOLE1BQU1BLG1CQUFOLENBQTBCOztBQU12Q0MsY0FBWUMsY0FBWixFQUFzREMsZ0JBQXRELEVBQWdGO0FBQUEsU0FMaEZDLFdBS2dGLEdBTGxFLCtCQUtrRTtBQUFBLFNBSGhGQyxRQUdnRixHQUhwQixJQUFJQyxPQUFKLEVBR29COztBQUM5RSxTQUFLQyxHQUFMLEdBQVdMLGNBQVg7QUFDQSxTQUFLTSxpQkFBTCxHQUF5QkwsZ0JBQXpCO0FBQ0EsU0FBS0MsV0FBTCxDQUFpQkssR0FBakIsQ0FBcUJDLEtBQUtDLFdBQUwsQ0FBaUJDLE9BQWpCLENBQXlCLEtBQUtDLGtCQUFMLENBQXdCQyxJQUF4QixDQUE2QixJQUE3QixDQUF6QixDQUFyQjtBQUNEOztBQUVEQyxZQUFnQjtBQUNkLFNBQUtYLFdBQUwsQ0FBaUJXLE9BQWpCO0FBQ0Q7O0FBRURGLHFCQUFtQkcsTUFBbkIsRUFBa0Q7QUFDaEQsUUFBSSxDQUFDLEtBQUtYLFFBQUwsQ0FBY1ksR0FBZCxDQUFrQkQsTUFBbEIsQ0FBTCxFQUFnQztBQUM5QixZQUFNRSxPQUFPLElBQUlDLHFCQUFKLENBQTBCSCxNQUExQixFQUFrQyxLQUFLVCxHQUF2QyxFQUE0QyxLQUFLQyxpQkFBakQsQ0FBYjtBQUNBLFdBQUtILFFBQUwsQ0FBY2UsR0FBZCxDQUFrQkosTUFBbEIsRUFBMEJFLElBQTFCO0FBQ0EsV0FBS2QsV0FBTCxDQUFpQkssR0FBakIsQ0FBcUJTLElBQXJCO0FB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IiwiZmlsZSI6ImRvY3VtZW50LXN5bmMtYWRhcHRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XHJcblxyXG5pbXBvcnQge0xhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbiwgRmlsZUNoYW5nZVR5cGUsIFRleHREb2N1bWVudFN5bmNLaW5kfSBmcm9tICcuLi9sYW5ndWFnZWNsaWVudCc7XHJcbmltcG9ydCB0eXBlIHtUZXh0RG9jdW1lbnRDb250ZW50Q2hhbmdlRXZlbnQsIFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXJ9IGZyb20gJy4uL2xhbmd1YWdlY2xpZW50JztcclxuaW1wb3J0IENvbnZlcnQgZnJvbSAnLi4vY29udmVydCc7XHJcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEb2N1bWVudFN5bmNBZGFwdGVyIHtcclxuICBfZGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XHJcbiAgX2RvY3VtZW50U3luY0tpbmQ6IG51bWJlcjtcclxuICBfZWRpdG9yczogV2Vha01hcDxhdG9tJFRleHRFZGl0b3IsIFRleHRFZGl0b3JTeW5jQWRhcHRlcj4gPSBuZXcgV2Vha01hcCgpO1xyXG4gIF9sYzogTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uO1xyXG5cclxuICBjb25zdHJ1Y3RvcihsYW5ndWFnZUNsaWVudDogTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uLCBkb2N1bWVudFN5bmNLaW5kOiBudW1iZXIpIHtcclxuICAgIHRoaXMuX2xjID0gbGFuZ3VhZ2VDbGllbnQ7XHJcbiAgICB0aGlzLl9kb2N1bWVudFN5bmNLaW5kID0gZG9jdW1lbnRTeW5jS2luZDtcclxuICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKGF0b20udGV4dEVkaXRvcnMub2JzZXJ2ZSh0aGlzLm9ic2VydmVUZXh0RWRpdG9ycy5iaW5kKHRoaXMpKSk7XHJcbiAgfVxyXG5cclxuICBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5fZGlzcG9zYWJsZS5kaXNwb3NlKCk7XHJcbiAgfVxyXG5cclxuICBvYnNlcnZlVGV4dEVkaXRvcnMoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy5fZWRpdG9ycy5oYXMoZWRpdG9yKSkge1xyXG4gICAgICBjb25zdCBzeW5jID0gbmV3IFRleHRFZGl0b3JTeW5jQWRhcHRlcihlZGl0b3IsIHRoaXMuX2xjLCB0aGlzLl9kb2N1bWVudFN5bmNLaW5kKTtcclxuICAgICAgdGhpcy5fZWRpdG9ycy5zZXQoZWRpdG9yLCBzeW5jKTtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoc3luYyk7XHJcbiAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKGVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuX2VkaXRvcnMuZGVsZXRlKGVkaXRvcik7XHJcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5yZW1vdmUoc3luYyk7XHJcbiAgICAgICAgc3luYy5kaXNwb3NlKCk7XHJcbiAgICAgIH0pKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmNsYXNzIFRleHRFZGl0b3JTeW5jQWRhcHRlciB7XHJcbiAgX2Rpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xyXG4gIF9lZGl0b3I6IGF0b20kVGV4dEVkaXRvcjtcclxuICBfbGM6IExhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbjtcclxuICBfdmVyc2lvbiA9IDE7XHJcblxyXG4gIGNvbnN0cnVjdG9yKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLCBsYW5ndWFnZUNsaWVudDogTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uLCBkb2N1bWVudFN5bmNLaW5kOiBudW1iZXIpIHtcclxuICAgIHRoaXMuX2VkaXRvciA9IGVkaXRvcjtcclxuICAgIHRoaXMuX2xjID0gbGFuZ3VhZ2VDbGllbnQ7XHJcblxyXG4gICAgY29uc3QgY2hhbmdlVHJhY2tpbmcgPSB0aGlzLnNldHVwQ2hhbmdlVHJhY2tpbmcoZG9jdW1lbnRTeW5jS2luZCk7XHJcbiAgICBpZiAoY2hhbmdlVHJhY2tpbmcgIT0gbnVsbCkge1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChjaGFuZ2VUcmFja2luZyk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoXHJcbiAgICAgIGVkaXRvci5vbkRpZFNhdmUodGhpcy5kaWRTYXZlLmJpbmQodGhpcykpLFxyXG4gICAgICBlZGl0b3Iub25EaWREZXN0cm95KHRoaXMuZGlkRGVzdHJveS5iaW5kKHRoaXMpKSxcclxuICAgICk7XHJcblxyXG4gICAgdGhpcy5kaWRPcGVuKCk7XHJcbiAgfVxyXG5cclxuICBzZXR1cENoYW5nZVRyYWNraW5nKGRvY3VtZW50U3luY0tpbmQ6IG51bWJlcik6ID9JRGlzcG9zYWJsZSB7XHJcbiAgICBzd2l0Y2ggKGRvY3VtZW50U3luY0tpbmQpIHtcclxuICAgICAgY2FzZSBUZXh0RG9jdW1lbnRTeW5jS2luZC5GdWxsOlxyXG4gICAgICAgIHJldHVybiB0aGlzLl9lZGl0b3Iub25EaWRDaGFuZ2UodGhpcy5lZGl0b3JDaGFuZ2VTZW5kRnVsbC5iaW5kKHRoaXMpKTtcclxuICAgICAgY2FzZSBUZXh0RG9jdW1lbnRTeW5jS2luZC5JbmNyZW1lbnRhbDpcclxuICAgICAgICByZXR1cm4gdGhpcy5fZWRpdG9yLmdldEJ1ZmZlcigpLm9uRGlkQ2hhbmdlVGV4dCh0aGlzLmJ1ZmZlckNoYW5nZVNlbmRJbmNyZW1lbnQuYmluZCh0aGlzKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIGdldExhbmd1YWdlSWQoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLl9lZGl0b3IuZ2V0R3JhbW1hcigpLm5hbWU7XHJcbiAgfVxyXG5cclxuICBnZXRWZXJzaW9uZWRUZXh0RG9jdW1lbnRJZGVudGlmaWVyKCk6IFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdXJpOiB0aGlzLmdldEVkaXRvclVyaSgpLFxyXG4gICAgICB2ZXJzaW9uOiB0aGlzLl92ZXJzaW9uXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgZGlkT3BlbigpOiB2b2lkIHtcclxuICAgIHRoaXMuX2xjLmRpZE9wZW5UZXh0RG9jdW1lbnQoe1xyXG4gICAgICB0ZXh0RG9jdW1lbnQ6IHtcclxuICAgICAgICB1cmk6IHRoaXMuZ2V0RWRpdG9yVXJpKCksXHJcbiAgICAgICAgbGFuZ3VhZ2VJZDogdGhpcy5nZXRMYW5ndWFnZUlkKCkudG9Mb3dlckNhc2UoKSxcclxuICAgICAgICB2ZXJzaW9uOiB0aGlzLl92ZXJzaW9uLFxyXG4gICAgICAgIHRleHQ6IHRoaXMuX2VkaXRvci5nZXRUZXh0KClcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBlZGl0b3JDaGFuZ2VTZW5kRnVsbCgpOiB2b2lkIHtcclxuICAgIHRoaXMuX3ZlcnNpb24rKztcclxuICAgIHRoaXMuX2xjLmRpZENoYW5nZVRleHREb2N1bWVudCh7XHJcbiAgICAgIHRleHREb2N1bWVudDogdGhpcy5nZXRWZXJzaW9uZWRUZXh0RG9jdW1lbnRJZGVudGlmaWVyKCksXHJcbiAgICAgIGNvbnRlbnRDaGFuZ2VzOiBbIHsgdGV4dDogdGhpcy5fZWRpdG9yLmdldFRleHQoKSB9IF1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgYnVmZmVyQ2hhbmdlU2VuZEluY3JlbWVudChldmVudDogYXRvbSRDaGFuZ2VUZXh0RXZlbnQpOiB2b2lkIHtcclxuICAgIHRoaXMuX3ZlcnNpb24rKztcclxuICAgIHRoaXMuX2xjLmRpZENoYW5nZVRleHREb2N1bWVudCh7XHJcbiAgICAgIHRleHREb2N1bWVudDogdGhpcy5nZXRWZXJzaW9uZWRUZXh0RG9jdW1lbnRJZGVudGlmaWVyKCksXHJcbiAgICAgIGNvbnRlbnRDaGFuZ2VzOiBldmVudC5jaGFuZ2VzLm1hcChUZXh0RWRpdG9yU3luY0FkYXB0ZXIuY2hhbmdlVGV4dFRvQ29udGVudENoYW5nZSlcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGNoYW5nZVRleHRUb0NvbnRlbnRDaGFuZ2UoY2hhbmdlOiBhdG9tJENoYW5nZVRleHQpOiBUZXh0RG9jdW1lbnRDb250ZW50Q2hhbmdlRXZlbnQge1xyXG4gICAgY29uc3Qgc3RhcnQgPSBDb252ZXJ0LnBvaW50VG9Qb3NpdGlvbihjaGFuZ2Uuc3RhcnQpO1xyXG4gICAgY29uc3QgZW5kID0geyBsaW5lOiBjaGFuZ2Uuc3RhcnQucm93ICsgY2hhbmdlLm9sZEV4dGVudC5yb3csIGNoYXJhY3RlcjogY2hhbmdlLnN0YXJ0LmNvbHVtbiArIGNoYW5nZS5vbGRFeHRlbnQuY29sdW1uIH07XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgcmFuZ2U6IHsgc3RhcnQ6IHN0YXJ0LCBlbmQ6IGVuZCB9LFxyXG4gICAgICByYW5nZUxlbmd0aDogY2hhbmdlLm9sZEV4dGVudC5jb2x1bW4gLSBjaGFuZ2UubmV3RXh0ZW50LmNvbHVtbiArIGNoYW5nZS5uZXdUZXh0Lmxlbmd0aCwgLy8gVE9ETzogT25seSB3b3JrcyBpZiByb3cgaXMgdGhlIHNhbWUuLi5cclxuICAgICAgdGV4dDogY2hhbmdlLm5ld1RleHRcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBkaWREZXN0cm95KCk6IHZvaWQge1xyXG4gICAgdGhpcy5fbGMuZGlkQ2xvc2VUZXh0RG9jdW1lbnQoeyB0ZXh0RG9jdW1lbnQ6IHsgdXJpOiB0aGlzLmdldEVkaXRvclVyaSgpIH0gfSk7XHJcbiAgfVxyXG5cclxuICBkaWRTYXZlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5fbGMuZGlkU2F2ZVRleHREb2N1bWVudCh7IHRleHREb2N1bWVudDogeyB1cmk6IHRoaXMuZ2V0RWRpdG9yVXJpKCkgfSB9KTtcclxuICAgIHRoaXMuX2xjLmRpZENoYW5nZVdhdGNoZWRGaWxlcyh7IGNoYW5nZXM6IFsgeyB1cmk6IHRoaXMuZ2V0RWRpdG9yVXJpKCksIHR5cGU6IEZpbGVDaGFuZ2VUeXBlLkNoYW5nZWQgfSBdfSk7XHJcbiAgfVxyXG5cclxuICBnZXRFZGl0b3JVcmkoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBDb252ZXJ0LnBhdGhUb1VyaSh0aGlzLl9lZGl0b3IuZ2V0VVJJKCkgfHwgJycpO1xyXG4gIH1cclxufVxyXG4iXX0=