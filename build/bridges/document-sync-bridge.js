Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _languageclientV = require('../protocol/languageclient-v2');

var _convert = require('../convert');

var _convert2 = _interopRequireDefault(_convert);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let DocumentSyncBridge = class DocumentSyncBridge {

  constructor(languageClient, documentSyncKind) {
    this._disposable = new _atom.CompositeDisposable();
    this._editors = new WeakMap();

    this._lc = languageClient;
    this._documentSyncKind = documentSyncKind;
    this._disposable.add(atom.textEditors.observe(this.observeTextEditors.bind(this)));
  }

  dispose() {
    this._disposable.dispose();
  }

  observeTextEditors(editor) {
    if (!this._editors.has(editor)) {
      const sync = new TextEditorSyncBridge(editor, this._lc, this._documentSyncKind);
      this._editors.set(editor, sync);
      this._disposable.add(sync);
      this._disposable.add(editor.onDidDestroy(() => {
        this._editors.delete(editor);
        this._disposable.remove(sync);
        sync.dispose();
      }));
    }
  }
};
exports.default = DocumentSyncBridge;
let TextEditorSyncBridge = class TextEditorSyncBridge {

  constructor(editor, languageClient, documentSyncKind) {
    this._disposable = new _atom.CompositeDisposable();
    this._version = 1;

    this._editor = editor;
    this._lc = languageClient;

    const changeTracking = this.setupChangeTracking(documentSyncKind);
    if (changeTracking != null) {
      this._disposable.add(changeTracking);
    }

    this._disposable.add(editor.onDidSave(this.didSave.bind(this)), editor.onDidDestroy(this.didDestroy.bind(this)));

    this.didOpen();
  }

  setupChangeTracking(documentSyncKind) {
    switch (documentSyncKind) {
      case _languageclientV.TextDocumentSyncKind.Full:
        return this._editor.onDidChange(this.editorChangeSendFull.bind(this));
      case _languageclientV.TextDocumentSyncKind.Incremental:
        return this._editor.getBuffer().onDidChangeText(this.bufferChangeSendIncrement.bind(this));
    }
    return null;
  }

  dispose() {
    this._disposable.dispose();
  }

  getLanguageId() {
    return this._editor.getGrammar().name;
  }

  getVersionedTextDocumentIdentifier() {
    return {
      uri: this.getEditorUri(),
      version: this._version
    };
  }

  didOpen() {
    this._lc.didOpenTextDocument({
      textDocument: {
        uri: this.getEditorUri(),
        languageId: this.getLanguageId().toLowerCase(),
        version: this._version,
        text: this._editor.getText()
      }
    });
  }

  editorChangeSendFull() {
    this._version++;
    this._lc.didChangeTextDocument({
      textDocument: this.getVersionedTextDocumentIdentifier(),
      contentChanges: [{ text: this._editor.getText() }]
    });
  }

  bufferChangeSendIncrement(event) {
    this._version++;
    this._lc.didChangeTextDocument({
      textDocument: this.getVersionedTextDocumentIdentifier(),
      contentChanges: event.changes.map(TextEditorSyncBridge.changeTextToContentChange)
    });
  }

  static changeTextToContentChange(change) {
    const start = _convert2.default.pointToPosition(change.start);
    const end = { line: change.start.row + change.oldExtent.row, character: change.start.column + change.oldExtent.column };

    return {
      range: { start: start, end: end },
      rangeLength: change.oldExtent.column - change.newExtent.column + change.newText.length, // TODO: Only works if row is the same...
      text: change.newText
    };
  }

  didDestroy() {
    this._lc.didCloseTextDocument({ textDocument: { uri: this.getEditorUri() } });
  }

  didSave() {
    this._lc.didSaveTextDocument({ textDocument: { uri: this.getEditorUri() } });
    this._lc.didChangeWatchedFiles({ changes: [{ uri: this.getEditorUri(), type: _languageclientV.FileChangeType.Changed }] });
  }

  getEditorUri() {
    return _convert2.default.pathToUri(this._editor.getURI() || '');
  }
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9icmlkZ2VzL2RvY3VtZW50LXN5bmMtYnJpZGdlLmpzIl0sIm5hbWVzIjpbIkRvY3VtZW50U3luY0JyaWRnZSIsImNvbnN0cnVjdG9yIiwibGFuZ3VhZ2VDbGllbnQiLCJkb2N1bWVudFN5bmNLaW5kIiwiX2Rpc3Bvc2FibGUiLCJfZWRpdG9ycyIsIldlYWtNYXAiLCJfbGMiLCJfZG9jdW1lbnRTeW5jS2luZCIsImFkZCIsImF0b20iLCJ0ZXh0RWRpdG9ycyIsIm9ic2VydmUiLCJvYnNlcnZlVGV4dEVkaXRvcnMiLCJiaW5kIiwiZGlzcG9zZSIsImVkaXRvciIsImhhcyIsInN5bmMiLCJUZXh0RWRpdG9yU3luY0JyaWRnZSIsInNldCIsIm9uRGlkRGVzdHJveSIsImRlbGV0ZSIsInJlbW92ZSIsIl92ZXJzaW9uIiwiX2VkaXRvciIsImNoYW5nZVRyYWNraW5nIiwic2V0dXBDaGFuZ2VUcmFja2luZyIsIm9uRGlkU2F2ZSIsImRpZFNhdmUiLCJkaWREZXN0cm95IiwiZGlkT3BlbiIsIkZ1bGwiLCJvbkRpZENoYW5nZSIsImVkaXRvckNoYW5nZVNlbmRGdWxsIiwiSW5jcmVtZW50YWwiLCJnZXRCdWZmZXIiLCJvbkRpZENoYW5nZVRleHQiLCJidWZmZXJDaGFuZ2VTZW5kSW5jcmVtZW50IiwiZ2V0TGFuZ3VhZ2VJZCIsImdldEdyYW1tYXIiLCJuYW1lIiwiZ2V0VmVyc2lvbmVkVGV4dERvY3VtZW50SWRlbnRpZmllciIsInVyaSIsImdldEVkaXRvclVyaSIsInZlcnNpb24iLCJkaWRPcGVuVGV4dERvY3VtZW50IiwidGV4dERvY3VtZW50IiwibGFuZ3VhZ2VJZCIsInRvTG93ZXJDYXNlIiwidGV4dCIsImdldFRleHQiLCJkaWRDaGFuZ2VUZXh0RG9jdW1lbnQiLCJjb250ZW50Q2hhbmdlcyIsImV2ZW50IiwiY2hhbmdlcyIsIm1hcCIsImNoYW5nZVRleHRUb0NvbnRlbnRDaGFuZ2UiLCJjaGFuZ2UiLCJzdGFydCIsInBvaW50VG9Qb3NpdGlvbiIsImVuZCIsImxpbmUiLCJyb3ciLCJvbGRFeHRlbnQiLCJjaGFyYWN0ZXIiLCJjb2x1bW4iLCJyYW5nZSIsInJhbmdlTGVuZ3RoIiwibmV3RXh0ZW50IiwibmV3VGV4dCIsImxlbmd0aCIsImRpZENsb3NlVGV4dERvY3VtZW50IiwiZGlkU2F2ZVRleHREb2N1bWVudCIsImRpZENoYW5nZVdhdGNoZWRGaWxlcyIsInR5cGUiLCJDaGFuZ2VkIiwicGF0aFRvVXJpIiwiZ2V0VVJJIl0sIm1hcHBpbmdzIjoiOzs7OztBQUVBOztBQUVBOzs7O0FBQ0E7Ozs7SUFFcUJBLGtCLEdBQU4sTUFBTUEsa0JBQU4sQ0FBeUI7O0FBTXRDQyxjQUFZQyxjQUFaLEVBQThDQyxnQkFBOUMsRUFBd0U7QUFBQSxTQUx4RUMsV0FLd0UsR0FMMUQsK0JBSzBEO0FBQUEsU0FIeEVDLFFBR3dFLEdBSGIsSUFBSUMsT0FBSixFQUdhOztBQUN0RSxTQUFLQyxHQUFMLEdBQVdMLGNBQVg7QUFDQSxTQUFLTSxpQkFBTCxHQUF5QkwsZ0JBQXpCO0FBQ0EsU0FBS0MsV0FBTCxDQUFpQkssR0FBakIsQ0FBcUJDLEtBQUtDLFdBQUwsQ0FBaUJDLE9BQWpCLENBQXlCLEtBQUtDLGtCQUFMLENBQXdCQyxJQUF4QixDQUE2QixJQUE3QixDQUF6QixDQUFyQjtBQUNEOztBQUVEQyxZQUFnQjtBQUNkLFNBQUtYLFdBQUwsQ0FBaUJXLE9BQWpCO0FBQ0Q7O0FBRURGLHFCQUFtQkcsTUFBbkIsRUFBa0Q7QUFDaEQsUUFBSSxDQUFDLEtBQUtYLFFBQUwsQ0FBY1ksR0FBZCxDQUFrQkQsTUFBbEIsQ0FBTCxFQUFnQztBQUM5QixZQUFNRSxPQUFPLElBQUlDLG9CQUFKLENBQXlCSCxNQUF6QixFQUFpQyxLQUFLVCxHQUF0QyxFQUEyQyxLQUFLQyxpQkFBaEQsQ0FBYjtBQUNBLFdBQUtILFFBQUwsQ0FBY2UsR0FBZCxDQUFrQkosTUFBbEIsRUFBMEJFLElBQTFCO0FBQ0EsV0FBS2QsV0FBTCxDQUFpQkssR0FBakIsQ0FBcUJTLElBQXJCO0FBQ0EsV0FB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ZSI6ImRvY3VtZW50LXN5bmMtYnJpZGdlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcclxuXHJcbmltcG9ydCB7TGFuZ3VhZ2VDbGllbnRWMiwgRmlsZUNoYW5nZVR5cGUsIFRleHREb2N1bWVudFN5bmNLaW5kfSBmcm9tICcuLi9wcm90b2NvbC9sYW5ndWFnZWNsaWVudC12Mic7XHJcbmltcG9ydCB0eXBlIHtUZXh0RG9jdW1lbnRDb250ZW50Q2hhbmdlRXZlbnQsIFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXJ9IGZyb20gJy4uL3Byb3RvY29sL2xhbmd1YWdlY2xpZW50LXYyJztcclxuaW1wb3J0IENvbnZlcnQgZnJvbSAnLi4vY29udmVydCc7XHJcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEb2N1bWVudFN5bmNCcmlkZ2Uge1xyXG4gIF9kaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcclxuICBfZG9jdW1lbnRTeW5jS2luZDogbnVtYmVyO1xyXG4gIF9lZGl0b3JzOiBXZWFrTWFwPGF0b20kVGV4dEVkaXRvciwgVGV4dEVkaXRvclN5bmNCcmlkZ2U+ID0gbmV3IFdlYWtNYXAoKTtcclxuICBfbGM6IExhbmd1YWdlQ2xpZW50VjI7XHJcblxyXG4gIGNvbnN0cnVjdG9yKGxhbmd1YWdlQ2xpZW50OiBMYW5ndWFnZUNsaWVudFYyLCBkb2N1bWVudFN5bmNLaW5kOiBudW1iZXIpIHtcclxuICAgIHRoaXMuX2xjID0gbGFuZ3VhZ2VDbGllbnQ7XHJcbiAgICB0aGlzLl9kb2N1bWVudFN5bmNLaW5kID0gZG9jdW1lbnRTeW5jS2luZDtcclxuICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKGF0b20udGV4dEVkaXRvcnMub2JzZXJ2ZSh0aGlzLm9ic2VydmVUZXh0RWRpdG9ycy5iaW5kKHRoaXMpKSk7XHJcbiAgfVxyXG5cclxuICBkaXNwb3NlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5fZGlzcG9zYWJsZS5kaXNwb3NlKCk7XHJcbiAgfVxyXG5cclxuICBvYnNlcnZlVGV4dEVkaXRvcnMoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy5fZWRpdG9ycy5oYXMoZWRpdG9yKSkge1xyXG4gICAgICBjb25zdCBzeW5jID0gbmV3IFRleHRFZGl0b3JTeW5jQnJpZGdlKGVkaXRvciwgdGhpcy5fbGMsIHRoaXMuX2RvY3VtZW50U3luY0tpbmQpO1xyXG4gICAgICB0aGlzLl9lZGl0b3JzLnNldChlZGl0b3IsIHN5bmMpO1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChzeW5jKTtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5fZWRpdG9ycy5kZWxldGUoZWRpdG9yKTtcclxuICAgICAgICB0aGlzLl9kaXNwb3NhYmxlLnJlbW92ZShzeW5jKTtcclxuICAgICAgICBzeW5jLmRpc3Bvc2UoKTtcclxuICAgICAgfSkpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuY2xhc3MgVGV4dEVkaXRvclN5bmNCcmlkZ2Uge1xyXG4gIF9kaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcclxuICBfZWRpdG9yOiBhdG9tJFRleHRFZGl0b3I7XHJcbiAgX2xjOiBMYW5ndWFnZUNsaWVudFYyO1xyXG4gIF92ZXJzaW9uID0gMTtcclxuXHJcbiAgY29uc3RydWN0b3IoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIGxhbmd1YWdlQ2xpZW50OiBMYW5ndWFnZUNsaWVudFYyLCBkb2N1bWVudFN5bmNLaW5kOiBudW1iZXIpIHtcclxuICAgIHRoaXMuX2VkaXRvciA9IGVkaXRvcjtcclxuICAgIHRoaXMuX2xjID0gbGFuZ3VhZ2VDbGllbnQ7XHJcblxyXG4gICAgY29uc3QgY2hhbmdlVHJhY2tpbmcgPSB0aGlzLnNldHVwQ2hhbmdlVHJhY2tpbmcoZG9jdW1lbnRTeW5jS2luZCk7XHJcbiAgICBpZiAoY2hhbmdlVHJhY2tpbmcgIT0gbnVsbCkge1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChjaGFuZ2VUcmFja2luZyk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoXHJcbiAgICAgIGVkaXRvci5vbkRpZFNhdmUodGhpcy5kaWRTYXZlLmJpbmQodGhpcykpLFxyXG4gICAgICBlZGl0b3Iub25EaWREZXN0cm95KHRoaXMuZGlkRGVzdHJveS5iaW5kKHRoaXMpKSxcclxuICAgICk7XHJcblxyXG4gICAgdGhpcy5kaWRPcGVuKCk7XHJcbiAgfVxyXG5cclxuICBzZXR1cENoYW5nZVRyYWNraW5nKGRvY3VtZW50U3luY0tpbmQ6IG51bWJlcik6ID9JRGlzcG9zYWJsZSB7XHJcbiAgICBzd2l0Y2ggKGRvY3VtZW50U3luY0tpbmQpIHtcclxuICAgICAgY2FzZSBUZXh0RG9jdW1lbnRTeW5jS2luZC5GdWxsOlxyXG4gICAgICAgIHJldHVybiB0aGlzLl9lZGl0b3Iub25EaWRDaGFuZ2UodGhpcy5lZGl0b3JDaGFuZ2VTZW5kRnVsbC5iaW5kKHRoaXMpKTtcclxuICAgICAgY2FzZSBUZXh0RG9jdW1lbnRTeW5jS2luZC5JbmNyZW1lbnRhbDpcclxuICAgICAgICByZXR1cm4gdGhpcy5fZWRpdG9yLmdldEJ1ZmZlcigpLm9uRGlkQ2hhbmdlVGV4dCh0aGlzLmJ1ZmZlckNoYW5nZVNlbmRJbmNyZW1lbnQuYmluZCh0aGlzKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIGdldExhbmd1YWdlSWQoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLl9lZGl0b3IuZ2V0R3JhbW1hcigpLm5hbWU7XHJcbiAgfVxyXG5cclxuICBnZXRWZXJzaW9uZWRUZXh0RG9jdW1lbnRJZGVudGlmaWVyKCk6IFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdXJpOiB0aGlzLmdldEVkaXRvclVyaSgpLFxyXG4gICAgICB2ZXJzaW9uOiB0aGlzLl92ZXJzaW9uXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgZGlkT3BlbigpOiB2b2lkIHtcclxuICAgIHRoaXMuX2xjLmRpZE9wZW5UZXh0RG9jdW1lbnQoe1xyXG4gICAgICB0ZXh0RG9jdW1lbnQ6IHtcclxuICAgICAgICB1cmk6IHRoaXMuZ2V0RWRpdG9yVXJpKCksXHJcbiAgICAgICAgbGFuZ3VhZ2VJZDogdGhpcy5nZXRMYW5ndWFnZUlkKCkudG9Mb3dlckNhc2UoKSxcclxuICAgICAgICB2ZXJzaW9uOiB0aGlzLl92ZXJzaW9uLFxyXG4gICAgICAgIHRleHQ6IHRoaXMuX2VkaXRvci5nZXRUZXh0KClcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBlZGl0b3JDaGFuZ2VTZW5kRnVsbCgpOiB2b2lkIHtcclxuICAgIHRoaXMuX3ZlcnNpb24rKztcclxuICAgIHRoaXMuX2xjLmRpZENoYW5nZVRleHREb2N1bWVudCh7XHJcbiAgICAgIHRleHREb2N1bWVudDogdGhpcy5nZXRWZXJzaW9uZWRUZXh0RG9jdW1lbnRJZGVudGlmaWVyKCksXHJcbiAgICAgIGNvbnRlbnRDaGFuZ2VzOiBbIHsgdGV4dDogdGhpcy5fZWRpdG9yLmdldFRleHQoKSB9IF1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgYnVmZmVyQ2hhbmdlU2VuZEluY3JlbWVudChldmVudDogYXRvbSRDaGFuZ2VUZXh0RXZlbnQpOiB2b2lkIHtcclxuICAgIHRoaXMuX3ZlcnNpb24rKztcclxuICAgIHRoaXMuX2xjLmRpZENoYW5nZVRleHREb2N1bWVudCh7XHJcbiAgICAgIHRleHREb2N1bWVudDogdGhpcy5nZXRWZXJzaW9uZWRUZXh0RG9jdW1lbnRJZGVudGlmaWVyKCksXHJcbiAgICAgIGNvbnRlbnRDaGFuZ2VzOiBldmVudC5jaGFuZ2VzLm1hcChUZXh0RWRpdG9yU3luY0JyaWRnZS5jaGFuZ2VUZXh0VG9Db250ZW50Q2hhbmdlKVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgY2hhbmdlVGV4dFRvQ29udGVudENoYW5nZShjaGFuZ2U6IGF0b20kQ2hhbmdlVGV4dCk6IFRleHREb2N1bWVudENvbnRlbnRDaGFuZ2VFdmVudCB7XHJcbiAgICBjb25zdCBzdGFydCA9IENvbnZlcnQucG9pbnRUb1Bvc2l0aW9uKGNoYW5nZS5zdGFydCk7XHJcbiAgICBjb25zdCBlbmQgPSB7IGxpbmU6IGNoYW5nZS5zdGFydC5yb3cgKyBjaGFuZ2Uub2xkRXh0ZW50LnJvdywgY2hhcmFjdGVyOiBjaGFuZ2Uuc3RhcnQuY29sdW1uICsgY2hhbmdlLm9sZEV4dGVudC5jb2x1bW4gfTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICByYW5nZTogeyBzdGFydDogc3RhcnQsIGVuZDogZW5kIH0sXHJcbiAgICAgIHJhbmdlTGVuZ3RoOiBjaGFuZ2Uub2xkRXh0ZW50LmNvbHVtbiAtIGNoYW5nZS5uZXdFeHRlbnQuY29sdW1uICsgY2hhbmdlLm5ld1RleHQubGVuZ3RoLCAvLyBUT0RPOiBPbmx5IHdvcmtzIGlmIHJvdyBpcyB0aGUgc2FtZS4uLlxyXG4gICAgICB0ZXh0OiBjaGFuZ2UubmV3VGV4dFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGRpZERlc3Ryb3koKTogdm9pZCB7XHJcbiAgICB0aGlzLl9sYy5kaWRDbG9zZVRleHREb2N1bWVudCh7IHRleHREb2N1bWVudDogeyB1cmk6IHRoaXMuZ2V0RWRpdG9yVXJpKCkgfSB9KTtcclxuICB9XHJcblxyXG4gIGRpZFNhdmUoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9sYy5kaWRTYXZlVGV4dERvY3VtZW50KHsgdGV4dERvY3VtZW50OiB7IHVyaTogdGhpcy5nZXRFZGl0b3JVcmkoKSB9IH0pO1xyXG4gICAgdGhpcy5fbGMuZGlkQ2hhbmdlV2F0Y2hlZEZpbGVzKHsgY2hhbmdlczogWyB7IHVyaTogdGhpcy5nZXRFZGl0b3JVcmkoKSwgdHlwZTogRmlsZUNoYW5nZVR5cGUuQ2hhbmdlZCB9IF19KTtcclxuICB9XHJcblxyXG4gIGdldEVkaXRvclVyaSgpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIENvbnZlcnQucGF0aFRvVXJpKHRoaXMuX2VkaXRvci5nZXRVUkkoKSB8fCAnJyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==