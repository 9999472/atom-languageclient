Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _languageclientV = require('../protocol/languageclient-v2');

var ls = _interopRequireWildcard(_languageclientV);

var _convert = require('../convert');

var _convert2 = _interopRequireDefault(_convert);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

let DocumentSyncBridge = class DocumentSyncBridge {

  constructor(languageClient, documentSyncKind) {
    this._editors = new WeakMap();

    this._disposable = new _atom.CompositeDisposable();
    this._lc = languageClient;
    this._documentSyncKind = documentSyncKind;
    this._disposable.add(atom.textEditors.observe(this._observeTextEditors.bind(this)));
  }

  dispose() {
    this._disposable.dispose();
  }

  _observeTextEditors(editor) {
    if (!this._editors.has(editor)) {
      const sync = new TextEditorSyncBridge(editor, this._lc, this._documentSyncKind);
      this._editors.set(editor, sync);
      this._disposable.add(sync);
      this._disposable.add(editor.onDidDestroy(() => {
        this._editors.delete(editor);
        this._disposable.remove(sync);
        sync.dispose();
      }));
    }
  }
};
exports.default = DocumentSyncBridge;
let TextEditorSyncBridge = class TextEditorSyncBridge {

  constructor(editor, languageClient, documentSyncKind) {
    this._disposable = new _atom.CompositeDisposable();
    this._version = 1;

    this._editor = editor;
    this._lc = languageClient;

    const changeTracking = this._setupChangeTracking(documentSyncKind);
    if (changeTracking != null) {
      this._disposable.add(changeTracking);
    }

    this._disposable.add(editor.onDidSave(this._didSave.bind(this)), editor.onDidDestroy(this._didDestroy.bind(this)));

    this._didOpen();
  }

  _setupChangeTracking(documentSyncKind) {
    switch (documentSyncKind) {
      case ls.TextDocumentSyncKind.Full:
        return this._editor.onDidChange(this._editorChangeSendFull.bind(this));
      case ls.TextDocumentSyncKind.Incremental:
        return this._editor.getBuffer().onDidChangeText(this._bufferChangeSendIncrement.bind(this));
    }
    return null;
  }

  dispose() {
    this._disposable.dispose();
  }

  _getLanguageId() {
    return this._editor.getGrammar().name;
  }

  _getVersionedTextDocumentIdentifier() {
    return {
      uri: this._getEditorUri(),
      version: this._version
    };
  }

  _didOpen() {
    this._lc.didOpenTextDocument({
      textDocument: {
        uri: this._getEditorUri(),
        languageId: this._getLanguageId().toLowerCase(),
        version: this._version,
        text: this._editor.getText()
      }
    });
  }

  _editorChangeSendFull() {
    this._version++;
    this._lc.didChangeTextDocument({
      textDocument: this._getVersionedTextDocumentIdentifier(),
      contentChanges: [{ text: this._editor.getText() }]
    });
  }

  _bufferChangeSendIncrement(event) {
    this._version++;
    this._lc.didChangeTextDocument({
      textDocument: this._getVersionedTextDocumentIdentifier(),
      contentChanges: event.changes.map(TextEditorSyncBridge._changeTextToContentChange)
    });
  }

  static _changeTextToContentChange(change) {
    const start = _convert2.default.pointToPosition(change.start);
    const end = { line: change.start.row + change.oldExtent.row, character: change.start.column + change.oldExtent.column };

    return {
      range: {
        start: start,
        end: end
      },
      rangeLength: change.oldExtent.column - change.newExtent.column + change.newText.length, // TODO: Only works if row is the same...
      text: change.newText
    };
  }

  _didDestroy() {
    this._lc.didCloseTextDocument({
      textDocument: {
        uri: this._getEditorUri()
      }
    });
  }

  _didSave() {
    this._lc.didSaveTextDocument({ textDocument: { uri: this._getEditorUri() } });
    this._lc.didChangeWatchedFiles({ changes: [{ uri: this._getEditorUri(), type: ls.FileChangeType.Changed }] });
  }

  _getEditorUri() {
    return _convert2.default.pathToUri(this._editor.getURI() || '');
  }
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9icmlkZ2VzL2RvY3VtZW50LXN5bmMtYnJpZGdlLmpzIl0sIm5hbWVzIjpbImxzIiwiRG9jdW1lbnRTeW5jQnJpZGdlIiwiY29uc3RydWN0b3IiLCJsYW5ndWFnZUNsaWVudCIsImRvY3VtZW50U3luY0tpbmQiLCJfZWRpdG9ycyIsIldlYWtNYXAiLCJfZGlzcG9zYWJsZSIsIl9sYyIsIl9kb2N1bWVudFN5bmNLaW5kIiwiYWRkIiwiYXRvbSIsInRleHRFZGl0b3JzIiwib2JzZXJ2ZSIsIl9vYnNlcnZlVGV4dEVkaXRvcnMiLCJiaW5kIiwiZGlzcG9zZSIsImVkaXRvciIsImhhcyIsInN5bmMiLCJUZXh0RWRpdG9yU3luY0JyaWRnZSIsInNldCIsIm9uRGlkRGVzdHJveSIsImRlbGV0ZSIsInJlbW92ZSIsIl92ZXJzaW9uIiwiX2VkaXRvciIsImNoYW5nZVRyYWNraW5nIiwiX3NldHVwQ2hhbmdlVHJhY2tpbmciLCJvbkRpZFNhdmUiLCJfZGlkU2F2ZSIsIl9kaWREZXN0cm95IiwiX2RpZE9wZW4iLCJUZXh0RG9jdW1lbnRTeW5jS2luZCIsIkZ1bGwiLCJvbkRpZENoYW5nZSIsIl9lZGl0b3JDaGFuZ2VTZW5kRnVsbCIsIkluY3JlbWVudGFsIiwiZ2V0QnVmZmVyIiwib25EaWRDaGFuZ2VUZXh0IiwiX2J1ZmZlckNoYW5nZVNlbmRJbmNyZW1lbnQiLCJfZ2V0TGFuZ3VhZ2VJZCIsImdldEdyYW1tYXIiLCJuYW1lIiwiX2dldFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIiLCJ1cmkiLCJfZ2V0RWRpdG9yVXJpIiwidmVyc2lvbiIsImRpZE9wZW5UZXh0RG9jdW1lbnQiLCJ0ZXh0RG9jdW1lbnQiLCJsYW5ndWFnZUlkIiwidG9Mb3dlckNhc2UiLCJ0ZXh0IiwiZ2V0VGV4dCIsImRpZENoYW5nZVRleHREb2N1bWVudCIsImNvbnRlbnRDaGFuZ2VzIiwiZXZlbnQiLCJjaGFuZ2VzIiwibWFwIiwiX2NoYW5nZVRleHRUb0NvbnRlbnRDaGFuZ2UiLCJjaGFuZ2UiLCJzdGFydCIsInBvaW50VG9Qb3NpdGlvbiIsImVuZCIsImxpbmUiLCJyb3ciLCJvbGRFeHRlbnQiLCJjaGFyYWN0ZXIiLCJjb2x1bW4iLCJyYW5nZSIsInJhbmdlTGVuZ3RoIiwibmV3RXh0ZW50IiwibmV3VGV4dCIsImxlbmd0aCIsImRpZENsb3NlVGV4dERvY3VtZW50IiwiZGlkU2F2ZVRleHREb2N1bWVudCIsImRpZENoYW5nZVdhdGNoZWRGaWxlcyIsInR5cGUiLCJGaWxlQ2hhbmdlVHlwZSIsIkNoYW5nZWQiLCJwYXRoVG9VcmkiLCJnZXRVUkkiXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7O0lBQVlBLEU7O0FBQ1o7Ozs7QUFDQTs7Ozs7O0lBRXFCQyxrQixHQUFOLE1BQU1BLGtCQUFOLENBQ2Y7O0FBTUVDLGNBQVlDLGNBQVosRUFBaURDLGdCQUFqRCxFQUEyRTtBQUFBLFNBRjNFQyxRQUUyRSxHQUZoQixJQUFJQyxPQUFKLEVBRWdCOztBQUN6RSxTQUFLQyxXQUFMLEdBQW1CLCtCQUFuQjtBQUNBLFNBQUtDLEdBQUwsR0FBV0wsY0FBWDtBQUNBLFNBQUtNLGlCQUFMLEdBQXlCTCxnQkFBekI7QUFDQSxTQUFLRyxXQUFMLENBQWlCRyxHQUFqQixDQUFxQkMsS0FBS0MsV0FBTCxDQUFpQkMsT0FBakIsQ0FBeUIsS0FBS0MsbUJBQUwsQ0FBeUJDLElBQXpCLENBQThCLElBQTlCLENBQXpCLENBQXJCO0FBQ0Q7O0FBRURDLFlBQWdCO0FBQ2QsU0FBS1QsV0FBTCxDQUFpQlMsT0FBakI7QUFDRDs7QUFFREYsc0JBQW9CRyxNQUFwQixFQUFtRDtBQUNqRCxRQUFJLENBQUMsS0FBS1osUUFBTCxDQUFjYSxHQUFkLENBQWtCRCxNQUFsQixDQUFMLEVBQWdDO0FBQzlCLFlBQU1FLE9BQU8sSUFBSUMsb0JBQUosQ0FBeUJILE1BQXpCLEVBQWlDLEtBQUtULEdBQXRDLEVBQTJDLEtBQUtDLGlCQUFoRCxDQUFiO0FBQ0EsV0FBS0osUUFBTCxDQUFjZ0IsR0FBZCxDQUFrQkosTUFB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QUVEakMsa0JBQXdCO0FBQ3RCLFdBQU8sa0JBQVFrQyxTQUFSLENBQWtCLEtBQUt0RCxPQUFMLENBQWF1RCxNQUFiLE1BQXlCLEVBQTNDLENBQVA7QUFDRDtBQXhHSCxDIiwiZmlsZSI6ImRvY3VtZW50LXN5bmMtYnJpZGdlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcclxuXHJcbmltcG9ydCAqIGFzIGxzIGZyb20gJy4uL3Byb3RvY29sL2xhbmd1YWdlY2xpZW50LXYyJztcclxuaW1wb3J0IENvbnZlcnQgZnJvbSAnLi4vY29udmVydCc7XHJcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEb2N1bWVudFN5bmNCcmlkZ2Vcclxue1xyXG4gIF9kb2N1bWVudFN5bmNLaW5kOiBudW1iZXI7XHJcbiAgX2Rpc3Bvc2FibGU6IENvbXBvc2l0ZURpc3Bvc2FibGU7XHJcbiAgX2xjOiBscy5MYW5ndWFnZUNsaWVudFYyO1xyXG4gIF9lZGl0b3JzOiBXZWFrTWFwPGF0b20kVGV4dEVkaXRvciwgVGV4dEVkaXRvclN5bmNCcmlkZ2U+ID0gbmV3IFdlYWtNYXAoKTtcclxuXHJcbiAgY29uc3RydWN0b3IobGFuZ3VhZ2VDbGllbnQ6IGxzLkxhbmd1YWdlQ2xpZW50VjIsIGRvY3VtZW50U3luY0tpbmQ6IG51bWJlcikge1xyXG4gICAgdGhpcy5fZGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XHJcbiAgICB0aGlzLl9sYyA9IGxhbmd1YWdlQ2xpZW50O1xyXG4gICAgdGhpcy5fZG9jdW1lbnRTeW5jS2luZCA9IGRvY3VtZW50U3luY0tpbmQ7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChhdG9tLnRleHRFZGl0b3JzLm9ic2VydmUodGhpcy5fb2JzZXJ2ZVRleHRFZGl0b3JzLmJpbmQodGhpcykpKTtcclxuICB9XHJcblxyXG4gIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIF9vYnNlcnZlVGV4dEVkaXRvcnMoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy5fZWRpdG9ycy5oYXMoZWRpdG9yKSkge1xyXG4gICAgICBjb25zdCBzeW5jID0gbmV3IFRleHRFZGl0b3JTeW5jQnJpZGdlKGVkaXRvciwgdGhpcy5fbGMsIHRoaXMuX2RvY3VtZW50U3luY0tpbmQpO1xyXG4gICAgICB0aGlzLl9lZGl0b3JzLnNldChlZGl0b3IsIHN5bmMpO1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChzeW5jKTtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5fZWRpdG9ycy5kZWxldGUoZWRpdG9yKTtcclxuICAgICAgICB0aGlzLl9kaXNwb3NhYmxlLnJlbW92ZShzeW5jKTtcclxuICAgICAgICBzeW5jLmRpc3Bvc2UoKTtcclxuICAgICAgfSkpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuY2xhc3MgVGV4dEVkaXRvclN5bmNCcmlkZ2Vcclxue1xyXG4gIF9kaXNwb3NhYmxlOiBDb21wb3NpdGVEaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcclxuICBfZWRpdG9yOiBhdG9tJFRleHRFZGl0b3I7XHJcbiAgX2xjOiBscy5MYW5ndWFnZUNsaWVudFYyO1xyXG4gIF92ZXJzaW9uOiBudW1iZXIgPSAxO1xyXG5cclxuICBjb25zdHJ1Y3RvcihlZGl0b3I6IGF0b20kVGV4dEVkaXRvciwgbGFuZ3VhZ2VDbGllbnQ6IGxzLkxhbmd1YWdlQ2xpZW50VjIsIGRvY3VtZW50U3luY0tpbmQ6IG51bWJlcikge1xyXG4gICAgdGhpcy5fZWRpdG9yID0gZWRpdG9yO1xyXG4gICAgdGhpcy5fbGMgPSBsYW5ndWFnZUNsaWVudDtcclxuXHJcbiAgICBjb25zdCBjaGFuZ2VUcmFja2luZyA9IHRoaXMuX3NldHVwQ2hhbmdlVHJhY2tpbmcoZG9jdW1lbnRTeW5jS2luZCk7XHJcbiAgICBpZiAoY2hhbmdlVHJhY2tpbmcgIT0gbnVsbCkge1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChjaGFuZ2VUcmFja2luZyk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoXHJcbiAgICAgIGVkaXRvci5vbkRpZFNhdmUodGhpcy5fZGlkU2F2ZS5iaW5kKHRoaXMpKSxcclxuICAgICAgZWRpdG9yLm9uRGlkRGVzdHJveSh0aGlzLl9kaWREZXN0cm95LmJpbmQodGhpcykpLFxyXG4gICAgKTtcclxuXHJcbiAgICB0aGlzLl9kaWRPcGVuKCk7XHJcbiAgfVxyXG5cclxuICBfc2V0dXBDaGFuZ2VUcmFja2luZyhkb2N1bWVudFN5bmNLaW5kOiBudW1iZXIpOiA/SURpc3Bvc2FibGUge1xyXG4gICAgc3dpdGNoKGRvY3VtZW50U3luY0tpbmQpIHtcclxuICAgICAgY2FzZSBscy5UZXh0RG9jdW1lbnRTeW5jS2luZC5GdWxsOlxyXG4gICAgICAgIHJldHVybiB0aGlzLl9lZGl0b3Iub25EaWRDaGFuZ2UodGhpcy5fZWRpdG9yQ2hhbmdlU2VuZEZ1bGwuYmluZCh0aGlzKSk7XHJcbiAgICAgIGNhc2UgbHMuVGV4dERvY3VtZW50U3luY0tpbmQuSW5jcmVtZW50YWw6XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VkaXRvci5nZXRCdWZmZXIoKS5vbkRpZENoYW5nZVRleHQodGhpcy5fYnVmZmVyQ2hhbmdlU2VuZEluY3JlbWVudC5iaW5kKHRoaXMpKTtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuX2Rpc3Bvc2FibGUuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgX2dldExhbmd1YWdlSWQoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLl9lZGl0b3IuZ2V0R3JhbW1hcigpLm5hbWU7XHJcbiAgfVxyXG5cclxuICBfZ2V0VmVyc2lvbmVkVGV4dERvY3VtZW50SWRlbnRpZmllcigpOiBscy5WZXJzaW9uZWRUZXh0RG9jdW1lbnRJZGVudGlmaWVyIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHVyaTogdGhpcy5fZ2V0RWRpdG9yVXJpKCksXHJcbiAgICAgIHZlcnNpb246IHRoaXMuX3ZlcnNpb25cclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBfZGlkT3BlbigpOiB2b2lkIHtcclxuICAgIHRoaXMuX2xjLmRpZE9wZW5UZXh0RG9jdW1lbnQoe1xyXG4gICAgICB0ZXh0RG9jdW1lbnQ6IHtcclxuICAgICAgICB1cmk6IHRoaXMuX2dldEVkaXRvclVyaSgpLFxyXG4gICAgICAgIGxhbmd1YWdlSWQ6IHRoaXMuX2dldExhbmd1YWdlSWQoKS50b0xvd2VyQ2FzZSgpLFxyXG4gICAgICAgIHZlcnNpb246IHRoaXMuX3ZlcnNpb24sXHJcbiAgICAgICAgdGV4dDogdGhpcy5fZWRpdG9yLmdldFRleHQoKVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIF9lZGl0b3JDaGFuZ2VTZW5kRnVsbCgpOiB2b2lkIHtcclxuICAgIHRoaXMuX3ZlcnNpb24rKztcclxuICAgIHRoaXMuX2xjLmRpZENoYW5nZVRleHREb2N1bWVudCh7XHJcbiAgICAgIHRleHREb2N1bWVudDogdGhpcy5fZ2V0VmVyc2lvbmVkVGV4dERvY3VtZW50SWRlbnRpZmllcigpLFxyXG4gICAgICBjb250ZW50Q2hhbmdlczogWyB7IHRleHQ6IHRoaXMuX2VkaXRvci5nZXRUZXh0KCkgfSBdXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIF9idWZmZXJDaGFuZ2VTZW5kSW5jcmVtZW50KGV2ZW50OiBhdG9tJENoYW5nZVRleHRFdmVudCk6IHZvaWQge1xyXG4gICAgdGhpcy5fdmVyc2lvbisrO1xyXG4gICAgdGhpcy5fbGMuZGlkQ2hhbmdlVGV4dERvY3VtZW50KHtcclxuICAgICAgdGV4dERvY3VtZW50OiB0aGlzLl9nZXRWZXJzaW9uZWRUZXh0RG9jdW1lbnRJZGVudGlmaWVyKCksXHJcbiAgICAgIGNvbnRlbnRDaGFuZ2VzOiBldmVudC5jaGFuZ2VzLm1hcChUZXh0RWRpdG9yU3luY0JyaWRnZS5fY2hhbmdlVGV4dFRvQ29udGVudENoYW5nZSlcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIF9jaGFuZ2VUZXh0VG9Db250ZW50Q2hhbmdlKGNoYW5nZTogYXRvbSRDaGFuZ2VUZXh0KTogbHMuVGV4dERvY3VtZW50Q29udGVudENoYW5nZUV2ZW50IHtcclxuICAgIGNvbnN0IHN0YXJ0ID0gQ29udmVydC5wb2ludFRvUG9zaXRpb24oY2hhbmdlLnN0YXJ0KTtcclxuICAgIGNvbnN0IGVuZCA9IHsgbGluZTogY2hhbmdlLnN0YXJ0LnJvdyArIGNoYW5nZS5vbGRFeHRlbnQucm93LCBjaGFyYWN0ZXI6IGNoYW5nZS5zdGFydC5jb2x1bW4gKyBjaGFuZ2Uub2xkRXh0ZW50LmNvbHVtbiB9O1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIHJhbmdlOiB7XHJcbiAgICAgICAgc3RhcnQ6IHN0YXJ0LFxyXG4gICAgICAgIGVuZDogZW5kLFxyXG4gICAgICB9LFxyXG4gICAgICByYW5nZUxlbmd0aDogY2hhbmdlLm9sZEV4dGVudC5jb2x1bW4gLSBjaGFuZ2UubmV3RXh0ZW50LmNvbHVtbiArIGNoYW5nZS5uZXdUZXh0Lmxlbmd0aCwgLy8gVE9ETzogT25seSB3b3JrcyBpZiByb3cgaXMgdGhlIHNhbWUuLi5cclxuICAgICAgdGV4dDogY2hhbmdlLm5ld1RleHRcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBfZGlkRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMuX2xjLmRpZENsb3NlVGV4dERvY3VtZW50KHtcclxuICAgICAgdGV4dERvY3VtZW50OiB7XHJcbiAgICAgICAgdXJpOiB0aGlzLl9nZXRFZGl0b3JVcmkoKVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIF9kaWRTYXZlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5fbGMuZGlkU2F2ZVRleHREb2N1bWVudCh7IHRleHREb2N1bWVudDogeyB1cmk6IHRoaXMuX2dldEVkaXRvclVyaSgpIH0gfSk7XHJcbiAgICB0aGlzLl9sYy5kaWRDaGFuZ2VXYXRjaGVkRmlsZXMoeyBjaGFuZ2VzOiBbIHsgdXJpOiB0aGlzLl9nZXRFZGl0b3JVcmkoKSwgdHlwZTogbHMuRmlsZUNoYW5nZVR5cGUuQ2hhbmdlZCB9IF19KTtcclxuICB9XHJcblxyXG4gIF9nZXRFZGl0b3JVcmkoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBDb252ZXJ0LnBhdGhUb1VyaSh0aGlzLl9lZGl0b3IuZ2V0VVJJKCkgfHwgJycpO1xyXG4gIH1cclxufVxyXG4iXX0=